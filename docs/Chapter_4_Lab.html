<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.306">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="phonchi">
<meta name="dcterms.date" content="2022-09-26">

<title>Statistical Learning and Data Mining - 4&nbsp; Classification</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Chapter_5_Lab.html" rel="next">
<link href="./Chapter_3_Lab.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter_4_Lab.html"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Classification</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistical Learning and Data Mining</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter1_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter 2_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_3_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_4_Lab.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_5_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_6_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Linear Models and Regularization Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_7_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-linear Modeling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_8_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Decision Trees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_9_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Support Vector Machines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_12_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Unsupervised Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./NumPy_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Numpy - multidimensional data arrays for python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Colab_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Introduction to Colab</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kaggle-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Introduction to Kaggle</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#the-stock-market-data" id="toc-the-stock-market-data" class="nav-link active" data-scroll-target="#the-stock-market-data"><span class="header-section-number">4.1</span> The Stock Market Data</a></li>
  <li><a href="#logistic-regression" id="toc-logistic-regression" class="nav-link" data-scroll-target="#logistic-regression"><span class="header-section-number">4.2</span> Logistic Regression</a></li>
  <li><a href="#linear-discriminant-analysis" id="toc-linear-discriminant-analysis" class="nav-link" data-scroll-target="#linear-discriminant-analysis"><span class="header-section-number">4.3</span> Linear Discriminant Analysis</a></li>
  <li><a href="#quadratic-discriminant-analysis" id="toc-quadratic-discriminant-analysis" class="nav-link" data-scroll-target="#quadratic-discriminant-analysis"><span class="header-section-number">4.4</span> Quadratic Discriminant Analysis</a></li>
  <li><a href="#naive-bayes" id="toc-naive-bayes" class="nav-link" data-scroll-target="#naive-bayes"><span class="header-section-number">4.5</span> Naive Bayes</a></li>
  <li><a href="#k-nearest-neighbors" id="toc-k-nearest-neighbors" class="nav-link" data-scroll-target="#k-nearest-neighbors"><span class="header-section-number">4.6</span> <span class="math inline">\(K\)</span>-Nearest Neighbors</a></li>
  <li><a href="#poisson-regression" id="toc-poisson-regression" class="nav-link" data-scroll-target="#poisson-regression"><span class="header-section-number">4.7</span> Poisson Regression</a></li>
  <li><a href="#logistic-regression-in-sklearn" id="toc-logistic-regression-in-sklearn" class="nav-link" data-scroll-target="#logistic-regression-in-sklearn"><span class="header-section-number">4.8</span> Logistic regression in Sklearn</a></li>
  <li><a href="#optional" id="toc-optional" class="nav-link" data-scroll-target="#optional"><span class="header-section-number">4.9</span> Optional</a>
  <ul class="collapse">
  <li><a href="#poisson-regression-with-sklearn-and-column-transform" id="toc-poisson-regression-with-sklearn-and-column-transform" class="nav-link" data-scroll-target="#poisson-regression-with-sklearn-and-column-transform"><span class="header-section-number">4.9.1</span> Poisson regression with sklearn and column transform</a></li>
  <li><a href="#yellowbrics-plot" id="toc-yellowbrics-plot" class="nav-link" data-scroll-target="#yellowbrics-plot"><span class="header-section-number">4.9.2</span> Yellowbric’s plot</a></li>
  </ul></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Classification</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>phonchi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 26, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>


<table align="left">
<tbody><tr><td>
<a href="https://colab.research.google.com/github/phonchi/nsysu-math524/blob/master/static_files/presentations/Chapter_4_Lab.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a>
</td>
<td>
<a target="_blank" href="https://kaggle.com/kernels/welcome?src=https://github.com/phonchi/nsysu-math524/blob/master/static_files/presentations/Chapter_4_Lab.ipynb"><img src="https://kaggle.com/static/images/open-in-kaggle.svg"></a>
</td>

</tr></tbody></table>
<p><br></p>
<section id="the-stock-market-data" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="the-stock-market-data"><span class="header-section-number">4.1</span> The Stock Market Data</h2>
<p>We will begin by examining some numerical and graphical summaries of the <code>Smarket</code> data, which is part of the <code>ISLR2</code> library. This data set consists of percentage returns for the S&amp;P 500 stock index over <span class="math inline">\(1,250\)</span>~days, from the beginning of 2001 until the end of 2005. For each date, we have recorded the percentage returns for each of the five previous trading days, <code>lagone</code> through <code>lagfive</code>. We have also recorded <code>volume</code> (the number of shares traded on the previous day, in billions), <code>Today</code> (the percentage return on the date in question) and <code>direction</code> (whether the market was <code>Up</code> or <code>Down</code> on this date). Our goal is to predict <code>direction</code> (a qualitative response) using the other features.</p>
<div class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb1-3"><a href="#cb1-3"></a></span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="im">import</span> statsmodels.api <span class="im">as</span> sm</span>
<span id="cb1-5"><a href="#cb1-5"></a><span class="im">import</span> statsmodels.formula.api <span class="im">as</span> smf</span>
<span id="cb1-6"><a href="#cb1-6"></a></span>
<span id="cb1-7"><a href="#cb1-7"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb1-8"><a href="#cb1-8"></a><span class="im">from</span> sklearn.discriminant_analysis <span class="im">import</span> LinearDiscriminantAnalysis <span class="im">as</span> LDA</span>
<span id="cb1-9"><a href="#cb1-9"></a><span class="im">from</span> sklearn.discriminant_analysis <span class="im">import</span> QuadraticDiscriminantAnalysis <span class="im">as</span> QDA</span>
<span id="cb1-10"><a href="#cb1-10"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> GaussianNB</span>
<span id="cb1-11"><a href="#cb1-11"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb1-12"><a href="#cb1-12"></a></span>
<span id="cb1-13"><a href="#cb1-13"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler, scale</span>
<span id="cb1-14"><a href="#cb1-14"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score, confusion_matrix, ConfusionMatrixDisplay, classification_report,<span class="op">\</span></span>
<span id="cb1-15"><a href="#cb1-15"></a>  roc_curve, auc, RocCurveDisplay</span>
<span id="cb1-16"><a href="#cb1-16"></a></span>
<span id="cb1-17"><a href="#cb1-17"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb1-18"><a href="#cb1-18"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb1-19"><a href="#cb1-19"></a></span>
<span id="cb1-20"><a href="#cb1-20"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb1-21"><a href="#cb1-21"></a>plt.style.use(<span class="st">'seaborn-white'</span>)</span>
<span id="cb1-22"><a href="#cb1-22"></a>sns.set_context(<span class="st">"notebook"</span>, font_scale<span class="op">=</span><span class="fl">1.5</span>, rc<span class="op">=</span>{<span class="st">"lines.linewidth"</span>: <span class="fl">2.5</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="a550801d-0ac8-448d-8445-0309cbd3b344" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb2-2"><a href="#cb2-2"></a>drive.mount(<span class="st">'/content/drive'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive</code></pre>
</div>
</div>
<div class="cell" data-outputid="a9753fd8-5f52-4b52-affe-7d9432b252d2" data-execution_count="3">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1"></a>Smarket <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Smarket.csv'</span>)</span>
<span id="cb4-2"><a href="#cb4-2"></a><span class="bu">print</span>(Smarket.shape)</span>
<span id="cb4-3"><a href="#cb4-3"></a>Smarket.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(1250, 9)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="3">

  <div id="df-ef2c320c-2c3a-4ee7-9091-825afda389bc">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Lag1</th>
<th data-quarto-table-cell-role="th">Lag2</th>
<th data-quarto-table-cell-role="th">Lag3</th>
<th data-quarto-table-cell-role="th">Lag4</th>
<th data-quarto-table-cell-role="th">Lag5</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Today</th>
<th data-quarto-table-cell-role="th">Direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2001</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>5.010</td>
<td>1.1913</td>
<td>0.959</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2001</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>1.2965</td>
<td>1.032</td>
<td>Up</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2001</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>1.4112</td>
<td>-0.623</td>
<td>Down</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2001</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>1.2760</td>
<td>0.614</td>
<td>Up</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2001</td>
<td>0.614</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>1.2057</td>
<td>0.213</td>
<td>Up</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-ef2c320c-2c3a-4ee7-9091-825afda389bc')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-ef2c320c-2c3a-4ee7-9091-825afda389bc button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-ef2c320c-2c3a-4ee7-9091-825afda389bc');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="47340f86-62c6-4df5-d4b1-d4e9e88ab1c8" data-execution_count="4">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a>Smarket.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="4">
<pre><code>Index(['Year', 'Lag1', 'Lag2', 'Lag3', 'Lag4', 'Lag5', 'Volume', 'Today',
       'Direction'],
      dtype='object')</code></pre>
</div>
</div>
<div class="cell" data-outputid="03c85725-9448-4826-b202-8f64168cb499" data-execution_count="5">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1"></a>Smarket.describe(include<span class="op">=</span><span class="st">'all'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="5">

  <div id="df-0ac1e7b7-8c46-4687-b063-44de97f46893">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Lag1</th>
<th data-quarto-table-cell-role="th">Lag2</th>
<th data-quarto-table-cell-role="th">Lag3</th>
<th data-quarto-table-cell-role="th">Lag4</th>
<th data-quarto-table-cell-role="th">Lag5</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Today</th>
<th data-quarto-table-cell-role="th">Direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>1250.000000</td>
<td>1250.000000</td>
<td>1250.000000</td>
<td>1250.000000</td>
<td>1250.000000</td>
<td>1250.00000</td>
<td>1250.000000</td>
<td>1250.000000</td>
<td>1250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">unique</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>2</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">top</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">freq</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>NaN</td>
<td>648</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">mean</td>
<td>2003.016000</td>
<td>0.003834</td>
<td>0.003919</td>
<td>0.001716</td>
<td>0.001636</td>
<td>0.00561</td>
<td>1.478305</td>
<td>0.003138</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">std</td>
<td>1.409018</td>
<td>1.136299</td>
<td>1.136280</td>
<td>1.138703</td>
<td>1.138774</td>
<td>1.14755</td>
<td>0.360357</td>
<td>1.136334</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">min</td>
<td>2001.000000</td>
<td>-4.922000</td>
<td>-4.922000</td>
<td>-4.922000</td>
<td>-4.922000</td>
<td>-4.92200</td>
<td>0.356070</td>
<td>-4.922000</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">25%</td>
<td>2002.000000</td>
<td>-0.639500</td>
<td>-0.639500</td>
<td>-0.640000</td>
<td>-0.640000</td>
<td>-0.64000</td>
<td>1.257400</td>
<td>-0.639500</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">50%</td>
<td>2003.000000</td>
<td>0.039000</td>
<td>0.039000</td>
<td>0.038500</td>
<td>0.038500</td>
<td>0.03850</td>
<td>1.422950</td>
<td>0.038500</td>
<td>NaN</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">75%</td>
<td>2004.000000</td>
<td>0.596750</td>
<td>0.596750</td>
<td>0.596750</td>
<td>0.596750</td>
<td>0.59700</td>
<td>1.641675</td>
<td>0.596750</td>
<td>NaN</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">max</td>
<td>2005.000000</td>
<td>5.733000</td>
<td>5.733000</td>
<td>5.733000</td>
<td>5.733000</td>
<td>5.73300</td>
<td>3.152470</td>
<td>5.733000</td>
<td>NaN</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-0ac1e7b7-8c46-4687-b063-44de97f46893')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-0ac1e7b7-8c46-4687-b063-44de97f46893 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-0ac1e7b7-8c46-4687-b063-44de97f46893');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="a4bc625b-44c1-47f6-dc3b-749053027504" data-execution_count="6">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>Smarket.info(memory_usage<span class="op">=</span><span class="st">'deep'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 1250 entries, 0 to 1249
Data columns (total 9 columns):
 #   Column     Non-Null Count  Dtype  
---  ------     --------------  -----  
 0   Year       1250 non-null   int64  
 1   Lag1       1250 non-null   float64
 2   Lag2       1250 non-null   float64
 3   Lag3       1250 non-null   float64
 4   Lag4       1250 non-null   float64
 5   Lag5       1250 non-null   float64
 6   Volume     1250 non-null   float64
 7   Today      1250 non-null   float64
 8   Direction  1250 non-null   object 
dtypes: float64(7), int64(1), object(1)
memory usage: 151.4 KB</code></pre>
</div>
</div>
<div class="cell" data-outputid="eda77d19-5356-466e-db92-5f71e74689fd" data-execution_count="7">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>sns.pairplot(data<span class="op">=</span>Smarket, hue<span class="op">=</span><span class="st">'Direction'</span>, diag_kind<span class="op">=</span><span class="st">'hist'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-8-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The <code>corr()</code> function produces a matrix that contains all of the pairwise correlations among the predictors in a data set.</p>
<div class="cell" data-outputid="54483385-727c-4cd8-f702-b1dbb1a9ac03" data-execution_count="8">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a><span class="co">#produces a correlation matrix for all the numrical columns </span></span>
<span id="cb12-2"><a href="#cb12-2"></a>corr <span class="op">=</span> Smarket.corr()</span>
<span id="cb12-3"><a href="#cb12-3"></a>corr</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="8">

  <div id="df-e10d072b-90a3-438c-9546-487e88c354fa">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Lag1</th>
<th data-quarto-table-cell-role="th">Lag2</th>
<th data-quarto-table-cell-role="th">Lag3</th>
<th data-quarto-table-cell-role="th">Lag4</th>
<th data-quarto-table-cell-role="th">Lag5</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Today</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">Year</td>
<td>1.000000</td>
<td>0.029700</td>
<td>0.030596</td>
<td>0.033195</td>
<td>0.035689</td>
<td>0.029788</td>
<td>0.539006</td>
<td>0.030095</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Lag1</td>
<td>0.029700</td>
<td>1.000000</td>
<td>-0.026294</td>
<td>-0.010803</td>
<td>-0.002986</td>
<td>-0.005675</td>
<td>0.040910</td>
<td>-0.026155</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Lag2</td>
<td>0.030596</td>
<td>-0.026294</td>
<td>1.000000</td>
<td>-0.025897</td>
<td>-0.010854</td>
<td>-0.003558</td>
<td>-0.043383</td>
<td>-0.010250</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Lag3</td>
<td>0.033195</td>
<td>-0.010803</td>
<td>-0.025897</td>
<td>1.000000</td>
<td>-0.024051</td>
<td>-0.018808</td>
<td>-0.041824</td>
<td>-0.002448</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Lag4</td>
<td>0.035689</td>
<td>-0.002986</td>
<td>-0.010854</td>
<td>-0.024051</td>
<td>1.000000</td>
<td>-0.027084</td>
<td>-0.048414</td>
<td>-0.006900</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Lag5</td>
<td>0.029788</td>
<td>-0.005675</td>
<td>-0.003558</td>
<td>-0.018808</td>
<td>-0.027084</td>
<td>1.000000</td>
<td>-0.022002</td>
<td>-0.034860</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">Volume</td>
<td>0.539006</td>
<td>0.040910</td>
<td>-0.043383</td>
<td>-0.041824</td>
<td>-0.048414</td>
<td>-0.022002</td>
<td>1.000000</td>
<td>0.014592</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">Today</td>
<td>0.030095</td>
<td>-0.026155</td>
<td>-0.010250</td>
<td>-0.002448</td>
<td>-0.006900</td>
<td>-0.034860</td>
<td>0.014592</td>
<td>1.000000</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-e10d072b-90a3-438c-9546-487e88c354fa')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-e10d072b-90a3-438c-9546-487e88c354fa button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-e10d072b-90a3-438c-9546-487e88c354fa');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="ac07b43b-dd72-407f-8671-30229520e1a5" data-execution_count="9">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a><span class="co"># the best way to visualize corerelations matrices is heatmap</span></span>
<span id="cb13-2"><a href="#cb13-2"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">8</span>,<span class="dv">8</span>))</span>
<span id="cb13-3"><a href="#cb13-3"></a>sns.heatmap(corr)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fe61ba50910&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-10-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>As one would expect, the correlations between the lag variables and today’s returns are close to zero. In other words, there appears to be little correlation between today’s returns and previous days’ returns. The only substantial correlation is between <code>Year</code> and <code>volume</code>. By plotting the data, which is ordered chronologically, we see that <code>volume</code> is increasing over time. In other words, the average number of shares traded daily increased from 2001 to 2005.</p>
<div class="cell" data-outputid="74739df0-534e-4426-f3b6-1bc79f643aaa" data-execution_count="10">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a><span class="bu">print</span>(corr.iloc[:,<span class="op">-</span><span class="dv">2</span>:])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>          Volume     Today
Year    0.539006  0.030095
Lag1    0.040910 -0.026155
Lag2   -0.043383 -0.010250
Lag3   -0.041824 -0.002448
Lag4   -0.048414 -0.006900
Lag5   -0.022002 -0.034860
Volume  1.000000  0.014592
Today   0.014592  1.000000</code></pre>
</div>
</div>
<div class="cell" data-outputid="f35db884-eadb-4aa2-f4cd-5c0f8184e8d9" data-execution_count="11">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a><span class="co"># we choose the x axis as index, chossing year will give a discrete plot</span></span>
<span id="cb17-2"><a href="#cb17-2"></a>plt.figure(figsize <span class="op">=</span> (<span class="dv">12</span>,<span class="dv">6</span>))</span>
<span id="cb17-3"><a href="#cb17-3"></a>sns.scatterplot(x<span class="op">=</span>Smarket.index, y<span class="op">=</span><span class="st">"Volume"</span>, data<span class="op">=</span>Smarket)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>&lt;matplotlib.axes._subplots.AxesSubplot at 0x7fe61af38a50&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-12-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="logistic-regression" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="logistic-regression"><span class="header-section-number">4.2</span> Logistic Regression</h2>
<p>Next, we will fit a logistic regression model in order to predict <code>direction</code> using <code>lagone</code> through <code>lagfive</code> and <code>volume</code>. The <code>glm()</code> function can be used to fit many types of generalized linear models , including logistic regression. The syntax of the <code>glm()</code> function is similar to that of <code>lm()</code>, except that we must pass in the argument <code>families.Binomial</code> in order to tell <code>Python</code> to run a logistic regression rather than some other type of generalized linear model.</p>
<div class="cell" data-outputid="06464aeb-237a-433d-feff-569c03674c55" data-execution_count="12">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a>pd.concat([pd.get_dummies(Smarket.Direction), Smarket.Direction], axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="12">

  <div id="df-d934bf31-9b8e-498a-90e4-316bf945e040">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Down</th>
<th data-quarto-table-cell-role="th">Up</th>
<th data-quarto-table-cell-role="th">Direction</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>1</td>
<td>0</td>
<td>Down</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1245</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1246</td>
<td>1</td>
<td>0</td>
<td>Down</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1247</td>
<td>0</td>
<td>1</td>
<td>Up</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1248</td>
<td>1</td>
<td>0</td>
<td>Down</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">1249</td>
<td>1</td>
<td>0</td>
<td>Down</td>
</tr>
</tbody>
</table>


<p>1250 rows × 3 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-d934bf31-9b8e-498a-90e4-316bf945e040')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-d934bf31-9b8e-498a-90e4-316bf945e040 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-d934bf31-9b8e-498a-90e4-316bf945e040');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>We choose the encoding to treat Up as 1 and Down as 0</p>
<div class="cell" data-outputid="5f19f4d3-82c5-4790-d02b-be3f4de5e59e" data-execution_count="13">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb20-1"><a href="#cb20-1"></a>Smarket[<span class="st">'Direction2'</span>] <span class="op">=</span> pd.get_dummies(Smarket.Direction, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb20-2"><a href="#cb20-2"></a>Smarket.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">

  <div id="df-4f4979f3-2d1a-4aff-a87e-195a991648db">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Lag1</th>
<th data-quarto-table-cell-role="th">Lag2</th>
<th data-quarto-table-cell-role="th">Lag3</th>
<th data-quarto-table-cell-role="th">Lag4</th>
<th data-quarto-table-cell-role="th">Lag5</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Today</th>
<th data-quarto-table-cell-role="th">Direction</th>
<th data-quarto-table-cell-role="th">Direction2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2001</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>5.010</td>
<td>1.1913</td>
<td>0.959</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2001</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>1.2965</td>
<td>1.032</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2001</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>1.4112</td>
<td>-0.623</td>
<td>Down</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2001</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>1.2760</td>
<td>0.614</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2001</td>
<td>0.614</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>1.2057</td>
<td>0.213</td>
<td>Up</td>
<td>1</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-4f4979f3-2d1a-4aff-a87e-195a991648db')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-4f4979f3-2d1a-4aff-a87e-195a991648db button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-4f4979f3-2d1a-4aff-a87e-195a991648db');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-outputid="e7991248-fac4-4021-fbcb-ba9ec63a5049" data-execution_count="14">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>formula <span class="op">=</span> <span class="st">'Direction2 ~ Lag1+Lag2+Lag3+Lag4+Lag5+Volume'</span></span>
<span id="cb21-2"><a href="#cb21-2"></a>model <span class="op">=</span> smf.glm(formula<span class="op">=</span>formula, data<span class="op">=</span>Smarket, family<span class="op">=</span>sm.families.Binomial())</span>
<span id="cb21-3"><a href="#cb21-3"></a>result <span class="op">=</span> model.fit()</span>
<span id="cb21-4"><a href="#cb21-4"></a><span class="bu">print</span>(result.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:             Direction2   No. Observations:                 1250
Model:                            GLM   Df Residuals:                     1243
Model Family:                Binomial   Df Model:                            6
Link Function:                  logit   Scale:                          1.0000
Method:                          IRLS   Log-Likelihood:                -863.79
Date:                Sun, 30 Oct 2022   Deviance:                       1727.6
Time:                        02:24:34   Pearson chi2:                 1.25e+03
No. Iterations:                     4                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept     -0.1260      0.241     -0.523      0.601      -0.598       0.346
Lag1          -0.0731      0.050     -1.457      0.145      -0.171       0.025
Lag2          -0.0423      0.050     -0.845      0.398      -0.140       0.056
Lag3           0.0111      0.050      0.222      0.824      -0.087       0.109
Lag4           0.0094      0.050      0.187      0.851      -0.089       0.107
Lag5           0.0103      0.050      0.208      0.835      -0.087       0.107
Volume         0.1354      0.158      0.855      0.392      -0.175       0.446
==============================================================================</code></pre>
</div>
</div>
<p>The smallest <span class="math inline">\(p\)</span>-value here is associated with <code>lagone</code>. The negative coefficient for this predictor suggests that if the market had a positive return yesterday, then it is less likely to go up today. However, at a value of <span class="math inline">\(0.15\)</span>, the <span class="math inline">\(p\)</span>-value is still relatively large, and so there is no clear evidence of a real association between <code>lagone</code> and <code>direction</code>.</p>
<p>We use the <code>params</code> function in order to access just the coefficients for this fitted model. <a href="https://www.statsmodels.org/dev/generated/statsmodels.genmod.generalized_linear_model.GLMResults.html">https://www.statsmodels.org/dev/generated/statsmodels.genmod.generalized_linear_model.GLMResults.html</a>.</p>
<div class="cell" data-outputid="2e069a5a-3b82-4554-c200-c9489ab4b201" data-execution_count="15">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a><span class="bu">print</span>(<span class="st">"Coeffieients"</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a><span class="bu">print</span>(result.params)</span>
<span id="cb23-3"><a href="#cb23-3"></a><span class="bu">print</span>(<span class="st">"p-Values"</span>)</span>
<span id="cb23-4"><a href="#cb23-4"></a><span class="bu">print</span>(result.pvalues)</span>
<span id="cb23-5"><a href="#cb23-5"></a><span class="bu">print</span>(<span class="st">"Dependent variables"</span>)</span>
<span id="cb23-6"><a href="#cb23-6"></a><span class="bu">print</span>(result.model.endog_names)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Coeffieients
Intercept   -0.126000
Lag1        -0.073074
Lag2        -0.042301
Lag3         0.011085
Lag4         0.009359
Lag5         0.010313
Volume       0.135441
dtype: float64
p-Values
Intercept    0.600700
Lag1         0.145232
Lag2         0.398352
Lag3         0.824334
Lag4         0.851445
Lag5         0.834998
Volume       0.392404
dtype: float64
Dependent variables
Direction2</code></pre>
</div>
</div>
<p>The <code>predict()</code> function can be used to predict the probability that the market will go up, given values of the predictors. If no data set is supplied to the <code>predict()</code> function, then the probabilities are computed for the training data that was used to fit the logistic regression model. Here we have printed only the first ten probabilities. We know that these values correspond to the probability of the market going up, rather than down, because we have set the dummy variable with a 1 for <code>Up</code>.</p>
<div class="cell" data-outputid="31129b9e-8fe1-468e-da7d-7bb639be3236" data-execution_count="16">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb25-1"><a href="#cb25-1"></a>predictions <span class="op">=</span> result.predict()</span>
<span id="cb25-2"><a href="#cb25-2"></a><span class="bu">print</span>(predictions[:<span class="dv">10</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.50708413 0.48146788 0.48113883 0.51522236 0.51078116 0.50695646
 0.49265087 0.50922916 0.51761353 0.48883778]</code></pre>
</div>
</div>
<p>In order to make a prediction as to whether the market will go up or down on a particular day, we must convert these predicted probabilities into class labels, <code>Up</code> or <code>Down</code>. The following command create a vector of class predictions based on whether the predicted probability of a market increase is greater than or less than <span class="math inline">\(0.5\)</span>.</p>
<div class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1"></a>predictions_nominal <span class="op">=</span> [ <span class="st">"Up"</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="st">"Down"</span> <span class="cf">for</span> x <span class="kw">in</span> predictions]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Given these predictions, the <code>confusion_matrix()</code> function can be used to produce a confusion matrix in order to determine how many observations were correctly or incorrectly classified.</p>
<div class="cell" data-outputid="d355f474-45e9-4b91-b6ee-148989098e35" data-execution_count="18">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a>cm <span class="op">=</span> confusion_matrix(Smarket.Direction, predictions_nominal)</span>
<span id="cb28-2"><a href="#cb28-2"></a>cm</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>array([[145, 457],
       [141, 507]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="54a97c12-1e84-4b07-f404-31b2c46f3853" data-execution_count="19">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>ConfusionMatrixDisplay(cm, display_labels<span class="op">=</span>[<span class="dv">0</span>,<span class="dv">1</span>]).plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="19">
<pre><code>&lt;sklearn.metrics._plot.confusion_matrix.ConfusionMatrixDisplay at 0x7fe619662690&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="27da8692-9d97-437d-c059-cf1129767611" data-execution_count="20">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a><span class="bu">print</span>(classification_report(Smarket.Direction, predictions_nominal, digits<span class="op">=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

        Down      0.507     0.241     0.327       602
          Up      0.526     0.782     0.629       648

    accuracy                          0.522      1250
   macro avg      0.516     0.512     0.478      1250
weighted avg      0.517     0.522     0.483      1250
</code></pre>
</div>
</div>
<p>The diagonal elements of the confusion matrix indicate correct predictions, while the off-diagonals represent incorrect predictions. Hence our model correctly predicted that the market would go up on <span class="math inline">\(507\)</span> days and that it would go down on <span class="math inline">\(145\)</span> days, for a total of <span class="math inline">\(507+145 = 652\)</span> correct predictions. The <code>classification_report()</code> function can be used to compute the fraction of days for which the prediction was correct. In this case, logistic regression correctly predicted the movement of the market <span class="math inline">\(52.2\)</span>,% of the time.</p>
<p>At first glance, it appears that the logistic regression model is working a little better than random guessing. However, this result is misleading because we trained and tested the model on the same set of <span class="math inline">\(1,250\)</span> observations. In other words, <span class="math inline">\(100\%-52.2\%=47.8\%\)</span>, is the <em>training</em> error rate. As we have seen previously, the training error rate is often overly optimistic—it tends to underestimate the test error rate. In order to better assess the accuracy of the logistic regression model in this setting, we can fit the model using part of the data, and then examine how well it predicts the <em>held out</em> data. This will yield a more realistic error rate, in the sense that in practice we will be interested in our model’s performance not on the data that we used to fit the model, but rather on days in the future for which the market’s movements are unknown.</p>
<p>To implement this strategy, we will first create a vector corresponding to the observations from 2001 through 2004. We will then use this vector to create a held out data set of observations from 2005.</p>
<div class="cell" data-outputid="d82f4cdf-7a2f-48e2-e933-7488dac8f4a2" data-execution_count="62">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a>train_filter <span class="op">=</span> Smarket.Year <span class="op">&lt;</span> <span class="dv">2005</span></span>
<span id="cb34-2"><a href="#cb34-2"></a><span class="co"># train_filter.value_counts()</span></span>
<span id="cb34-3"><a href="#cb34-3"></a>X_test <span class="op">=</span> Smarket.loc[<span class="op">~</span>train_filter,]</span>
<span id="cb34-4"><a href="#cb34-4"></a>y_test <span class="op">=</span> Smarket.loc[<span class="op">~</span>train_filter, <span class="st">'Direction2'</span>]</span>
<span id="cb34-5"><a href="#cb34-5"></a>y_test.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="62">
<pre><code>(252,)</code></pre>
</div>
</div>
<p>The data contains <span class="math inline">\(1{,}250\)</span> elements, corresponding to the observations in our data set. The output above indicates that there are 252 such observations in testset.</p>
<p>We now fit a logistic regression model using only the subset of the observations that correspond to dates before 2005. We then obtain predicted probabilities of the stock market going up for each of the days in our test set—that is, for the days in 2005.</p>
<div class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a>model <span class="op">=</span> smf.glm(formula<span class="op">=</span>formula, data<span class="op">=</span>Smarket, subset<span class="op">=</span>train_filter, family<span class="op">=</span>sm.families.Binomial())</span>
<span id="cb36-2"><a href="#cb36-2"></a>result <span class="op">=</span> model.fit()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we have trained and tested our model on two completely separate data sets: training was performed using only the dates before 2005, and testing was performed using only the dates in 2005. Finally, we compute the predictions for 2005 and compare them to the actual movements of the market over that time period.</p>
<div class="cell" data-outputid="564a6fdf-32a8-44a5-d7b7-d2ca7fe0b5ec" data-execution_count="64">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb37-1"><a href="#cb37-1"></a>predictions <span class="op">=</span> result.predict(X_test)</span>
<span id="cb37-2"><a href="#cb37-2"></a>predictions_nominal <span class="op">=</span> [ <span class="st">"Up"</span> <span class="cf">if</span> x <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="st">"Down"</span> <span class="cf">for</span> x <span class="kw">in</span> predictions]</span>
<span id="cb37-3"><a href="#cb37-3"></a><span class="bu">print</span>(classification_report(Smarket.loc[<span class="op">~</span>train_filter, <span class="st">'Direction'</span>], predictions_nominal, digits<span class="op">=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>              precision    recall  f1-score   support

        Down      0.443     0.694     0.540       111
          Up      0.564     0.312     0.402       141

    accuracy                          0.480       252
   macro avg      0.503     0.503     0.471       252
weighted avg      0.511     0.480     0.463       252
</code></pre>
</div>
</div>
<p>The results are rather disappointing: the test error rate is <span class="math inline">\(52\)</span>,%, which is worse than random guessing! Of course this result is not all that surprising, given that one would not generally expect to be able to use previous days’ returns to predict future market performance. (After all, if it were possible to do so, then the authors of this book would be out striking it rich rather than writing a statistics textbook.)</p>
<p>We recall that the logistic regression model had very underwhelming <span class="math inline">\(p\)</span>-values associated with all of the predictors, and that the smallest <span class="math inline">\(p\)</span>-value, though not very small, corresponded to <code>lagone</code>. Perhaps by removing the variables that appear not to be helpful in predicting <code>direction</code>, we can obtain a more effective model. After all, using predictors that have no relationship with the response tends to cause a deterioration in the test error rate (since such predictors cause an increase in variance without a corresponding decrease in bias), and so removing such predictors may in turn yield an improvement.</p>
<p>Below we have refit the logistic regression using just <code>lagone</code> and <code>lagtwo</code>, which seemed to have the highest predictive power in the original logistic regression model.</p>
<div class="cell" data-outputid="6a474124-fa8c-4ee7-8ba5-9d0a44986134" data-execution_count="65">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>logreg_stats <span class="op">=</span> smf.glm(formula <span class="op">=</span> <span class="st">'Direction2 ~ Lag1+Lag2'</span>, data<span class="op">=</span>Smarket, subset<span class="op">=</span>train_filter, </span>
<span id="cb39-2"><a href="#cb39-2"></a>                       family<span class="op">=</span>sm.families.Binomial()).fit()</span>
<span id="cb39-3"><a href="#cb39-3"></a><span class="bu">print</span>(logreg_stats.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:             Direction2   No. Observations:                  998
Model:                            GLM   Df Residuals:                      995
Model Family:                Binomial   Df Model:                            2
Link Function:                  logit   Scale:                          1.0000
Method:                          IRLS   Log-Likelihood:                -690.70
Date:                Sun, 30 Oct 2022   Deviance:                       1381.4
Time:                        02:25:08   Pearson chi2:                     998.
No. Iterations:                     4                                         
Covariance Type:            nonrobust                                         
==============================================================================
                 coef    std err          z      P&gt;|z|      [0.025      0.975]
------------------------------------------------------------------------------
Intercept      0.0322      0.063      0.508      0.611      -0.092       0.156
Lag1          -0.0556      0.052     -1.076      0.282      -0.157       0.046
Lag2          -0.0445      0.052     -0.861      0.389      -0.146       0.057
==============================================================================</code></pre>
</div>
</div>
<div class="cell" data-outputid="0029148f-e310-47df-ff9e-7727c6b1ed49" data-execution_count="67">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a>X_test <span class="op">=</span> Smarket.loc[<span class="op">~</span>train_filter, [<span class="st">'Lag1'</span>, <span class="st">'Lag2'</span>]]</span>
<span id="cb41-2"><a href="#cb41-2"></a>y_test_pred <span class="op">=</span> logreg_stats.predict(X_test)</span>
<span id="cb41-3"><a href="#cb41-3"></a>y_test_pred_class <span class="op">=</span> [<span class="dv">1</span> <span class="cf">if</span> prob <span class="op">&gt;</span> <span class="fl">0.5</span> <span class="cf">else</span> <span class="dv">0</span> <span class="cf">for</span> prob <span class="kw">in</span> y_test_pred]</span>
<span id="cb41-4"><a href="#cb41-4"></a>conf_mat <span class="op">=</span> confusion_matrix(y_test, y_test_pred_class)</span>
<span id="cb41-5"><a href="#cb41-5"></a><span class="bu">print</span>(conf_mat)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 35  76]
 [ 35 106]]</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1"></a>logreg_stats.p</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="44c6af39-c46d-4cb7-b48a-b5c39390c88d" data-execution_count="26">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>TP <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb44-2"><a href="#cb44-2"></a>TN <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb44-3"><a href="#cb44-3"></a>FP <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb44-4"><a href="#cb44-4"></a>FN <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb44-5"><a href="#cb44-5"></a></span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="co"># print("Accuracy: ", conf_mat.diagonal().sum()/conf_mat.sum() )</span></span>
<span id="cb44-7"><a href="#cb44-7"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, (TP<span class="op">+</span>TN) <span class="op">/</span> (TP<span class="op">+</span>TN<span class="op">+</span>FP<span class="op">+</span>FN) )</span>
<span id="cb44-8"><a href="#cb44-8"></a><span class="bu">print</span>(<span class="st">"Sensitivity: "</span>,  TP <span class="op">/</span> (FN <span class="op">+</span> TP) )</span>
<span id="cb44-9"><a href="#cb44-9"></a><span class="bu">print</span>(<span class="st">"Precision: "</span>,  TP <span class="op">/</span> (FP <span class="op">+</span> TP) )</span>
<span id="cb44-10"><a href="#cb44-10"></a><span class="bu">print</span>(<span class="st">"False Positive Rate: "</span>,  FP <span class="op">/</span> (FP <span class="op">+</span> TN) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy:  0.5595238095238095
Sensitivity:  0.75177304964539
Precision:  0.5824175824175825
False Positive Rate:  0.6846846846846847</code></pre>
</div>
</div>
<p>You can find many useful metrics in the sklearn module <a href="https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics">https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics</a>.</p>
<div class="cell" data-outputid="db5d521f-8252-40f9-d264-a3f52551b1c4" data-execution_count="88">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y_test, y_test_pred_class)</span>
<span id="cb46-2"><a href="#cb46-2"></a><span class="bu">print</span>(fpr, tpr)</span>
<span id="cb46-3"><a href="#cb46-3"></a>roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb46-4"><a href="#cb46-4"></a>RocCurveDisplay(fpr<span class="op">=</span>fpr, tpr<span class="op">=</span>tpr, roc_auc<span class="op">=</span>roc_auc, estimator_name<span class="op">=</span><span class="st">'example estimator'</span>).plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.         0.68468468 1.        ] [0.         0.75177305 1.        ]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x7fe618521450&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-29-output-3.png" class="img-fluid"></p>
</div>
</div>
<p>Now the results appear to be a little better: <span class="math inline">\(56\%\)</span> of the daily movements have been correctly predicted. It is worth noting that in this case, a much simpler strategy of predicting that the market will increase every day will also be correct <span class="math inline">\(56\%\)</span> of the time! Hence, in terms of overall error rate, the logistic regression method is no better than the naive approach. However, the confusion matrix shows that on days when logistic regression predicts an increase in the market, it has a <span class="math inline">\(58\%\)</span> accuracy rate. This suggests a possible trading strategy of buying on days when the model predicts an increasing market, and avoiding trades on days when a decrease is predicted. Of course one would need to investigate more carefully whether this small improvement was real or just due to random chance.</p>
<p>Suppose that we want to predict the returns associated with particular values of <code>lagone</code> and <code>lagtwo</code>. In particular, we want to predict <code>direction</code> on a day when <code>lagone</code> and <code>lagtwo</code> equal 1.2 and~1.1, respectively, and on a day when they equal 1.5 and $-$0.8. We do this using the <code>predict()</code> function.</p>
<div class="cell" data-outputid="a2683a34-dc41-457c-c948-f078013d09c5" data-execution_count="28">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1"></a>Up_Prob <span class="op">=</span> logreg_stats.predict(pd.DataFrame([[<span class="fl">1.2</span>, <span class="fl">1.1</span>], [<span class="fl">1.5</span>, <span class="op">-</span><span class="fl">0.8</span>]], </span>
<span id="cb49-2"><a href="#cb49-2"></a>                                  columns<span class="op">=</span>[<span class="st">"Lag1"</span>, <span class="st">"Lag2"</span>]))   <span class="co"># 0 is the 'Up' , 1 is the 'Down'</span></span>
<span id="cb49-3"><a href="#cb49-3"></a><span class="bu">print</span>(<span class="st">"Up probabilities for the 2 samples are </span><span class="sc">%s</span><span class="st"> and </span><span class="sc">%s</span><span class="st">"</span> <span class="op">%</span> (Up_Prob[<span class="dv">0</span>], </span>
<span id="cb49-4"><a href="#cb49-4"></a>                                                         Up_Prob[<span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Up probabilities for the 2 samples are 0.47914623911039295 and 0.4960938729355764</code></pre>
</div>
</div>
</section>
<section id="linear-discriminant-analysis" class="level2" data-number="4.3">
<h2 data-number="4.3" class="anchored" data-anchor-id="linear-discriminant-analysis"><span class="header-section-number">4.3</span> Linear Discriminant Analysis</h2>
<p>Now we will perform LDA on the <code>Smarket</code> data. In <code>Python</code>, we fit an LDA model using the <code>LDA()</code> function, which is part of the <code>sklearn</code> library. We fit the model using only the observations before 2005.</p>
<div class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1"></a>X_train <span class="op">=</span> Smarket.loc[train_filter, [<span class="st">'Lag1'</span>,<span class="st">'Lag2'</span>]]</span>
<span id="cb51-2"><a href="#cb51-2"></a>y_train <span class="op">=</span> Smarket.loc[train_filter, <span class="st">'Direction2'</span>]</span>
<span id="cb51-3"><a href="#cb51-3"></a></span>
<span id="cb51-4"><a href="#cb51-4"></a>X_test <span class="op">=</span> Smarket.loc[<span class="op">~</span>train_filter, [<span class="st">'Lag1'</span>,<span class="st">'Lag2'</span>]]</span>
<span id="cb51-5"><a href="#cb51-5"></a>y_test <span class="op">=</span> Smarket.loc[<span class="op">~</span>train_filter, <span class="st">'Direction2'</span>]</span>
<span id="cb51-6"><a href="#cb51-6"></a></span>
<span id="cb51-7"><a href="#cb51-7"></a>lda <span class="op">=</span> LDA()</span>
<span id="cb51-8"><a href="#cb51-8"></a>model <span class="op">=</span> lda.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="5a765970-db33-4aa5-9de9-557dea26c49a" data-execution_count="30">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="bu">print</span>(<span class="st">'Prior Probs are - '</span>,lda.priors_)</span>
<span id="cb52-2"><a href="#cb52-2"></a><span class="bu">print</span>(<span class="st">'Class Means are  - '</span>,lda.means_)</span>
<span id="cb52-3"><a href="#cb52-3"></a><span class="bu">print</span>(<span class="st">'Coeff are - '</span>, lda.scalings_) <span class="co"># coefficients of ld</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Prior Probs are -  [0.49198397 0.50801603]
Class Means are  -  [[ 0.04279022  0.03389409]
 [-0.03954635 -0.03132544]]
Coeff are -  [[-0.64201904]
 [-0.51352928]]</code></pre>
</div>
</div>
<div class="cell" data-outputid="02c8f153-f312-42d8-9026-e2d59664a6a1" data-execution_count="31">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a><span class="co"># for plotting lda</span></span>
<span id="cb54-2"><a href="#cb54-2"></a>ld_sc <span class="op">=</span> X_train.iloc[:, <span class="dv">0</span>] <span class="op">*</span> lda.scalings_[<span class="dv">0</span>] <span class="op">+</span> X_train.iloc[:, <span class="dv">1</span>] <span class="op">*</span> lda.scalings_[<span class="dv">1</span>]</span>
<span id="cb54-3"><a href="#cb54-3"></a></span>
<span id="cb54-4"><a href="#cb54-4"></a>ld <span class="op">=</span> pd.DataFrame({<span class="st">'groups'</span>: y_train, <span class="st">'ld'</span>: ld_sc})</span>
<span id="cb54-5"><a href="#cb54-5"></a></span>
<span id="cb54-6"><a href="#cb54-6"></a>g <span class="op">=</span> sns.FacetGrid(ld, col<span class="op">=</span><span class="st">'groups'</span>)</span>
<span id="cb54-7"><a href="#cb54-7"></a>g.<span class="bu">map</span>(plt.hist, <span class="st">'ld'</span>)</span>
<span id="cb54-8"><a href="#cb54-8"></a>ax1, ax2 <span class="op">=</span> g.axes[<span class="dv">0</span>]</span>
<span id="cb54-9"><a href="#cb54-9"></a>ax1.set_xlabel(<span class="st">"Down"</span>)</span>
<span id="cb54-10"><a href="#cb54-10"></a>ax2.set_xlabel(<span class="st">"Up"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="31">
<pre><code>Text(0.5, 15.439999999999998, 'Up')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-33-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The LDA output indicates that <span class="math inline">\(\hat\pi_1=0.492\)</span> and <span class="math inline">\(\hat\pi_2=0.508\)</span>; in other words, <span class="math inline">\(49.2\)</span>,% of the training observations correspond to days during which the market went down. It also provides the group means; these are the average of each predictor within each class, and are used by LDA as estimates of <span class="math inline">\(\mu_k\)</span>. These suggest that there is a tendency for the previous 2~days’ returns to be negative on days when the market increases, and a tendency for the previous days’ returns to be positive on days when the market declines.</p>
<p>The <em>coefficients of linear discriminants</em> output provides the linear combination of <code>lagone</code> and <code>lagtwo</code> that are used to form the LDA decision rule. In other words, these are the multipliers of the elements of <span class="math inline">\(X=x\)</span> in (4.24). If <span class="math inline">\(-0.642\times `lagone` - 0.514 \times `lagtwo`\)</span> is large, then the LDA classifier will predict a market increase, and if it is small, then the LDA classifier will predict a market decline.</p>
<p>The above plot produces plots of the <em>linear discriminants</em>, obtained by computing <span class="math inline">\(-0.642\times `lagone` - 0.514 \times `lagtwo`\)</span> for each of the training observations. The <code>Up</code> and <code>Down</code> observations are displayed separately.</p>
<p>The <code>predict()</code> function returns LDA’s predictions about the movement of the market. The <code>predict_proba</code> returns a matrix whose <span class="math inline">\(k\)</span>th column contains the posterior probability that the corresponding observation belongs to the <span class="math inline">\(k\)</span>th class, computed from (4.15).</p>
<div class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1"></a>pred <span class="op">=</span> lda.predict(X_test)</span>
<span id="cb56-2"><a href="#cb56-2"></a>post <span class="op">=</span> lda.predict_proba(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first element, <code>pred</code>, contains LDA’s predictions about the movement of the market. The second element, <code>post</code>, is a matrix whose <span class="math inline">\(k\)</span>th column contains the posterior probability that the corresponding observation belongs to the <span class="math inline">\(k\)</span>th class, computed from (4.15).</p>
<p>As we observed in Section 4.5, the LDA and logistic regression predictions are almost identical.</p>
<div class="cell" data-outputid="a1f8b8c2-d5f1-4a7a-a3d6-6a339e9e4b29" data-execution_count="33">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1"></a>cm <span class="op">=</span> confusion_matrix(y_test,pred)</span>
<span id="cb57-2"><a href="#cb57-2"></a><span class="bu">print</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 35  76]
 [ 35 106]]</code></pre>
</div>
</div>
<p>Applying a <span class="math inline">\(50\)</span>,% threshold to the posterior probabilities allows us to recreate the predictions contained in <code>pred</code>.</p>
<div class="cell" data-outputid="747b36cf-512d-404d-99bd-d6984186274a" data-execution_count="34">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a>np.unique(post[:,<span class="dv">0</span>]<span class="op">&gt;</span><span class="fl">0.5</span>, return_counts<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>(array([False,  True]), array([182,  70]))</code></pre>
</div>
</div>
<p>Notice that the posterior probability output by the model corresponds to the probability that the market will <em>increase</em>:</p>
<div class="cell" data-outputid="73a83531-1dc4-4b17-eb27-75be2d76ede4" data-execution_count="35">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a>post[:<span class="dv">20</span>, <span class="dv">0</span>], pred[:<span class="dv">20</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="35">
<pre><code>(array([0.49017925, 0.4792185 , 0.46681848, 0.47400107, 0.49278766,
        0.49385615, 0.49510156, 0.4872861 , 0.49070135, 0.48440262,
        0.49069628, 0.51199885, 0.48951523, 0.47067612, 0.47445929,
        0.47995834, 0.49357753, 0.50308938, 0.49788061, 0.48863309]),
 array([1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 0, 1, 1, 1, 1, 1, 0, 1, 1],
       dtype=uint8))</code></pre>
</div>
</div>
<p>If we wanted to use a posterior probability threshold other than <span class="math inline">\(50\)</span>,% in order to make predictions, then we could easily do so. For instance, suppose that we wish to predict a market decrease only if we are very certain that the market will indeed decrease on that day—say, if the posterior probability is at least <span class="math inline">\(90\)</span>,%.</p>
<div class="cell" data-outputid="a956756e-2251-48af-f45f-1f9f078c4d7e" data-execution_count="36">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a>np.unique(post[:,<span class="dv">0</span>]<span class="op">&gt;</span><span class="fl">0.9</span>, return_counts<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="36">
<pre><code>(array([False]), array([252]))</code></pre>
</div>
</div>
<p>No days in 2005 meet that threshold! In fact, the greatest posterior probability of decrease in all of 2005 was <span class="math inline">\(52.02\)</span>,%.</p>
</section>
<section id="quadratic-discriminant-analysis" class="level2" data-number="4.4">
<h2 data-number="4.4" class="anchored" data-anchor-id="quadratic-discriminant-analysis"><span class="header-section-number">4.4</span> Quadratic Discriminant Analysis</h2>
<p>We will now fit a QDA model to the <code>Smarket</code> data.</p>
<div class="cell" data-outputid="efa99fc1-6f4a-4f83-f2f6-b800138f0655" data-execution_count="37">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a>qda <span class="op">=</span> QDA()</span>
<span id="cb65-2"><a href="#cb65-2"></a>qda.fit(X_train,y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="37">
<pre><code>QuadraticDiscriminantAnalysis()</code></pre>
</div>
</div>
<div class="cell" data-outputid="db18561d-d296-4bb4-ac64-438fccae7c20" data-execution_count="38">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a><span class="bu">print</span>(<span class="st">'Mean for class 0 is - '</span>,qda.means_[<span class="dv">0</span>])</span>
<span id="cb67-2"><a href="#cb67-2"></a><span class="bu">print</span>(<span class="st">'Mean for class 1 is - '</span>,qda.means_[<span class="dv">1</span>])</span>
<span id="cb67-3"><a href="#cb67-3"></a><span class="bu">print</span>(<span class="st">'Prior probalbilities - '</span>,qda.priors_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mean for class 0 is -  [0.04279022 0.03389409]
Mean for class 1 is -  [-0.03954635 -0.03132544]
Prior probalbilities -  [0.49198397 0.50801603]</code></pre>
</div>
</div>
<p>The output contains the group means. But it does not contain the coefficients of the linear discriminants, because the QDA classifier involves a quadratic, rather than a linear, function of the predictors. The <code>predict()</code> function works in exactly the same fashion as for LDA.</p>
<div class="cell" data-outputid="759fc1cd-5a00-4a59-efad-8e104f8e671b" data-execution_count="39">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a>pred <span class="op">=</span> qda.predict(X_test)</span>
<span id="cb69-2"><a href="#cb69-2"></a>cm <span class="op">=</span> confusion_matrix(y_test,pred)</span>
<span id="cb69-3"><a href="#cb69-3"></a><span class="bu">print</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 30  81]
 [ 20 121]]</code></pre>
</div>
</div>
<div class="cell" data-outputid="69adc3be-ae0a-49da-efdc-b917fa58b2c7" data-execution_count="40">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1"></a><span class="bu">print</span>(<span class="st">'Accuracy using QDA is '</span>,accuracy_score(y_test,pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy using QDA is  0.5992063492063492</code></pre>
</div>
</div>
<p>Interestingly, the QDA predictions are accurate almost <span class="math inline">\(60\)</span>,% of the time, even though the 2005 data was not used to fit the model. This level of accuracy is quite impressive for stock market data, which is known to be quite hard to model accurately. This suggests that the quadratic form assumed by QDA may capture the true relationship more accurately than the linear forms assumed by LDA and logistic regression.</p>
<p>However, we recommend evaluating this method’s performance on a larger test set before betting that this approach will consistently beat the market!</p>
</section>
<section id="naive-bayes" class="level2" data-number="4.5">
<h2 data-number="4.5" class="anchored" data-anchor-id="naive-bayes"><span class="header-section-number">4.5</span> Naive Bayes</h2>
<p>Next, we fit a naive Bayes model to the <code>Smarket</code> data. By default, this implementation of the naive Bayes classifier models each quantitative feature using a Gaussian distribution. However, a kernel density method can also be used to estimate the distributions.</p>
<p>Meaning of <a href="https://stackoverflow.com/questions/58046129/can-someone-give-a-good-math-stats-explanation-as-to-what-the-parameter-var-smoo"><code>var_smoothing</code></a>.</p>
<div class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1"></a>gnb <span class="op">=</span> GaussianNB(var_smoothing<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb73-2"><a href="#cb73-2"></a>y_pred <span class="op">=</span> gnb.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="bdbdeab9-b52b-4b0f-e0e4-2bd591341be0" data-execution_count="42">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1"></a>gnb.class_prior_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="42">
<pre><code>array([0.49198397, 0.50801603])</code></pre>
</div>
</div>
<div class="cell" data-outputid="d6e471c3-0c3b-4bbf-a843-7443181336c6" data-execution_count="43">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1"></a>gnb.theta_</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="43">
<pre><code>array([[ 0.04279022,  0.03389409],
       [-0.03954635, -0.03132544]])</code></pre>
</div>
</div>
<div class="cell" data-outputid="f65b4d74-7c3e-4537-e0be-cae8ebf24392" data-execution_count="44">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1"></a>np.sqrt(gnb.sigma_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/sklearn/utils/deprecation.py:103: FutureWarning: Attribute `sigma_` was deprecated in 1.0 and will be removed in1.2. Use `var_` instead.
  warnings.warn(msg, category=FutureWarning)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>array([[1.22619505, 1.23792871],
       [1.23045262, 1.21956089]])</code></pre>
</div>
</div>
<p>The output contains the estimated mean and standard deviation for each variable in each class. For example, the mean for <code>lagone</code> is <span class="math inline">\(0.0428\)</span> for <code>Direction=Down</code>, and the standard deviation is <span class="math inline">\(1.226\)</span>. We can easily verify this:</p>
<div class="cell" data-outputid="de067a45-7a94-46ca-d9cc-5c0b324d8cc6" data-execution_count="45">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1"></a><span class="bu">print</span>(np.mean(X_train.loc[y_train<span class="op">==</span><span class="dv">0</span>][<span class="st">'Lag1'</span>]))</span>
<span id="cb81-2"><a href="#cb81-2"></a><span class="bu">print</span>(np.std(X_train.loc[y_train<span class="op">==</span><span class="dv">0</span>][<span class="st">'Lag1'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0.04279022403258655
1.226195046492573</code></pre>
</div>
</div>
<p>Notice that <code>R</code> calulates the standard deviation with <code>N - 1</code> as the denominator, and in <code>Python</code> as <code>Numpy</code> use <code>N</code>. <a href="https://stackoverflow.com/questions/20708455/different-results-for-standard-deviation-using-numpy-and-r">https://stackoverflow.com/questions/20708455/different-results-for-standard-deviation-using-numpy-and-r</a>.</p>
<p>The <code>predict()</code> function is straightforward.</p>
<div class="cell" data-outputid="234d70c7-8739-40cd-ca2f-c00837c6990f" data-execution_count="46">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1"></a>pred <span class="op">=</span> gnb.predict(X_test)</span>
<span id="cb83-2"><a href="#cb83-2"></a>cm <span class="op">=</span> confusion_matrix(y_test,pred)</span>
<span id="cb83-3"><a href="#cb83-3"></a><span class="bu">print</span>(cm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[ 29  82]
 [ 20 121]]</code></pre>
</div>
</div>
<div class="cell" data-outputid="e54c993e-8f68-4990-da1e-cbcce3e90329" data-execution_count="47">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a><span class="bu">print</span>(<span class="st">'Accuracy using gnb is '</span>,accuracy_score(y_test,pred))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy using gnb is  0.5952380952380952</code></pre>
</div>
</div>
<p>Naive Bayes performs very well on this data, with accurate predictions over <span class="math inline">\(59.5\%\)</span> of the time. This is slightly worse than QDA, but much better than LDA.</p>
<p>The <code>predict_prob()</code> function can generate estimates of the probability that each observation belongs to a particular class.</p>
<div class="cell" data-outputid="e10563cd-7ec0-47ba-ff48-a2a80bc5230c" data-execution_count="48">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1"></a>preds <span class="op">=</span> gnb.predict_proba(Smarket.loc[Smarket.Year<span class="op">==</span><span class="dv">2005</span>,[<span class="st">'Lag1'</span>, <span class="st">'Lag2'</span>]])</span>
<span id="cb87-2"><a href="#cb87-2"></a>preds[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>array([[0.4873288 , 0.5126712 ],
       [0.47623584, 0.52376416],
       [0.46529531, 0.53470469],
       [0.47484469, 0.52515531],
       [0.49020587, 0.50979413]])</code></pre>
</div>
</div>
</section>
<section id="k-nearest-neighbors" class="level2" data-number="4.6">
<h2 data-number="4.6" class="anchored" data-anchor-id="k-nearest-neighbors"><span class="header-section-number">4.6</span> <span class="math inline">\(K\)</span>-Nearest Neighbors</h2>
<p>We will now perform KNN using the <code>knn()</code> function.</p>
<div class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb89-2"><a href="#cb89-2"></a>pred <span class="op">=</span> knn.fit(X_train, y_train).predict(X_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="10ad1717-2567-4876-986e-27359852b2c5" data-execution_count="50">
<div class="sourceCode cell-code" id="cb90"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb90-1"><a href="#cb90-1"></a><span class="bu">print</span>(confusion_matrix(y_test, pred))</span>
<span id="cb90-2"><a href="#cb90-2"></a><span class="bu">print</span>(classification_report(y_test, pred, digits<span class="op">=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[43 68]
 [58 83]]
              precision    recall  f1-score   support

           0      0.426     0.387     0.406       111
           1      0.550     0.589     0.568       141

    accuracy                          0.500       252
   macro avg      0.488     0.488     0.487       252
weighted avg      0.495     0.500     0.497       252
</code></pre>
</div>
</div>
<p>The results using <span class="math inline">\(K=1\)</span> are not very good, since only <span class="math inline">\(50\)</span>,% of the observations are correctly predicted. Of course, it may be that <span class="math inline">\(K=1\)</span> results in an overly flexible fit to the data. Below, we repeat the analysis using <span class="math inline">\(K=3\)</span>.</p>
<div class="cell" data-outputid="4c716c64-e843-40fc-c1ab-5877e71fc8ae" data-execution_count="51">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb92-2"><a href="#cb92-2"></a>pred <span class="op">=</span> knn.fit(X_train, y_train).predict(X_test)</span>
<span id="cb92-3"><a href="#cb92-3"></a><span class="bu">print</span>(confusion_matrix(y_test, pred))</span>
<span id="cb92-4"><a href="#cb92-4"></a><span class="bu">print</span>(classification_report(y_test, pred, digits<span class="op">=</span><span class="dv">3</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[48 63]
 [55 86]]
              precision    recall  f1-score   support

           0      0.466     0.432     0.449       111
           1      0.577     0.610     0.593       141

    accuracy                          0.532       252
   macro avg      0.522     0.521     0.521       252
weighted avg      0.528     0.532     0.529       252
</code></pre>
</div>
</div>
<p>The results have improved slightly. But increasing <span class="math inline">\(K\)</span> further turns out to provide no further improvements. It appears that for this data, QDA provides the best results of the methods that we have examined so far.</p>
<p>KNN does not perform well on the <code>Smarket</code> data but it does often provide impressive results. As an example we will apply the KNN approach to the <code>Insurance</code> data set, which is part of the <code>ISLR2</code> library. This data set includes <span class="math inline">\(85\)</span> predictors that measure demographic characteristics for 5,822 individuals. The response variable is <code>Purchase</code>, which indicates whether or not a given individual purchases a caravan insurance policy. In this data set, only <span class="math inline">\(6\)</span>,% of people purchased caravan insurance.</p>
<div class="cell" data-outputid="c44ec555-178d-4eff-a584-ca059fe75ece" data-execution_count="52">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1"></a>Caravan <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Caravan.csv'</span>)</span>
<span id="cb94-2"><a href="#cb94-2"></a><span class="bu">print</span>(Caravan.shape)</span>
<span id="cb94-3"><a href="#cb94-3"></a><span class="bu">print</span>(Caravan.Purchase.value_counts())</span>
<span id="cb94-4"><a href="#cb94-4"></a><span class="bu">print</span>(Caravan.Purchase.value_counts()[<span class="dv">1</span>] <span class="op">/</span> <span class="bu">len</span>(Caravan))</span>
<span id="cb94-5"><a href="#cb94-5"></a><span class="co"># Only around 6% of the people purchased the insurance</span></span>
<span id="cb94-6"><a href="#cb94-6"></a>Caravan.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(5822, 86)
No     5474
Yes     348
Name: Purchase, dtype: int64
0.05977327378907592</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="52">

  <div id="df-7d0d31e5-ae7e-4ab7-82d3-5fe122ae3698">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">MOSTYPE</th>
<th data-quarto-table-cell-role="th">MAANTHUI</th>
<th data-quarto-table-cell-role="th">MGEMOMV</th>
<th data-quarto-table-cell-role="th">MGEMLEEF</th>
<th data-quarto-table-cell-role="th">MOSHOOFD</th>
<th data-quarto-table-cell-role="th">MGODRK</th>
<th data-quarto-table-cell-role="th">MGODPR</th>
<th data-quarto-table-cell-role="th">MGODOV</th>
<th data-quarto-table-cell-role="th">MGODGE</th>
<th data-quarto-table-cell-role="th">MRELGE</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">APERSONG</th>
<th data-quarto-table-cell-role="th">AGEZONG</th>
<th data-quarto-table-cell-role="th">AWAOREG</th>
<th data-quarto-table-cell-role="th">ABRAND</th>
<th data-quarto-table-cell-role="th">AZEILPL</th>
<th data-quarto-table-cell-role="th">APLEZIER</th>
<th data-quarto-table-cell-role="th">AFIETS</th>
<th data-quarto-table-cell-role="th">AINBOED</th>
<th data-quarto-table-cell-role="th">ABYSTAND</th>
<th data-quarto-table-cell-role="th">Purchase</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">5817</td>
<td>36</td>
<td>1</td>
<td>1</td>
<td>2</td>
<td>8</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>2</td>
<td>1</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>No</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5818</td>
<td>35</td>
<td>1</td>
<td>4</td>
<td>4</td>
<td>8</td>
<td>1</td>
<td>4</td>
<td>1</td>
<td>4</td>
<td>6</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>No</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5819</td>
<td>33</td>
<td>1</td>
<td>3</td>
<td>4</td>
<td>8</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>3</td>
<td>5</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>Yes</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">5820</td>
<td>34</td>
<td>1</td>
<td>3</td>
<td>2</td>
<td>8</td>
<td>0</td>
<td>7</td>
<td>0</td>
<td>2</td>
<td>7</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>No</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">5821</td>
<td>33</td>
<td>1</td>
<td>3</td>
<td>3</td>
<td>8</td>
<td>0</td>
<td>6</td>
<td>1</td>
<td>2</td>
<td>7</td>
<td>...</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>0</td>
<td>No</td>
</tr>
</tbody>
</table>


<p>5 rows × 86 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-7d0d31e5-ae7e-4ab7-82d3-5fe122ae3698')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-7d0d31e5-ae7e-4ab7-82d3-5fe122ae3698 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-7d0d31e5-ae7e-4ab7-82d3-5fe122ae3698');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>Because the KNN classifier predicts the class of a given test observation by identifying the observations that are nearest to it, the scale of the variables matters. Variables that are on a large scale will have a much larger effect on the <em>distance</em> between the observations, and hence on the KNN classifier, than variables that are on a small scale. For instance, imagine a data set that contains two variables, <code>salary</code> and <code>age</code> (measured in dollars and years, respectively). As far as KNN is concerned, a difference of <span class="math inline">\(1,000\)</span> in salary is enormous compared to a difference of <span class="math inline">\(50\)</span> years in age. Consequently, <code>salary</code> will drive the KNN classification results, and <code>age</code> will have almost no effect. This is contrary to our intuition that a salary difference of <span class="math inline">\(1,000\)</span> is quite small compared to an age difference of <span class="math inline">\(50\)</span> years.</p>
<p>Furthermore, the importance of scale to the KNN classifier leads to another issue: if we measured <code>salary</code> in Japanese yen, or if we measured <code>age</code> in minutes, then we’d get quite different classification results from what we get if these two variables are measured in dollars and years.</p>
<p>A good way to handle this problem is to the data so that all variables are given a mean of zero and a standard deviation of one. Then all variables will be on a comparable scale. The <code>scale()</code> function does just this. In standardizing the data, we exclude column <code>Purchase</code> variable.</p>
<div class="cell" data-outputid="9043454e-832e-4c20-8266-2d8e8b081ccc" data-execution_count="53">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1"></a><span class="co"># From a sample of means if the observations it can be seen that the variables falls in different ranges</span></span>
<span id="cb96-2"><a href="#cb96-2"></a><span class="co"># We want all the variables to have a same range. </span></span>
<span id="cb96-3"><a href="#cb96-3"></a>Caravan.mean()[:<span class="dv">5</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:3: FutureWarning: Dropping of nuisance columns in DataFrame reductions (with 'numeric_only=None') is deprecated; in a future version this will raise TypeError.  Select only valid columns before calling the reduction.
  This is separate from the ipykernel package so we can avoid doing imports until</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="53">
<pre><code>MOSTYPE     24.253349
MAANTHUI     1.110615
MGEMOMV      2.678805
MGEMLEEF     2.991240
MOSHOOFD     5.773617
dtype: float64</code></pre>
</div>
</div>
<div class="cell" data-outputid="194e75b4-4334-4eb8-a582-fdd31414a9c5" data-execution_count="54">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1"></a>y <span class="op">=</span> Caravan.Purchase</span>
<span id="cb99-2"><a href="#cb99-2"></a>X <span class="op">=</span> Caravan.drop(<span class="st">'Purchase'</span>, axis<span class="op">=</span><span class="dv">1</span>).astype(<span class="st">'float64'</span>)</span>
<span id="cb99-3"><a href="#cb99-3"></a>X_scaled <span class="op">=</span> scale(X)</span>
<span id="cb99-4"><a href="#cb99-4"></a>X_scaled.std(axis<span class="op">=</span><span class="dv">0</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="54">
<pre><code>array([1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
       1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
       1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
       1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
       1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.])</code></pre>
</div>
</div>
<p>Now every column has a standard deviation of one and a mean of zero.</p>
<p>We now split the observations into a test set, containing the first 1,000 observations, and a training set, containing the remaining observations. We fit a KNN model on the training data using <span class="math inline">\(K=1\)</span>, and evaluate its performance on the test data.</p>
<div class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1"></a>X_train <span class="op">=</span> X_scaled[<span class="dv">1000</span>:,:]</span>
<span id="cb101-2"><a href="#cb101-2"></a>y_train <span class="op">=</span> y[<span class="dv">1000</span>:]</span>
<span id="cb101-3"><a href="#cb101-3"></a></span>
<span id="cb101-4"><a href="#cb101-4"></a>X_test <span class="op">=</span> X_scaled[:<span class="dv">1000</span>,:]</span>
<span id="cb101-5"><a href="#cb101-5"></a>y_test <span class="op">=</span> y[:<span class="dv">1000</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="3bf39b59-92fe-4329-f5e6-6dc2f47f4fd3" data-execution_count="56">
<div class="sourceCode cell-code" id="cb102"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb102-1"><a href="#cb102-1"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">1</span>)   <span class="co"># K=1</span></span>
<span id="cb102-2"><a href="#cb102-2"></a>knn.fit(X_train, y_train)</span>
<span id="cb102-3"><a href="#cb102-3"></a></span>
<span id="cb102-4"><a href="#cb102-4"></a>y_pred <span class="op">=</span> knn.predict(X_test)   <span class="co"># returns class label </span></span>
<span id="cb102-5"><a href="#cb102-5"></a><span class="bu">print</span>(<span class="st">"Test set error rate: "</span>, (y_test <span class="op">!=</span> y_pred).mean() )    <span class="co"># manual calculatin</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Test set error rate:  0.118</code></pre>
</div>
</div>
<p>The KNN error rate on the 1,000 test observations is just under 12%. At first glance, this may appear to be fairly good. However, since only 6% of customers purchased insurance, we could get the error rate down to 6% by always predicting <span class="math inline">\({\tt No}\)</span> regardless of the values of the predictors!</p>
<p>Suppose that there is some non-trivial cost to trying to sell insurance to a given individual. For instance, perhaps a salesperson must visit each potential customer. If the company tries to sell insurance to a random selection of customers, then the success rate will be only 6%, which may be far too low given the costs involved.</p>
<p>Instead, the company would like to try to sell insurance only to customers who are likely to buy it. So the overall error rate is not of interest. Instead, the fraction of individuals that are correctly predicted to buy insurance is of interest.</p>
<p>It turns out that KNN with <span class="math inline">\(K = 1\)</span> does far better than random guessing among the customers that are predicted to buy insurance.</p>
<div class="cell" data-outputid="da21f115-35e1-4c7b-f97c-3788886f564b" data-execution_count="57">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb104-2"><a href="#cb104-2"></a><span class="bu">print</span>(cm)</span>
<span id="cb104-3"><a href="#cb104-3"></a>cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[873  68]
 [ 50   9]]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="57">
<pre><code>0.11688311688311688</code></pre>
</div>
</div>
<p>Among <span class="math inline">\(77\)</span> such customers, <span class="math inline">\(9\)</span>, or <span class="math inline">\(11.7\)</span>,%, actually do purchase insurance. This is double the rate that one would obtain from random guessing.</p>
<p>Using <span class="math inline">\(K=3\)</span>, the success rate increases to <span class="math inline">\(20\)</span>,%, and with <span class="math inline">\(K=5\)</span> the rate is <span class="math inline">\(26.7\)</span>,%. This is over four times the rate that results from random guessing. It appears that KNN is finding some real patterns in a difficult data set!</p>
<div class="cell" data-outputid="f903fc50-c66b-4c04-e61d-cd369e2a7bc4" data-execution_count="58">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">3</span>)   <span class="co"># K=1</span></span>
<span id="cb107-2"><a href="#cb107-2"></a>knn.fit(X_train, y_train)</span>
<span id="cb107-3"><a href="#cb107-3"></a></span>
<span id="cb107-4"><a href="#cb107-4"></a>y_pred <span class="op">=</span> knn.predict(X_test)   <span class="co"># returns class label </span></span>
<span id="cb107-5"><a href="#cb107-5"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb107-6"><a href="#cb107-6"></a><span class="bu">print</span>(cm)</span>
<span id="cb107-7"><a href="#cb107-7"></a><span class="bu">print</span>(cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>]))</span>
<span id="cb107-8"><a href="#cb107-8"></a></span>
<span id="cb107-9"><a href="#cb107-9"></a>knn <span class="op">=</span> KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">5</span>)   <span class="co"># K=1</span></span>
<span id="cb107-10"><a href="#cb107-10"></a>knn.fit(X_train, y_train)</span>
<span id="cb107-11"><a href="#cb107-11"></a></span>
<span id="cb107-12"><a href="#cb107-12"></a>y_pred <span class="op">=</span> knn.predict(X_test)   <span class="co"># returns class label </span></span>
<span id="cb107-13"><a href="#cb107-13"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb107-14"><a href="#cb107-14"></a><span class="bu">print</span>(cm)</span>
<span id="cb107-15"><a href="#cb107-15"></a>cm[<span class="dv">1</span>,<span class="dv">1</span>]<span class="op">/</span>(cm[<span class="dv">0</span>,<span class="dv">1</span>]<span class="op">+</span>cm[<span class="dv">1</span>,<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[921  20]
 [ 54   5]]
0.2
[[930  11]
 [ 55   4]]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="58">
<pre><code>0.26666666666666666</code></pre>
</div>
</div>
<p>However, while this strategy is cost-effective, it is worth noting that only 15 customers are predicted to purchase insurance using KNN with <span class="math inline">\(K=5\)</span>. In practice, the insurance company may wish to expend resources on convincing more than just 15 potential customers to buy insurance.</p>
<p>As a comparison, we can also fit a logistic regression model to the data. If we use <span class="math inline">\(0.5\)</span> as the predicted probability cut-off for the classifier, then we have a problem: only seven of the test observations are predicted to purchase insurance. Even worse, we are wrong about all of these! However, we are not required to use a cut-off of <span class="math inline">\(0.5\)</span>. If we instead predict a purchase any time the predicted probability of purchase exceeds <span class="math inline">\(0.25\)</span>, we get much better results: we predict that 33 people will purchase insurance, and we are correct for about <span class="math inline">\(33\)</span>,% of these people. This is over five times better than random guessing!</p>
<div class="cell" data-outputid="78405c96-109f-4505-8f3c-4270849c6eaa" data-execution_count="59">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1"></a>log_reg <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'newton-cg'</span>, C<span class="op">=</span><span class="fl">1e9</span>)</span>
<span id="cb110-2"><a href="#cb110-2"></a>log_reg.fit(X_train, y_train)</span>
<span id="cb110-3"><a href="#cb110-3"></a></span>
<span id="cb110-4"><a href="#cb110-4"></a>y_pred <span class="op">=</span> log_reg.predict(X_test)  <span class="co"># returns class labels based on threshold=0.5</span></span>
<span id="cb110-5"><a href="#cb110-5"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_pred)</span>
<span id="cb110-6"><a href="#cb110-6"></a><span class="bu">print</span>(cm)</span>
<span id="cb110-7"><a href="#cb110-7"></a>TP <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb110-8"><a href="#cb110-8"></a>TN <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb110-9"><a href="#cb110-9"></a>FP <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb110-10"><a href="#cb110-10"></a>FN <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb110-11"><a href="#cb110-11"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, (TP<span class="op">+</span>TN) <span class="op">/</span> (TP<span class="op">+</span>TN<span class="op">+</span>FP<span class="op">+</span>FN) )</span>
<span id="cb110-12"><a href="#cb110-12"></a><span class="bu">print</span>(<span class="st">"Sensitivity(Recall): "</span>,  TP <span class="op">/</span> (FN <span class="op">+</span> TP) )</span>
<span id="cb110-13"><a href="#cb110-13"></a><span class="bu">print</span>(<span class="st">"Precision: "</span>,  TP <span class="op">/</span> (FP <span class="op">+</span> TP) )</span>
<span id="cb110-14"><a href="#cb110-14"></a><span class="bu">print</span>(<span class="st">"False Positive Rate: "</span>,  FP <span class="op">/</span> (FP <span class="op">+</span> TN) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[934   7]
 [ 59   0]]
Accuracy:  0.934
Sensitivity(Recall):  0.0
Precision:  0.0
False Positive Rate:  0.007438894792773645</code></pre>
</div>
</div>
<div class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1"></a>y_pred_prob <span class="op">=</span> log_reg.predict_proba(X_test)   <span class="co"># returns prob of class labels</span></span>
<span id="cb112-2"><a href="#cb112-2"></a>y_pred_sensitized <span class="op">=</span> [<span class="st">'Yes'</span> <span class="cf">if</span> prob<span class="op">&gt;</span><span class="fl">0.25</span> <span class="cf">else</span> <span class="st">'No'</span> <span class="cf">for</span> prob <span class="kw">in</span> y_pred_prob[:,<span class="dv">1</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="03c89886-5ae2-46e1-d1fc-0235a5c35c0d" data-execution_count="61">
<div class="sourceCode cell-code" id="cb113"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb113-1"><a href="#cb113-1"></a>cm <span class="op">=</span> confusion_matrix(y_test, y_pred_sensitized)</span>
<span id="cb113-2"><a href="#cb113-2"></a><span class="bu">print</span>(cm)</span>
<span id="cb113-3"><a href="#cb113-3"></a></span>
<span id="cb113-4"><a href="#cb113-4"></a>TP <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb113-5"><a href="#cb113-5"></a>TN <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb113-6"><a href="#cb113-6"></a>FP <span class="op">=</span> cm[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb113-7"><a href="#cb113-7"></a>FN <span class="op">=</span> cm[<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb113-8"><a href="#cb113-8"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, (TP<span class="op">+</span>TN) <span class="op">/</span> (TP<span class="op">+</span>TN<span class="op">+</span>FP<span class="op">+</span>FN) )</span>
<span id="cb113-9"><a href="#cb113-9"></a><span class="bu">print</span>(<span class="st">"Sensitivity(Recall): "</span>,  TP <span class="op">/</span> (FN <span class="op">+</span> TP) )</span>
<span id="cb113-10"><a href="#cb113-10"></a><span class="bu">print</span>(<span class="st">"Precision: "</span>,  TP <span class="op">/</span> (FP <span class="op">+</span> TP) )</span>
<span id="cb113-11"><a href="#cb113-11"></a><span class="bu">print</span>(<span class="st">"False Positive Rate: "</span>,  FP <span class="op">/</span> (FP <span class="op">+</span> TN) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[919  22]
 [ 48  11]]
Accuracy:  0.93
Sensitivity(Recall):  0.1864406779661017
Precision:  0.3333333333333333
False Positive Rate:  0.023379383634431455</code></pre>
</div>
</div>
</section>
<section id="poisson-regression" class="level2" data-number="4.7">
<h2 data-number="4.7" class="anchored" data-anchor-id="poisson-regression"><span class="header-section-number">4.7</span> Poisson Regression</h2>
<p>Finally, we fit a Poisson regression model to the <code>Bikeshare</code> data set, which measures the number of bike rentals (<code>bikers</code>) per hour in Washington, DC. The data can be found in the <code>ISLR2</code> library.</p>
<div class="cell" data-outputid="50bc9ef0-bb4d-4789-b02c-b4ad7e28160a">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1"></a>Bikeshare <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Bikeshare.csv'</span>, index_col<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb115-2"><a href="#cb115-2"></a>Bikeshare.index <span class="op">=</span> Bikeshare.index <span class="op">-</span> <span class="dv">1</span> </span>
<span id="cb115-3"><a href="#cb115-3"></a><span class="bu">print</span>(Bikeshare.shape)</span>
<span id="cb115-4"><a href="#cb115-4"></a><span class="bu">print</span>(Bikeshare.columns)</span>
<span id="cb115-5"><a href="#cb115-5"></a><span class="co"># Only around 6% of the people purchased the insurance</span></span>
<span id="cb115-6"><a href="#cb115-6"></a>Bikeshare.tail()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(8645, 15)
Index(['season', 'mnth', 'day', 'hr', 'holiday', 'weekday', 'workingday',
       'weathersit', 'temp', 'atemp', 'hum', 'windspeed', 'casual',
       'registered', 'bikers'],
      dtype='object')</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="64">

  <div id="df-49191b3c-0ce5-4db1-9e6c-b80773e74685">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">season</th>
<th data-quarto-table-cell-role="th">mnth</th>
<th data-quarto-table-cell-role="th">day</th>
<th data-quarto-table-cell-role="th">hr</th>
<th data-quarto-table-cell-role="th">holiday</th>
<th data-quarto-table-cell-role="th">weekday</th>
<th data-quarto-table-cell-role="th">workingday</th>
<th data-quarto-table-cell-role="th">weathersit</th>
<th data-quarto-table-cell-role="th">temp</th>
<th data-quarto-table-cell-role="th">atemp</th>
<th data-quarto-table-cell-role="th">hum</th>
<th data-quarto-table-cell-role="th">windspeed</th>
<th data-quarto-table-cell-role="th">casual</th>
<th data-quarto-table-cell-role="th">registered</th>
<th data-quarto-table-cell-role="th">bikers</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">8640</td>
<td>1</td>
<td>Dec</td>
<td>365</td>
<td>19</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>clear</td>
<td>0.42</td>
<td>0.4242</td>
<td>0.54</td>
<td>0.2239</td>
<td>19</td>
<td>73</td>
<td>92</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8641</td>
<td>1</td>
<td>Dec</td>
<td>365</td>
<td>20</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>clear</td>
<td>0.42</td>
<td>0.4242</td>
<td>0.54</td>
<td>0.2239</td>
<td>8</td>
<td>63</td>
<td>71</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8642</td>
<td>1</td>
<td>Dec</td>
<td>365</td>
<td>21</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>clear</td>
<td>0.40</td>
<td>0.4091</td>
<td>0.58</td>
<td>0.1940</td>
<td>2</td>
<td>50</td>
<td>52</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">8643</td>
<td>1</td>
<td>Dec</td>
<td>365</td>
<td>22</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>clear</td>
<td>0.38</td>
<td>0.3939</td>
<td>0.62</td>
<td>0.1343</td>
<td>2</td>
<td>36</td>
<td>38</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">8644</td>
<td>1</td>
<td>Dec</td>
<td>365</td>
<td>23</td>
<td>0</td>
<td>6</td>
<td>0</td>
<td>clear</td>
<td>0.36</td>
<td>0.3788</td>
<td>0.66</td>
<td>0.0000</td>
<td>4</td>
<td>27</td>
<td>31</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-49191b3c-0ce5-4db1-9e6c-b80773e74685')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-49191b3c-0ce5-4db1-9e6c-b80773e74685 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-49191b3c-0ce5-4db1-9e6c-b80773e74685');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>We begin by fitting a least squares linear regression model to the data.</p>
<div class="cell" data-outputid="ecc79937-9d14-4440-f0a9-19c02b720307">
<div class="sourceCode cell-code" id="cb117"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb117-1"><a href="#cb117-1"></a>Bikeshare.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 8645 entries, 0 to 8644
Data columns (total 15 columns):
 #   Column      Non-Null Count  Dtype  
---  ------      --------------  -----  
 0   season      8645 non-null   int64  
 1   mnth        8645 non-null   object 
 2   day         8645 non-null   int64  
 3   hr          8645 non-null   int64  
 4   holiday     8645 non-null   int64  
 5   weekday     8645 non-null   int64  
 6   workingday  8645 non-null   int64  
 7   weathersit  8645 non-null   object 
 8   temp        8645 non-null   float64
 9   atemp       8645 non-null   float64
 10  hum         8645 non-null   float64
 11  windspeed   8645 non-null   float64
 12  casual      8645 non-null   int64  
 13  registered  8645 non-null   int64  
 14  bikers      8645 non-null   int64  
dtypes: float64(4), int64(9), object(2)
memory usage: 1.1+ MB</code></pre>
</div>
</div>
<div class="cell" data-outputid="6098b36d-69f6-4bb2-beb2-ecc5bf920c54">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1"></a>Bikeshare[<span class="st">'hr'</span>] <span class="op">=</span> Bikeshare[<span class="st">'hr'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb119-2"><a href="#cb119-2"></a>Bikeshare[<span class="st">'mnth'</span>] <span class="op">=</span> Bikeshare[<span class="st">'mnth'</span>].astype(<span class="st">'category'</span>)</span>
<span id="cb119-3"><a href="#cb119-3"></a>Bikeshare.info()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
Int64Index: 8645 entries, 0 to 8644
Data columns (total 15 columns):
 #   Column      Non-Null Count  Dtype   
---  ------      --------------  -----   
 0   season      8645 non-null   int64   
 1   mnth        8645 non-null   category
 2   day         8645 non-null   int64   
 3   hr          8645 non-null   category
 4   holiday     8645 non-null   int64   
 5   weekday     8645 non-null   int64   
 6   workingday  8645 non-null   int64   
 7   weathersit  8645 non-null   object  
 8   temp        8645 non-null   float64 
 9   atemp       8645 non-null   float64 
 10  hum         8645 non-null   float64 
 11  windspeed   8645 non-null   float64 
 12  casual      8645 non-null   int64   
 13  registered  8645 non-null   int64   
 14  bikers      8645 non-null   int64   
dtypes: category(2), float64(4), int64(8), object(1)
memory usage: 963.5+ KB</code></pre>
</div>
</div>
<div class="cell" data-outputid="39065348-05a5-4420-e106-8cbc88cf9d07">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1"></a><span class="bu">print</span>(Bikeshare.mnth)</span>
<span id="cb121-2"><a href="#cb121-2"></a>levels <span class="op">=</span> Bikeshare.mnth.unique()</span>
<span id="cb121-3"><a href="#cb121-3"></a>levels</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>0       Jan
1       Jan
2       Jan
3       Jan
4       Jan
       ... 
8640    Dec
8641    Dec
8642    Dec
8643    Dec
8644    Dec
Name: mnth, Length: 8645, dtype: category
Categories (12, object): ['April', 'Aug', 'Dec', 'Feb', ..., 'May', 'Nov', 'Oct', 'Sept']</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="67">
<pre><code>['Jan', 'Feb', 'March', 'April', 'May', ..., 'Aug', 'Sept', 'Oct', 'Nov', 'Dec']
Length: 12
Categories (12, object): ['April', 'Aug', 'Dec', 'Feb', ..., 'May', 'Nov', 'Oct', 'Sept']</code></pre>
</div>
</div>
<div class="cell" data-outputid="50510085-54fe-49b7-efe3-f42b126428b4">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1"></a>Bikeshare.mnth.cat.reorder_categories(levels, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb124-2"><a href="#cb124-2"></a>Bikeshare.mnth</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/ipykernel_launcher.py:1: FutureWarning: The `inplace` parameter in pandas.Categorical.reorder_categories is deprecated and will be removed in a future version. Reordering categories will always return a new Categorical object.
  """Entry point for launching an IPython kernel.</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="68">
<pre><code>0       Jan
1       Jan
2       Jan
3       Jan
4       Jan
       ... 
8640    Dec
8641    Dec
8642    Dec
8643    Dec
8644    Dec
Name: mnth, Length: 8645, dtype: category
Categories (12, object): ['April', 'Aug', 'Dec', 'Feb', ..., 'May', 'Nov', 'Oct', 'Sept']</code></pre>
</div>
</div>
<p>Here, we use Jan and 0 as baseline</p>
<div class="cell" data-outputid="b5e4b5f4-0e83-4819-f77f-23dfeee36bf0">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1"></a><span class="co"># Note double quote is needed fot the reference string!</span></span>
<span id="cb127-2"><a href="#cb127-2"></a>est <span class="op">=</span> smf.ols(<span class="st">'bikers ~ C(mnth, Treatment("Jan")) + C(hr, Treatment(0)) + workingday + temp + weathersit'</span>,data <span class="op">=</span> Bikeshare).fit()</span>
<span id="cb127-3"><a href="#cb127-3"></a><span class="bu">print</span>(est.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                 bikers   R-squared:                       0.675
Model:                            OLS   Adj. R-squared:                  0.673
Method:                 Least Squares   F-statistic:                     457.3
Date:                Sun, 25 Sep 2022   Prob (F-statistic):               0.00
Time:                        08:38:33   Log-Likelihood:                -49743.
No. Observations:                8645   AIC:                         9.957e+04
Df Residuals:                    8605   BIC:                         9.985e+04
Df Model:                          39                                         
Covariance Type:            nonrobust                                         
======================================================================================================
                                         coef    std err          t      P&gt;|t|      [0.025      0.975]
------------------------------------------------------------------------------------------------------
Intercept                            -68.6317      5.307    -12.932      0.000     -79.035     -58.229
C(mnth, Treatment("Jan"))[T.April]    41.4249      4.972      8.331      0.000      31.678      51.172
C(mnth, Treatment("Jan"))[T.Aug]      53.2430      6.640      8.019      0.000      40.227      66.259
C(mnth, Treatment("Jan"))[T.Dec]      46.4577      4.271     10.878      0.000      38.086      54.829
C(mnth, Treatment("Jan"))[T.Feb]       6.8452      4.287      1.597      0.110      -1.559      15.250
C(mnth, Treatment("Jan"))[T.July]     45.3245      7.081      6.401      0.000      31.444      59.205
C(mnth, Treatment("Jan"))[T.June]     67.8187      6.544     10.364      0.000      54.992      80.646
C(mnth, Treatment("Jan"))[T.March]    16.5514      4.301      3.848      0.000       8.120      24.983
C(mnth, Treatment("Jan"))[T.May]      72.5571      5.641     12.862      0.000      61.499      83.615
C(mnth, Treatment("Jan"))[T.Nov]      60.3100      4.610     13.083      0.000      51.273      69.347
C(mnth, Treatment("Jan"))[T.Oct]      75.8343      4.950     15.319      0.000      66.130      85.538
C(mnth, Treatment("Jan"))[T.Sept]     66.6783      5.925     11.254      0.000      55.064      78.293
C(hr, Treatment(0))[T.1]             -14.5793      5.699     -2.558      0.011     -25.750      -3.408
C(hr, Treatment(0))[T.2]             -21.5791      5.733     -3.764      0.000     -32.817     -10.341
C(hr, Treatment(0))[T.3]             -31.1408      5.778     -5.389      0.000     -42.468     -19.814
C(hr, Treatment(0))[T.4]             -36.9075      5.802     -6.361      0.000     -48.281     -25.534
C(hr, Treatment(0))[T.5]             -24.1355      5.737     -4.207      0.000     -35.381     -12.890
C(hr, Treatment(0))[T.6]              20.5997      5.704      3.612      0.000       9.419      31.781
C(hr, Treatment(0))[T.7]             120.0931      5.693     21.095      0.000     108.934     131.253
C(hr, Treatment(0))[T.8]             223.6619      5.690     39.310      0.000     212.509     234.815
C(hr, Treatment(0))[T.9]             120.5819      5.693     21.182      0.000     109.423     131.741
C(hr, Treatment(0))[T.10]             83.8013      5.705     14.689      0.000      72.618      94.985
C(hr, Treatment(0))[T.11]            105.4234      5.722     18.424      0.000      94.207     116.640
C(hr, Treatment(0))[T.12]            137.2837      5.740     23.916      0.000     126.032     148.536
C(hr, Treatment(0))[T.13]            136.0359      5.760     23.617      0.000     124.745     147.327
C(hr, Treatment(0))[T.14]            126.6361      5.776     21.923      0.000     115.313     137.959
C(hr, Treatment(0))[T.15]            132.0865      5.780     22.852      0.000     120.756     143.417
C(hr, Treatment(0))[T.16]            178.5206      5.772     30.927      0.000     167.206     189.836
C(hr, Treatment(0))[T.17]            296.2670      5.749     51.537      0.000     284.998     307.536
C(hr, Treatment(0))[T.18]            269.4409      5.736     46.976      0.000     258.198     280.684
C(hr, Treatment(0))[T.19]            186.2558      5.714     32.596      0.000     175.055     197.457
C(hr, Treatment(0))[T.20]            125.5492      5.704     22.012      0.000     114.369     136.730
C(hr, Treatment(0))[T.21]             87.5537      5.693     15.378      0.000      76.393      98.714
C(hr, Treatment(0))[T.22]             59.1226      5.689     10.392      0.000      47.970      70.275
C(hr, Treatment(0))[T.23]             26.8376      5.688      4.719      0.000      15.688      37.987
weathersit[T.cloudy/misty]           -12.8903      1.964     -6.562      0.000     -16.741      -9.040
weathersit[T.heavy rain/snow]       -109.7446     76.667     -1.431      0.152    -260.031      40.542
weathersit[T.light rain/snow]        -66.4944      2.965    -22.425      0.000     -72.307     -60.682
workingday                             1.2696      1.784      0.711      0.477      -2.228       4.768
temp                                 157.2094     10.261     15.321      0.000     137.095     177.324
==============================================================================
Omnibus:                      288.526   Durbin-Watson:                   0.519
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              518.512
Skew:                           0.273   Prob(JB):                    2.55e-113
Kurtosis:                       4.068   Cond. No.                         131.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</code></pre>
</div>
</div>
<p>In <code>ols</code>, the first level of <code>hr</code> (0) and <code>mnth</code> (Jan) are treated as the baseline values by specifying the reference and explicity cated to categorical variable. Therefore, no coefficient estimates are provided for them: implicitly, their coefficient estimates are zero, and all other levels are measured relative to these baselines. For example, the Feb coefficient of <span class="math inline">\(6.845\)</span> signifies that, holding all other variables constant, there are on average about 7 more riders in February than in January. Similarly there are about 16.5 more riders in March than in January.</p>
<p><a href="https://github.com/statsmodels/statsmodels/blob/main/examples/python/contrasts.py">https://github.com/statsmodels/statsmodels/blob/main/examples/python/contrasts.py</a>.</p>
<p>The results seen in Section 4.6.1 used a slightly different coding of the variables <code>hr</code> and <code>mnth</code>, as follows:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1"></a><span class="im">from</span> patsy.contrasts <span class="im">import</span> Sum</span>
<span id="cb129-2"><a href="#cb129-2"></a>contrast1 <span class="op">=</span> Sum().code_without_intercept(<span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">24</span>)))</span>
<span id="cb129-3"><a href="#cb129-3"></a><span class="co">#print(contrast.matrix)</span></span>
<span id="cb129-4"><a href="#cb129-4"></a>contrast2 <span class="op">=</span> Sum().code_without_intercept(<span class="bu">list</span>(<span class="bu">range</span>(<span class="dv">12</span>)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="1d81da20-3422-41ff-d7b5-a358aabf9858">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1"></a>est2 <span class="op">=</span> smf.ols(<span class="st">'bikers ~ C(mnth, contrast2) + C(hr, contrast1) + workingday + temp + weathersit'</span>,data <span class="op">=</span> Bikeshare).fit()</span>
<span id="cb130-2"><a href="#cb130-2"></a><span class="bu">print</span>(est2.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                            OLS Regression Results                            
==============================================================================
Dep. Variable:                 bikers   R-squared:                       0.675
Model:                            OLS   Adj. R-squared:                  0.673
Method:                 Least Squares   F-statistic:                     457.3
Date:                Sun, 25 Sep 2022   Prob (F-statistic):               0.00
Time:                        08:38:34   Log-Likelihood:                -49743.
No. Observations:                8645   AIC:                         9.957e+04
Df Residuals:                    8605   BIC:                         9.985e+04
Df Model:                          39                                         
Covariance Type:            nonrobust                                         
=================================================================================================
                                    coef    std err          t      P&gt;|t|      [0.025      0.975]
-------------------------------------------------------------------------------------------------
Intercept                        73.5974      5.132     14.340      0.000      63.537      83.658
C(mnth, contrast2)[S.0]          -4.6622      2.741     -1.701      0.089     -10.034       0.710
C(mnth, contrast2)[S.1]           7.1560      3.535      2.024      0.043       0.227      14.085
C(mnth, contrast2)[S.2]           0.3706      3.156      0.117      0.907      -5.816       6.558
C(mnth, contrast2)[S.3]         -39.2419      3.539    -11.088      0.000     -46.179     -32.304
C(mnth, contrast2)[S.4]         -46.0871      4.085    -11.281      0.000     -54.096     -38.079
C(mnth, contrast2)[S.5]          -0.7626      3.908     -0.195      0.845      -8.424       6.899
C(mnth, contrast2)[S.6]          21.7317      3.465      6.272      0.000      14.939      28.524
C(mnth, contrast2)[S.7]         -29.5357      3.155     -9.361      0.000     -35.721     -23.351
C(mnth, contrast2)[S.8]          26.4700      2.851      9.285      0.000      20.882      32.058
C(mnth, contrast2)[S.9]          14.2229      2.860      4.972      0.000       8.616      19.830
C(mnth, contrast2)[S.10]         29.7472      2.700     11.019      0.000      24.455      35.039
C(hr, contrast1)[S.0]           -96.1420      3.955    -24.307      0.000    -103.895     -88.389
C(hr, contrast1)[S.1]          -110.7213      3.966    -27.916      0.000    -118.496    -102.947
C(hr, contrast1)[S.2]          -117.7212      4.016    -29.310      0.000    -125.594    -109.848
C(hr, contrast1)[S.3]          -127.2828      4.081    -31.191      0.000    -135.282    -119.283
C(hr, contrast1)[S.4]          -133.0495      4.117    -32.319      0.000    -141.119    -124.980
C(hr, contrast1)[S.5]          -120.2775      4.037    -29.794      0.000    -128.191    -112.364
C(hr, contrast1)[S.6]           -75.5424      3.992    -18.925      0.000     -83.367     -67.718
C(hr, contrast1)[S.7]            23.9511      3.969      6.035      0.000      16.172      31.730
C(hr, contrast1)[S.8]           127.5199      3.950     32.284      0.000     119.777     135.263
C(hr, contrast1)[S.9]            24.4399      3.936      6.209      0.000      16.724      32.155
C(hr, contrast1)[S.10]          -12.3407      3.936     -3.135      0.002     -20.056      -4.625
C(hr, contrast1)[S.11]            9.2814      3.945      2.353      0.019       1.549      17.014
C(hr, contrast1)[S.12]           41.1417      3.957     10.397      0.000      33.385      48.899
C(hr, contrast1)[S.13]           39.8939      3.975     10.036      0.000      32.102      47.686
C(hr, contrast1)[S.14]           30.4940      3.991      7.641      0.000      22.671      38.317
C(hr, contrast1)[S.15]           35.9445      3.995      8.998      0.000      28.114      43.775
C(hr, contrast1)[S.16]           82.3786      3.988     20.655      0.000      74.561      90.197
C(hr, contrast1)[S.17]          200.1249      3.964     50.488      0.000     192.355     207.895
C(hr, contrast1)[S.18]          173.2989      3.956     43.806      0.000     165.544     181.054
C(hr, contrast1)[S.19]           90.1138      3.940     22.872      0.000      82.390      97.837
C(hr, contrast1)[S.20]           29.4071      3.936      7.471      0.000      21.691      37.123
C(hr, contrast1)[S.21]           -8.5883      3.933     -2.184      0.029     -16.298      -0.878
C(hr, contrast1)[S.22]          -37.0194      3.934     -9.409      0.000     -44.732     -29.307
weathersit[T.cloudy/misty]      -12.8903      1.964     -6.562      0.000     -16.741      -9.040
weathersit[T.heavy rain/snow]  -109.7446     76.667     -1.431      0.152    -260.031      40.542
weathersit[T.light rain/snow]   -66.4944      2.965    -22.425      0.000     -72.307     -60.682
workingday                        1.2696      1.784      0.711      0.477      -2.228       4.768
temp                            157.2094     10.261     15.321      0.000     137.095     177.324
==============================================================================
Omnibus:                      288.526   Durbin-Watson:                   0.519
Prob(Omnibus):                  0.000   Jarque-Bera (JB):              518.512
Skew:                           0.273   Prob(JB):                    2.55e-113
Kurtosis:                       4.068   Cond. No.                         127.
==============================================================================

Notes:
[1] Standard Errors assume that the covariance matrix of the errors is correctly specified.</code></pre>
</div>
</div>
<p>What is the difference between the two codings? In <code>est2</code>, a coefficient estimate is reported for all but the last level of <code>hr</code> and <code>mnth</code>. Importantly, in <code>est2</code>, the coefficient estimate for the last level of <code>mnth</code> is not zero: instead, it equals the <em>negative of the sum of the coefficient estimates for all of the other levels</em>. Similarly, in <code>est2</code>, the coefficient estimate for the last level of <code>hr</code> is the negative of the sum of the coefficient estimates for all of the other levels. This means that the coefficients of <code>hr</code> and <code>mnth</code> in <code>est2</code> will always sum to zero, and can be interpreted as the difference from the mean level. For example, the coefficient for January of <span class="math inline">\(-46.087\)</span> indicates that, holding all other variables constant, there are typically 46 fewer riders in January relative to the yearly average.</p>
<p>It is important to realize that the choice of coding really does not matter, provided that we interpret the model output correctly in light of the coding used. For example, we see that the predictions from the linear model are the same regardless of coding:</p>
<div class="cell" data-outputid="06c73bae-ed47-4f5f-99f4-1575d594f966">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1"></a>np.<span class="bu">sum</span>((est.predict() <span class="op">-</span> est2.predict())<span class="op">**</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="72">
<pre><code>2.244830988197902e-20</code></pre>
</div>
</div>
<p>The sum of squared differences is zero. We can also see this using the <code>np.allclose()</code> function:</p>
<div class="cell" data-outputid="ca758788-2981-4a3c-a709-0c9759dd70c9">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1"></a>np.allclose(est.predict(), est2.predict())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>True</code></pre>
</div>
</div>
<p>To reproduce the left-hand side of Figure 4.13, we must first obtain the coefficient estimates associated with <code>mnth</code>. The coefficients for January through November can be obtained directly from the <code>est2</code> object. The coefficient for December must be explicitly computed as the negative sum of all the other months.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1"></a>y1 <span class="op">=</span> <span class="bu">list</span>(est2.params[<span class="dv">1</span>:<span class="dv">12</span>])</span>
<span id="cb136-2"><a href="#cb136-2"></a>y1.append(<span class="op">-</span>np.<span class="bu">sum</span>(est2.params[<span class="dv">1</span>:<span class="dv">12</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="b629b737-b5a7-46b7-9efe-c920358df082">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1"></a>ax <span class="op">=</span> sns.lineplot(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">13</span>), y<span class="op">=</span>y1, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb137-2"><a href="#cb137-2"></a>ax.set_xlabel(<span class="st">"Month"</span>)</span>
<span id="cb137-3"><a href="#cb137-3"></a>ax.set_ylabel(<span class="st">"Coefficien"</span>)</span>
<span id="cb137-4"><a href="#cb137-4"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">13</span>))</span>
<span id="cb137-5"><a href="#cb137-5"></a>ax.set_xticklabels([<span class="st">"J"</span>, <span class="st">"F"</span>, <span class="st">"M"</span>, <span class="st">"A"</span>, <span class="st">"M"</span>, <span class="st">"J"</span>, <span class="st">"J"</span>, <span class="st">"A"</span>, <span class="st">"S"</span>, <span class="st">"O"</span>, <span class="st">"N"</span>, <span class="st">"D"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>[Text(0, 0, 'J'),
 Text(0, 0, 'F'),
 Text(0, 0, 'M'),
 Text(0, 0, 'A'),
 Text(0, 0, 'M'),
 Text(0, 0, 'J'),
 Text(0, 0, 'J'),
 Text(0, 0, 'A'),
 Text(0, 0, 'S'),
 Text(0, 0, 'O'),
 Text(0, 0, 'N'),
 Text(0, 0, 'D')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-75-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Reproducing the right-hand side of Figure 4.13 follows a similar process.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1"></a>y2 <span class="op">=</span> <span class="bu">list</span>(est2.params[<span class="dv">12</span>:<span class="dv">35</span>])</span>
<span id="cb139-2"><a href="#cb139-2"></a>y2.append(<span class="op">-</span>np.<span class="bu">sum</span>(est2.params[<span class="dv">12</span>:<span class="dv">35</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="c0e204a5-28f3-47d4-d281-08eeab780a6b">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1"></a>ax <span class="op">=</span> sns.lineplot(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">25</span>), y<span class="op">=</span>y2, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb140-2"><a href="#cb140-2"></a>ax.set_xlabel(<span class="st">"Hour"</span>)</span>
<span id="cb140-3"><a href="#cb140-3"></a>ax.set_ylabel(<span class="st">"Coefficien"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="77">
<pre><code>Text(0, 0.5, 'Coefficien')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-77-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>Now, we consider instead fitting a Poisson regression model to the <code>Bikeshare</code> data. Very little changes, except that we now use the function <code>glm()</code> with the argument <code>families.Poisson</code> to specify that we wish to fit a Poisson regression model:</p>
<div class="cell" data-outputid="a2acbf52-fb15-400b-d995-40ca5af43ada">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1"></a>formula <span class="op">=</span> <span class="st">'bikers ~ C(mnth, contrast2) + C(hr, contrast1) + workingday + temp + weathersit'</span></span>
<span id="cb142-2"><a href="#cb142-2"></a>model <span class="op">=</span> smf.glm(formula<span class="op">=</span>formula, data<span class="op">=</span>Bikeshare, family<span class="op">=</span>sm.families.Poisson())</span>
<span id="cb142-3"><a href="#cb142-3"></a>result <span class="op">=</span> model.fit()</span>
<span id="cb142-4"><a href="#cb142-4"></a><span class="bu">print</span>(result.summary())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                 Generalized Linear Model Regression Results                  
==============================================================================
Dep. Variable:                 bikers   No. Observations:                 8645
Model:                            GLM   Df Residuals:                     8605
Model Family:                 Poisson   Df Model:                           39
Link Function:                    log   Scale:                          1.0000
Method:                          IRLS   Log-Likelihood:            -1.4054e+05
Date:                Sun, 25 Sep 2022   Deviance:                   2.2804e+05
Time:                        08:38:40   Pearson chi2:                 2.20e+05
No. Iterations:                     7                                         
Covariance Type:            nonrobust                                         
=================================================================================================
                                    coef    std err          z      P&gt;|z|      [0.025      0.975]
-------------------------------------------------------------------------------------------------
Intercept                         4.1182      0.006    683.963      0.000       4.106       4.130
C(mnth, contrast2)[S.0]           0.0215      0.003      6.888      0.000       0.015       0.028
C(mnth, contrast2)[S.1]           0.1512      0.004     41.281      0.000       0.144       0.158
C(mnth, contrast2)[S.2]           0.0167      0.004      4.390      0.000       0.009       0.024
C(mnth, contrast2)[S.3]          -0.4441      0.005    -91.379      0.000      -0.454      -0.435
C(mnth, contrast2)[S.4]          -0.6702      0.006   -113.445      0.000      -0.682      -0.659
C(mnth, contrast2)[S.5]           0.1036      0.004     25.121      0.000       0.096       0.112
C(mnth, contrast2)[S.6]           0.2232      0.004     62.818      0.000       0.216       0.230
C(mnth, contrast2)[S.7]          -0.2937      0.004    -70.886      0.000      -0.302      -0.286
C(mnth, contrast2)[S.8]           0.2405      0.003     82.462      0.000       0.235       0.246
C(mnth, contrast2)[S.9]           0.1503      0.003     47.248      0.000       0.144       0.156
C(mnth, contrast2)[S.10]          0.2676      0.003     96.091      0.000       0.262       0.273
C(hr, contrast1)[S.0]            -0.7544      0.008    -95.744      0.000      -0.770      -0.739
C(hr, contrast1)[S.1]            -1.2260      0.010   -123.173      0.000      -1.245      -1.206
C(hr, contrast1)[S.2]            -1.5631      0.012   -131.702      0.000      -1.586      -1.540
C(hr, contrast1)[S.3]            -2.1983      0.016   -133.846      0.000      -2.230      -2.166
C(hr, contrast1)[S.4]            -2.8305      0.023   -125.586      0.000      -2.875      -2.786
C(hr, contrast1)[S.5]            -1.8147      0.013   -134.775      0.000      -1.841      -1.788
C(hr, contrast1)[S.6]            -0.4299      0.007    -62.341      0.000      -0.443      -0.416
C(hr, contrast1)[S.7]             0.5752      0.004    130.544      0.000       0.567       0.584
C(hr, contrast1)[S.8]             1.0769      0.004    302.220      0.000       1.070       1.084
C(hr, contrast1)[S.9]             0.5818      0.004    135.727      0.000       0.573       0.590
C(hr, contrast1)[S.10]            0.3369      0.005     71.372      0.000       0.328       0.346
C(hr, contrast1)[S.11]            0.4941      0.004    112.494      0.000       0.486       0.503
C(hr, contrast1)[S.12]            0.6796      0.004    167.040      0.000       0.672       0.688
C(hr, contrast1)[S.13]            0.6736      0.004    164.722      0.000       0.666       0.682
C(hr, contrast1)[S.14]            0.6249      0.004    149.570      0.000       0.617       0.633
C(hr, contrast1)[S.15]            0.6538      0.004    158.205      0.000       0.646       0.662
C(hr, contrast1)[S.16]            0.8743      0.004    231.040      0.000       0.867       0.882
C(hr, contrast1)[S.17]            1.2946      0.003    397.848      0.000       1.288       1.301
C(hr, contrast1)[S.18]            1.2123      0.003    365.084      0.000       1.206       1.219
C(hr, contrast1)[S.19]            0.9140      0.004    247.065      0.000       0.907       0.921
C(hr, contrast1)[S.20]            0.6162      0.004    147.045      0.000       0.608       0.624
C(hr, contrast1)[S.21]            0.3642      0.005     78.173      0.000       0.355       0.373
C(hr, contrast1)[S.22]            0.1175      0.005     22.488      0.000       0.107       0.128
weathersit[T.cloudy/misty]       -0.0752      0.002    -34.528      0.000      -0.080      -0.071
weathersit[T.heavy rain/snow]    -0.9263      0.167     -5.554      0.000      -1.253      -0.599
weathersit[T.light rain/snow]    -0.5758      0.004   -141.905      0.000      -0.584      -0.568
workingday                        0.0147      0.002      7.502      0.000       0.011       0.018
temp                              0.7853      0.011     68.434      0.000       0.763       0.808
=================================================================================================</code></pre>
</div>
</div>
<p>We can plot the coefficients associated with <code>mnth</code> and <code>hr</code>, in order to reproduce Figure 4.15:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1"></a>y3 <span class="op">=</span> <span class="bu">list</span>(result.params[<span class="dv">1</span>:<span class="dv">12</span>])</span>
<span id="cb144-2"><a href="#cb144-2"></a>y3.append(<span class="op">-</span>np.<span class="bu">sum</span>(result.params[<span class="dv">1</span>:<span class="dv">12</span>]))</span>
<span id="cb144-3"><a href="#cb144-3"></a>y4 <span class="op">=</span> <span class="bu">list</span>(result.params[<span class="dv">12</span>:<span class="dv">35</span>])</span>
<span id="cb144-4"><a href="#cb144-4"></a>y4.append(<span class="op">-</span>np.<span class="bu">sum</span>(result.params[<span class="dv">12</span>:<span class="dv">35</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-outputid="a46fe209-7a17-45c7-f3f2-8cbb4b38c8c6">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1"></a>ax <span class="op">=</span> sns.lineplot(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">13</span>), y<span class="op">=</span>y3, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb145-2"><a href="#cb145-2"></a>ax.set_xlabel(<span class="st">"Month"</span>)</span>
<span id="cb145-3"><a href="#cb145-3"></a>ax.set_ylabel(<span class="st">"Coefficien"</span>)</span>
<span id="cb145-4"><a href="#cb145-4"></a>ax.set_xticks(<span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">13</span>))</span>
<span id="cb145-5"><a href="#cb145-5"></a>ax.set_xticklabels([<span class="st">"J"</span>, <span class="st">"F"</span>, <span class="st">"M"</span>, <span class="st">"A"</span>, <span class="st">"M"</span>, <span class="st">"J"</span>, <span class="st">"J"</span>, <span class="st">"A"</span>, <span class="st">"S"</span>, <span class="st">"O"</span>, <span class="st">"N"</span>, <span class="st">"D"</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>[Text(0, 0, 'J'),
 Text(0, 0, 'F'),
 Text(0, 0, 'M'),
 Text(0, 0, 'A'),
 Text(0, 0, 'M'),
 Text(0, 0, 'J'),
 Text(0, 0, 'J'),
 Text(0, 0, 'A'),
 Text(0, 0, 'S'),
 Text(0, 0, 'O'),
 Text(0, 0, 'N'),
 Text(0, 0, 'D')]</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-80-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="1ac6d5cb-1b89-42bc-8117-e4ee1d2e495c">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1"></a>ax <span class="op">=</span> sns.lineplot(x<span class="op">=</span><span class="bu">range</span>(<span class="dv">1</span>,<span class="dv">25</span>), y<span class="op">=</span>y4, marker<span class="op">=</span><span class="st">"o"</span>)</span>
<span id="cb147-2"><a href="#cb147-2"></a>ax.set_xlabel(<span class="st">"Hour"</span>)</span>
<span id="cb147-3"><a href="#cb147-3"></a>ax.set_ylabel(<span class="st">"Coefficien"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>Text(0, 0.5, 'Coefficien')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-81-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can once again use the <code>predict()</code> function to obtain the fitted values (predictions) from this Poisson regression model.</p>
<div class="cell" data-outputid="6ecbc18d-b13f-4a51-cda6-c2962488fa96">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1"></a><span class="bu">len</span>(result.predict())</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>8645</code></pre>
</div>
</div>
<div class="cell" data-outputid="3bfad8ab-86c4-4275-e191-8f77cbce8b7b">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1"></a>linear_p <span class="op">=</span> est2.predict()</span>
<span id="cb151-2"><a href="#cb151-2"></a>poisson_p <span class="op">=</span> result.predict()</span>
<span id="cb151-3"><a href="#cb151-3"></a>ax <span class="op">=</span> sns.lineplot(x<span class="op">=</span>linear_p, y<span class="op">=</span>poisson_p)</span>
<span id="cb151-4"><a href="#cb151-4"></a>ax.set_xlabel(<span class="st">"Linear prediction"</span>)</span>
<span id="cb151-5"><a href="#cb151-5"></a>ax.set_ylabel(<span class="st">"Poisson prediction"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="83">
<pre><code>Text(0, 0.5, 'Poisson prediction')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-83-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>The predictions from the Poisson regression model are correlated with those from the linear model; however, the former are non-negative. As a result the Poisson regression predictions tend to be larger than those from the linear model for either very low or very high levels of ridership.</p>
<p>In this section, we used the <code>glm()</code> function with the argument <code>families.Poisson</code> in order to perform Poisson regression. Earlier in this lab we used the <code>glm()</code> function with <code>families.Binomial</code> to perform logistic regression. Other choices for the <code>families</code> argument can be used to fit other types of GLMs. For instance, <code>families.Gamma</code> fits a gamma regression model.</p>
</section>
<section id="logistic-regression-in-sklearn" class="level2" data-number="4.8">
<h2 data-number="4.8" class="anchored" data-anchor-id="logistic-regression-in-sklearn"><span class="header-section-number">4.8</span> Logistic regression in Sklearn</h2>
<div class="cell" data-outputid="ba727f71-170e-40b9-83e9-5cc3cc4eea29" data-execution_count="68">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1"></a>Smarket[<span class="st">'Direction2'</span>] <span class="op">=</span> pd.get_dummies(Smarket.Direction, drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb153-2"><a href="#cb153-2"></a>Smarket.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="68">

  <div id="df-6ee4cf8f-2d90-480f-98fc-297d6fc6498d">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Year</th>
<th data-quarto-table-cell-role="th">Lag1</th>
<th data-quarto-table-cell-role="th">Lag2</th>
<th data-quarto-table-cell-role="th">Lag3</th>
<th data-quarto-table-cell-role="th">Lag4</th>
<th data-quarto-table-cell-role="th">Lag5</th>
<th data-quarto-table-cell-role="th">Volume</th>
<th data-quarto-table-cell-role="th">Today</th>
<th data-quarto-table-cell-role="th">Direction</th>
<th data-quarto-table-cell-role="th">Direction2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2001</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>5.010</td>
<td>1.1913</td>
<td>0.959</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2001</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>-1.055</td>
<td>1.2965</td>
<td>1.032</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2001</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>-2.624</td>
<td>1.4112</td>
<td>-0.623</td>
<td>Down</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2001</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>-0.192</td>
<td>1.2760</td>
<td>0.614</td>
<td>Up</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2001</td>
<td>0.614</td>
<td>-0.623</td>
<td>1.032</td>
<td>0.959</td>
<td>0.381</td>
<td>1.2057</td>
<td>0.213</td>
<td>Up</td>
<td>1</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-6ee4cf8f-2d90-480f-98fc-297d6fc6498d')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-6ee4cf8f-2d90-480f-98fc-297d6fc6498d button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-6ee4cf8f-2d90-480f-98fc-297d6fc6498d');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>C is a regularization term where a higher C indicates less penalty on the magnitude of the coefficients and. We set C to be arbitrarily high such that there is effectively no regulariation.</p>
<div class="cell" data-outputid="1e152ca7-d81a-4845-c932-b6ea4eb2920d" data-execution_count="69">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1"></a>X <span class="op">=</span> Smarket.loc[:, <span class="st">'Lag1'</span>:<span class="st">'Volume'</span>]</span>
<span id="cb154-2"><a href="#cb154-2"></a>y <span class="op">=</span> Smarket.Direction2</span>
<span id="cb154-3"><a href="#cb154-3"></a>logreg <span class="op">=</span> LogisticRegression(solver<span class="op">=</span><span class="st">'newton-cg'</span>, C<span class="op">=</span><span class="fl">1e42</span>)  <span class="co">#large C for no regularization</span></span>
<span id="cb154-4"><a href="#cb154-4"></a>logreg.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="69">
<pre><code>LogisticRegression(C=1e+42, solver='newton-cg')</code></pre>
</div>
</div>
<div class="cell" data-outputid="db22c5c5-8f78-45ed-ce6e-9984a16e0195" data-execution_count="70">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1"></a><span class="bu">print</span>(<span class="st">"Intercept:"</span>, logreg.intercept_)</span>
<span id="cb156-2"><a href="#cb156-2"></a><span class="bu">list</span>(<span class="bu">zip</span>(X.columns, logreg.coef_[<span class="dv">0</span>]) )         <span class="co"># coefficients</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Intercept: [-0.1259998]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>[('Lag1', -0.07307368882753848),
 ('Lag2', -0.042301339556733895),
 ('Lag3', 0.011085169923358404),
 ('Lag4', 0.009358899763340657),
 ('Lag5', 0.010313090846412886),
 ('Volume', 0.13544036505211507)]</code></pre>
</div>
</div>
<div class="cell" data-outputid="c31e3f89-b8e7-4bdb-9e25-d6d2f357041d" data-execution_count="71">
<div class="sourceCode cell-code" id="cb159"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb159-1"><a href="#cb159-1"></a><span class="bu">list</span>( <span class="bu">zip</span>(X.index, logreg.predict_proba(X<span class="op">=</span>X)[:<span class="dv">10</span>, <span class="dv">1</span>]) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>[(0, 0.5070841630730085),
 (1, 0.4814679278688445),
 (2, 0.48113885449678334),
 (3, 0.5152223784682999),
 (4, 0.5107812050659893),
 (5, 0.5069564651153047),
 (6, 0.49265092350090467),
 (7, 0.5092291586044021),
 (8, 0.5176135774773843),
 (9, 0.4888378035325076)]</code></pre>
</div>
</div>
<div class="cell" data-outputid="da1451c1-dfa9-4780-d422-c3644f22b988" data-execution_count="86">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1"></a>y_pred_class <span class="op">=</span> logreg.predict(X<span class="op">=</span>X)</span>
<span id="cb161-2"><a href="#cb161-2"></a>y_pred_class_prob <span class="op">=</span> logreg.predict_proba(X<span class="op">=</span>X)</span>
<span id="cb161-3"><a href="#cb161-3"></a>y_pred_class.<span class="bu">sum</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>964</code></pre>
</div>
</div>
<div class="cell" data-outputid="6365e62a-6a1b-43e0-ee3c-d4bea90f112a" data-execution_count="73">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1"></a>(y <span class="op">==</span> y_pred_class).<span class="bu">sum</span>()    </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="73">
<pre><code>652</code></pre>
</div>
</div>
<div class="cell" data-outputid="8b43807c-a0cc-4b50-96eb-fd6e3766449e" data-execution_count="74">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, accuracy_score(y, y_pred_class))   <span class="co"># Accuracy</span></span>
<span id="cb165-2"><a href="#cb165-2"></a><span class="bu">print</span>(<span class="st">"Accuracy (manual calculation): </span><span class="sc">%0.7f</span><span class="st"> "</span> <span class="op">%</span> (y <span class="op">==</span> y_pred_class).mean() )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy:  0.5216
Accuracy (manual calculation): 0.5216000 </code></pre>
</div>
</div>
<div class="cell" data-outputid="45cc6429-96de-4cff-adee-aa534a77aab4" data-execution_count="75">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1"></a>logreg.predict([[<span class="fl">1.2</span>,<span class="fl">1.1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>],</span>
<span id="cb167-2"><a href="#cb167-2"></a>                 [<span class="fl">1.5</span>,<span class="op">-</span><span class="fl">0.8</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>,<span class="dv">1</span>]])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/sklearn/base.py:451: UserWarning: X does not have valid feature names, but LogisticRegression was fitted with feature names
  "X does not have valid feature names, but"</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="75">
<pre><code>array([0, 0], dtype=uint8)</code></pre>
</div>
</div>
<p>You can find many useful metrics in the sklearn module <a href="https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics">https://scikit-learn.org/stable/modules/model_evaluation.html#classification-metrics</a>.</p>
<div class="cell" data-outputid="0bb29d86-aa43-47ad-896a-4ae9e1f7a7f3" data-execution_count="81">
<div class="sourceCode cell-code" id="cb170"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb170-1"><a href="#cb170-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y, y_pred_class)</span>
<span id="cb170-2"><a href="#cb170-2"></a><span class="bu">print</span>(fpr, tpr)</span>
<span id="cb170-3"><a href="#cb170-3"></a>roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb170-4"><a href="#cb170-4"></a>RocCurveDisplay(fpr<span class="op">=</span>fpr, tpr<span class="op">=</span>tpr, roc_auc<span class="op">=</span>roc_auc, estimator_name<span class="op">=</span><span class="st">'example estimator'</span>).plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0.         0.75913621 1.        ] [0.         0.78240741 1.        ]</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="81">
<pre><code>&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x7fe6187c9a50&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-92-output-3.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-outputid="35739128-ca48-4780-b60b-92100bffefe3" data-execution_count="87">
<div class="sourceCode cell-code" id="cb173"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb173-1"><a href="#cb173-1"></a>fpr, tpr, thresholds <span class="op">=</span> roc_curve(y, y_pred_class_prob[:,<span class="dv">1</span>])</span>
<span id="cb173-2"><a href="#cb173-2"></a>roc_auc <span class="op">=</span> auc(fpr, tpr)</span>
<span id="cb173-3"><a href="#cb173-3"></a>RocCurveDisplay(fpr<span class="op">=</span>fpr, tpr<span class="op">=</span>tpr, roc_auc<span class="op">=</span>roc_auc, estimator_name<span class="op">=</span><span class="st">'example estimator'</span>).plot()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="87">
<pre><code>&lt;sklearn.metrics._plot.roc_curve.RocCurveDisplay at 0x7fe61859a5d0&gt;</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_4_Lab_files/figure-html/cell-93-output-2.png" class="img-fluid"></p>
</div>
</div>
</section>
<section id="optional" class="level2" data-number="4.9">
<h2 data-number="4.9" class="anchored" data-anchor-id="optional"><span class="header-section-number">4.9</span> Optional</h2>
<section id="poisson-regression-with-sklearn-and-column-transform" class="level3" data-number="4.9.1">
<h3 data-number="4.9.1" class="anchored" data-anchor-id="poisson-regression-with-sklearn-and-column-transform"><span class="header-section-number">4.9.1</span> Poisson regression with sklearn and column transform</h3>
<p><a href="https://scikit-learn.org/stable/auto_examples/linear_model/plot_poisson_regression_non_normal_loss.html">https://scikit-learn.org/stable/auto_examples/linear_model/plot_poisson_regression_non_normal_loss.html</a></p>
</section>
<section id="yellowbrics-plot" class="level3" data-number="4.9.2">
<h3 data-number="4.9.2" class="anchored" data-anchor-id="yellowbrics-plot"><span class="header-section-number">4.9.2</span> Yellowbric’s plot</h3>
<p><a href="https://www.scikit-yb.org/en/latest/api/classifier/index.html#">https://www.scikit-yb.org/en/latest/api/classifier/index.html#</a></p>


</section>
</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Chapter_3_Lab.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Regression</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Chapter_5_Lab.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling methods</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>