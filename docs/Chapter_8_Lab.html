<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.3.306">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="phonchi">
<meta name="dcterms.date" content="2022-11-14">

<title>Statistical Learning and Data Mining - 8&nbsp; Decision Trees</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="site_libs/quarto-nav/quarto-nav.js"></script>
<script src="site_libs/quarto-nav/headroom.min.js"></script>
<script src="site_libs/clipboard/clipboard.min.js"></script>
<script src="site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="site_libs/quarto-search/fuse.min.js"></script>
<script src="site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="./">
<link href="./Chapter_9_Lab.html" rel="next">
<link href="./Chapter_7_Lab.html" rel="prev">
<script src="site_libs/quarto-html/quarto.js"></script>
<script src="site_libs/quarto-html/popper.min.js"></script>
<script src="site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="site_libs/quarto-html/anchor.min.js"></script>
<link href="site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="site_libs/bootstrap/bootstrap.min.js"></script>
<link href="site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "sidebar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "start",
  "type": "textbox",
  "limit": 20,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit"
  }
}</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script>
<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

</head>

<body class="nav-sidebar floating">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
      <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item"><a href="./Chapter_8_Lab.html"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Decision Trees</span></a></li></ol></nav>
      <a class="flex-grow-1" role="button" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
      </a>
      <button type="button" class="btn quarto-search-button" aria-label="Search" onclick="window.quartoOpenSearch();">
        <i class="bi bi-search"></i>
      </button>
    </div>
  </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal sidebar-navigation floating overflow-auto">
    <div class="pt-lg-2 mt-2 text-left sidebar-header">
    <div class="sidebar-title mb-0 py-0">
      <a href="./">Statistical Learning and Data Mining</a> 
    </div>
      </div>
        <div class="mt-2 flex-shrink-0 align-items-center">
        <div class="sidebar-search">
        <div id="quarto-search" class="" title="Search"></div>
        </div>
        </div>
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Preface</span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter1_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">1</span>&nbsp; <span class="chapter-title">Introduction</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter 2_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">2</span>&nbsp; <span class="chapter-title">Statistical Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_3_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">3</span>&nbsp; <span class="chapter-title">Regression</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_4_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">4</span>&nbsp; <span class="chapter-title">Classification</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_5_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">5</span>&nbsp; <span class="chapter-title">Resampling methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_6_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">6</span>&nbsp; <span class="chapter-title">Linear Models and Regularization Methods</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_7_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-linear Modeling</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_8_Lab.html" class="sidebar-item-text sidebar-link active">
 <span class="menu-text"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Decision Trees</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_9_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Support Vector Machines</span></span></a>
  </div>
</li>
        <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Chapter_12_Lab.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">10</span>&nbsp; <span class="chapter-title">Unsupervised Learning</span></span></a>
  </div>
</li>
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true">
 <span class="menu-text">Appendices</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./NumPy_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">A</span>&nbsp; <span class="chapter-title">Numpy - multidimensional data arrays for python</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./Colab_tutorial.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">B</span>&nbsp; <span class="chapter-title">Introduction to Colab</span></span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="./kaggle-explore.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text"><span class="chapter-number">C</span>&nbsp; <span class="chapter-title">Introduction to Kaggle</span></span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
</nav>
<div id="quarto-sidebar-glass" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar,#quarto-sidebar-glass"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#setup" id="toc-setup" class="nav-link active" data-scroll-target="#setup"><span class="header-section-number">8.1</span> Setup</a></li>
  <li><a href="#fitting-classification-trees" id="toc-fitting-classification-trees" class="nav-link" data-scroll-target="#fitting-classification-trees"><span class="header-section-number">8.2</span> Fitting classification trees</a></li>
  <li><a href="#fitting-regression-trees" id="toc-fitting-regression-trees" class="nav-link" data-scroll-target="#fitting-regression-trees"><span class="header-section-number">8.3</span> Fitting Regression Trees</a></li>
  <li><a href="#bagging-and-random-forests" id="toc-bagging-and-random-forests" class="nav-link" data-scroll-target="#bagging-and-random-forests"><span class="header-section-number">8.4</span> Bagging and Random Forests</a></li>
  <li><a href="#boosting" id="toc-boosting" class="nav-link" data-scroll-target="#boosting"><span class="header-section-number">8.5</span> Boosting</a>
  <ul class="collapse">
  <li><a href="#adaboost" id="toc-adaboost" class="nav-link" data-scroll-target="#adaboost"><span class="header-section-number">8.5.1</span> AdaBoost</a></li>
  </ul></li>
  <li><a href="#bayesian-additive-regression-trees" id="toc-bayesian-additive-regression-trees" class="nav-link" data-scroll-target="#bayesian-additive-regression-trees"><span class="header-section-number">8.6</span> Bayesian Additive Regression Trees</a></li>
  <li><a href="#xgboost" id="toc-xgboost" class="nav-link" data-scroll-target="#xgboost"><span class="header-section-number">8.7</span> XGBoost</a>
  <ul class="collapse">
  <li><a href="#classification-task" id="toc-classification-task" class="nav-link" data-scroll-target="#classification-task"><span class="header-section-number">8.7.1</span> Classification task</a></li>
  <li><a href="#regression-task" id="toc-regression-task" class="nav-link" data-scroll-target="#regression-task"><span class="header-section-number">8.7.2</span> Regression task</a></li>
  <li><a href="#speed-comparsion" id="toc-speed-comparsion" class="nav-link" data-scroll-target="#speed-comparsion"><span class="header-section-number">8.7.3</span> Speed comparsion</a></li>
  <li><a href="#hyperparameter" id="toc-hyperparameter" class="nav-link" data-scroll-target="#hyperparameter"><span class="header-section-number">8.7.4</span> Hyperparameter</a></li>
  <li><a href="#for-categorical-variable-and-missing-value" id="toc-for-categorical-variable-and-missing-value" class="nav-link" data-scroll-target="#for-categorical-variable-and-missing-value"><span class="header-section-number">8.7.5</span> For categorical variable and missing value</a></li>
  </ul></li>
  <li><a href="#lightgbm" id="toc-lightgbm" class="nav-link" data-scroll-target="#lightgbm"><span class="header-section-number">8.8</span> Lightgbm</a>
  <ul class="collapse">
  <li><a href="#classification-task-1" id="toc-classification-task-1" class="nav-link" data-scroll-target="#classification-task-1"><span class="header-section-number">8.8.1</span> Classification task</a></li>
  <li><a href="#regression-task-1" id="toc-regression-task-1" class="nav-link" data-scroll-target="#regression-task-1"><span class="header-section-number">8.8.2</span> Regression task</a></li>
  <li><a href="#speed" id="toc-speed" class="nav-link" data-scroll-target="#speed"><span class="header-section-number">8.8.3</span> Speed</a></li>
  <li><a href="#hyperparameter-1" id="toc-hyperparameter-1" class="nav-link" data-scroll-target="#hyperparameter-1"><span class="header-section-number">8.8.4</span> Hyperparameter</a></li>
  <li><a href="#for-categorical-variable-and-missing-value-1" id="toc-for-categorical-variable-and-missing-value-1" class="nav-link" data-scroll-target="#for-categorical-variable-and-missing-value-1"><span class="header-section-number">8.8.5</span> For categorical variable and missing value</a></li>
  </ul></li>
  <li><a href="#catboost" id="toc-catboost" class="nav-link" data-scroll-target="#catboost"><span class="header-section-number">8.9</span> CatBoost</a>
  <ul class="collapse">
  <li><a href="#classification-task-2" id="toc-classification-task-2" class="nav-link" data-scroll-target="#classification-task-2"><span class="header-section-number">8.9.1</span> Classification task</a></li>
  <li><a href="#regression" id="toc-regression" class="nav-link" data-scroll-target="#regression"><span class="header-section-number">8.9.2</span> Regression</a></li>
  <li><a href="#speed-1" id="toc-speed-1" class="nav-link" data-scroll-target="#speed-1"><span class="header-section-number">8.9.3</span> Speed</a></li>
  <li><a href="#hyperparameter-2" id="toc-hyperparameter-2" class="nav-link" data-scroll-target="#hyperparameter-2"><span class="header-section-number">8.9.4</span> Hyperparameter</a></li>
  <li><a href="#for-categorical-variable-and-missing-value-2" id="toc-for-categorical-variable-and-missing-value-2" class="nav-link" data-scroll-target="#for-categorical-variable-and-missing-value-2"><span class="header-section-number">8.9.5</span> For categorical variable and missing value</a></li>
  </ul></li>
  <li><a href="#voting-and-stacking" id="toc-voting-and-stacking" class="nav-link" data-scroll-target="#voting-and-stacking"><span class="header-section-number">8.10</span> Voting and Stacking</a></li>
  </ul>
</nav>
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title"><span class="chapter-number">8</span>&nbsp; <span class="chapter-title">Decision Trees</span></h1>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>phonchi </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">November 14, 2022</p>
    </div>
  </div>
  
    
  </div>
  

</header>


<table align="left">
<tbody><tr><td>
<a href="https://colab.research.google.com/github/phonchi/nsysu-math524/blob/master/static_files/presentations/Chapter_8_Lab.ipynb" target="_parent"><img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"></a>
</td>
<td>
<a target="_blank" href="https://kaggle.com/kernels/welcome?src=https://github.com/phonchi/nsysu-math524/blob/master/static_files/presentations/Chapter_8_Lab.ipynb"><img src="https://kaggle.com/static/images/open-in-kaggle.svg"></a>
</td>

</tr></tbody></table>
<p><br></p>
<section id="setup" class="level2" data-number="8.1">
<h2 data-number="8.1" class="anchored" data-anchor-id="setup"><span class="header-section-number">8.1</span> Setup</h2>
<p>We first use classification trees to analyze the <code>Carseats</code> data set. In these data, <code>Sales</code> is a continuous variable, and so we begin by recoding it as a binary variable.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:80280,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898388465,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="7c9202bb-b861-4757-b8a3-2a13dd0da9a9">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1"></a><span class="op">!</span>pip install git<span class="op">+</span>https:<span class="op">//</span>github.com<span class="op">/</span>JakeColtman<span class="op">/</span>bartpy.git <span class="op">-</span>qq</span>
<span id="cb1-2"><a href="#cb1-2"></a><span class="op">!</span>pip install xgboost <span class="op">-</span>U <span class="op">-</span>qq</span>
<span id="cb1-3"><a href="#cb1-3"></a><span class="op">!</span>pip install lightgbm <span class="op">-</span>U <span class="op">-</span>qq</span>
<span id="cb1-4"><a href="#cb1-4"></a><span class="op">!</span>pip install catboost <span class="op">-</span>U <span class="op">-</span>qq</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  Building wheel for bartpy (setup.py) ... done
  Building wheel for sklearn (setup.py) ... done
     |████████████████████████████████| 255.9 MB 37 kB/s 
     |████████████████████████████████| 2.0 MB 5.3 MB/s 
Looking in indexes: https://pypi.org/simple, https://us-python.pkg.dev/colab-wheels/public/simple/
Collecting catboost
  Downloading catboost-1.1.1-cp37-none-manylinux1_x86_64.whl (76.6 MB)
     |████████████████████████████████| 76.6 MB 128 kB/s 
Requirement already satisfied: scipy in /usr/local/lib/python3.7/dist-packages (from catboost) (1.7.3)
Requirement already satisfied: six in /usr/local/lib/python3.7/dist-packages (from catboost) (1.15.0)
Requirement already satisfied: pandas&gt;=0.24.0 in /usr/local/lib/python3.7/dist-packages (from catboost) (1.3.5)
Requirement already satisfied: numpy&gt;=1.16.0 in /usr/local/lib/python3.7/dist-packages (from catboost) (1.21.6)
Requirement already satisfied: matplotlib in /usr/local/lib/python3.7/dist-packages (from catboost) (3.2.2)
Requirement already satisfied: graphviz in /usr/local/lib/python3.7/dist-packages (from catboost) (0.10.1)
Requirement already satisfied: plotly in /usr/local/lib/python3.7/dist-packages (from catboost) (5.5.0)
Requirement already satisfied: python-dateutil&gt;=2.7.3 in /usr/local/lib/python3.7/dist-packages (from pandas&gt;=0.24.0-&gt;catboost) (2.8.2)
Requirement already satisfied: pytz&gt;=2017.3 in /usr/local/lib/python3.7/dist-packages (from pandas&gt;=0.24.0-&gt;catboost) (2022.5)
Requirement already satisfied: pyparsing!=2.0.4,!=2.1.2,!=2.1.6,&gt;=2.0.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib-&gt;catboost) (3.0.9)
Requirement already satisfied: cycler&gt;=0.10 in /usr/local/lib/python3.7/dist-packages (from matplotlib-&gt;catboost) (0.11.0)
Requirement already satisfied: kiwisolver&gt;=1.0.1 in /usr/local/lib/python3.7/dist-packages (from matplotlib-&gt;catboost) (1.4.4)
Requirement already satisfied: typing-extensions in /usr/local/lib/python3.7/dist-packages (from kiwisolver&gt;=1.0.1-&gt;matplotlib-&gt;catboost) (4.1.1)
Requirement already satisfied: tenacity&gt;=6.2.0 in /usr/local/lib/python3.7/dist-packages (from plotly-&gt;catboost) (8.1.0)
Installing collected packages: catboost
Successfully installed catboost-1.1.1</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1754,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1638784499061,&quot;user&quot;:{&quot;displayName&quot;:&quot;思齊鍾&quot;,&quot;photoUrl&quot;:&quot;https://lh3.googleusercontent.com/a/default-user=s64&quot;,&quot;userId&quot;:&quot;00591983406172857081&quot;},&quot;user_tz&quot;:-480}" data-outputid="53ef76cf-f840-4c15-905b-747ed04c5077">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1"></a><span class="op">!</span>pip install mlxtend <span class="op">--</span>upgrade <span class="op">--</span>no<span class="op">-</span>deps</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Requirement already satisfied: mlxtend in /usr/local/lib/python3.7/dist-packages (0.14.0)
Collecting mlxtend
  Downloading mlxtend-0.19.0-py2.py3-none-any.whl (1.3 MB)
     |████████████████████████████████| 1.3 MB 5.4 MB/s 
Installing collected packages: mlxtend
  Attempting uninstall: mlxtend
    Found existing installation: mlxtend 0.14.0
    Uninstalling mlxtend-0.14.0:
      Successfully uninstalled mlxtend-0.14.0
Successfully installed mlxtend-0.19.0</code></pre>
</div>
<div class="cell-output cell-output-display">
<pre><code>Unable to display output for mime type(s): application/vnd.colab-display-data+json</code></pre>
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1"></a><span class="im">import</span> pandas <span class="im">as</span> pd</span>
<span id="cb6-2"><a href="#cb6-2"></a><span class="im">import</span> numpy <span class="im">as</span> np</span>
<span id="cb6-3"><a href="#cb6-3"></a><span class="im">import</span> time</span>
<span id="cb6-4"><a href="#cb6-4"></a></span>
<span id="cb6-5"><a href="#cb6-5"></a><span class="im">from</span> sklearn <span class="im">import</span> datasets</span>
<span id="cb6-6"><a href="#cb6-6"></a><span class="im">from</span> sklearn.inspection <span class="im">import</span> plot_partial_dependence</span>
<span id="cb6-7"><a href="#cb6-7"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> train_test_split,KFold, cross_val_score, GridSearchCV, RandomizedSearchCV, StratifiedKFold</span>
<span id="cb6-8"><a href="#cb6-8"></a><span class="im">from</span> sklearn.tree <span class="im">import</span> DecisionTreeClassifier, DecisionTreeRegressor</span>
<span id="cb6-9"><a href="#cb6-9"></a><span class="im">from</span> sklearn.ensemble <span class="im">import</span> RandomForestClassifier, RandomForestRegressor, GradientBoostingClassifier, GradientBoostingRegressor, AdaBoostClassifier, AdaBoostRegressor, StackingClassifier, VotingClassifier</span>
<span id="cb6-10"><a href="#cb6-10"></a><span class="im">from</span> sklearn <span class="im">import</span> tree</span>
<span id="cb6-11"><a href="#cb6-11"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> confusion_matrix, roc_auc_score, mean_squared_error</span>
<span id="cb6-12"><a href="#cb6-12"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> accuracy_score</span>
<span id="cb6-13"><a href="#cb6-13"></a><span class="im">from</span> sklearn.metrics <span class="im">import</span> mean_absolute_error</span>
<span id="cb6-14"><a href="#cb6-14"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> LabelEncoder</span>
<span id="cb6-15"><a href="#cb6-15"></a></span>
<span id="cb6-16"><a href="#cb6-16"></a><span class="co"># Require extra installation</span></span>
<span id="cb6-17"><a href="#cb6-17"></a><span class="im">from</span> bartpy.sklearnmodel <span class="im">import</span> SklearnModel </span>
<span id="cb6-18"><a href="#cb6-18"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBRegressor</span>
<span id="cb6-19"><a href="#cb6-19"></a><span class="im">from</span> xgboost <span class="im">import</span> XGBClassifier</span>
<span id="cb6-20"><a href="#cb6-20"></a><span class="im">from</span> lightgbm <span class="im">import</span> LGBMRegressor</span>
<span id="cb6-21"><a href="#cb6-21"></a><span class="im">import</span> lightgbm <span class="im">as</span> lgb</span>
<span id="cb6-22"><a href="#cb6-22"></a><span class="im">from</span> catboost <span class="im">import</span> CatBoostClassifier, CatBoostRegressor, Pool</span>
<span id="cb6-23"><a href="#cb6-23"></a></span>
<span id="cb6-24"><a href="#cb6-24"></a><span class="im">import</span> graphviz </span>
<span id="cb6-25"><a href="#cb6-25"></a><span class="im">import</span> matplotlib.pyplot <span class="im">as</span> plt</span>
<span id="cb6-26"><a href="#cb6-26"></a><span class="im">import</span> seaborn <span class="im">as</span> sns</span>
<span id="cb6-27"><a href="#cb6-27"></a></span>
<span id="cb6-28"><a href="#cb6-28"></a><span class="op">%</span>matplotlib inline</span>
<span id="cb6-29"><a href="#cb6-29"></a>plt.style.use(<span class="st">'seaborn-white'</span>)</span>
<span id="cb6-30"><a href="#cb6-30"></a>sns.set_context(<span class="st">"notebook"</span>, font_scale<span class="op">=</span><span class="fl">1.5</span>, rc<span class="op">=</span>{<span class="st">"lines.linewidth"</span>: <span class="fl">2.5</span>})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="fitting-classification-trees" class="level2" data-number="8.2">
<h2 data-number="8.2" class="anchored" data-anchor-id="fitting-classification-trees"><span class="header-section-number">8.2</span> Fitting classification trees</h2>
<p>The current data we have is of an organization who sells car seats, each row represents a region. Therefore for each region, the columns are -</p>
<ul>
<li><strong>Sales</strong>: unit sales in thousands</li>
<li><strong>CompPrice</strong>: price charged by competitor at each location</li>
<li><strong>Income</strong>: community income level in 1000s of dollars</li>
<li><strong>Advertising</strong>: local ad budget at each location in 1000s of dollars</li>
<li><strong>Population</strong>: regional pop in thousands</li>
<li><strong>Price</strong>: price for car seats at each site</li>
<li><strong>ShelveLoc</strong>: Bad, Good or Medium indicates quality of shelving location</li>
<li><strong>Age</strong>: age level of the population</li>
<li><strong>Education</strong>: ed level at location</li>
<li><strong>Urban</strong>: Yes/No</li>
<li><strong>US</strong>: Yes/No</li>
</ul>
<p>The company wants to set up a busniess in some new region, we have the information of that region and want to predict what the sales would be. To make the model we will use this data as training data source.</p>
<p>We create a variable, called <code>High</code>, which takes on a value of <code>Yes</code> if the <code>Sales</code> variable exceeds <span class="math inline">\(8\)</span>, and takes on a value of <code>No</code> otherwise.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:25303,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898482264,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="d4cb1770-cae9-4a4f-aa23-a56022cb3fc1">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1"></a><span class="im">from</span> google.colab <span class="im">import</span> drive</span>
<span id="cb7-2"><a href="#cb7-2"></a>drive.mount(<span class="st">'/content/drive'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Mounted at /content/drive</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:942,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898483203,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="2b4e1212-8e87-4e02-cd19-4a181935ab9c">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1"></a>Carseats <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Carseats.csv'</span>)</span>
<span id="cb9-2"><a href="#cb9-2"></a></span>
<span id="cb9-3"><a href="#cb9-3"></a><span class="bu">print</span>(Carseats.shape)</span>
<span id="cb9-4"><a href="#cb9-4"></a><span class="co"># Check for missing values</span></span>
<span id="cb9-5"><a href="#cb9-5"></a><span class="cf">assert</span> Carseats.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb9-6"><a href="#cb9-6"></a></span>
<span id="cb9-7"><a href="#cb9-7"></a><span class="co"># Create binary variable High 1 if Sales &gt; 8</span></span>
<span id="cb9-8"><a href="#cb9-8"></a>Carseats[<span class="st">'High'</span>] <span class="op">=</span> (Carseats[<span class="st">'Sales'</span>] <span class="op">&gt;</span> <span class="dv">8</span>).astype(np.float64)</span>
<span id="cb9-9"><a href="#cb9-9"></a></span>
<span id="cb9-10"><a href="#cb9-10"></a>Carseats.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(400, 11)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="4">

  <div id="df-f704deb5-8fce-4eb2-ac63-f3b450b26d49">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">Sales</th>
<th data-quarto-table-cell-role="th">CompPrice</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Advertising</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">ShelveLoc</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">Urban</th>
<th data-quarto-table-cell-role="th">US</th>
<th data-quarto-table-cell-role="th">High</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>9.50</td>
<td>138</td>
<td>73</td>
<td>11</td>
<td>276</td>
<td>120</td>
<td>Bad</td>
<td>42</td>
<td>17</td>
<td>Yes</td>
<td>Yes</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>11.22</td>
<td>111</td>
<td>48</td>
<td>16</td>
<td>260</td>
<td>83</td>
<td>Good</td>
<td>65</td>
<td>10</td>
<td>Yes</td>
<td>Yes</td>
<td>1.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>10.06</td>
<td>113</td>
<td>35</td>
<td>10</td>
<td>269</td>
<td>80</td>
<td>Medium</td>
<td>59</td>
<td>12</td>
<td>Yes</td>
<td>Yes</td>
<td>1.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>7.40</td>
<td>117</td>
<td>100</td>
<td>4</td>
<td>466</td>
<td>97</td>
<td>Medium</td>
<td>55</td>
<td>14</td>
<td>Yes</td>
<td>Yes</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>4.15</td>
<td>141</td>
<td>64</td>
<td>3</td>
<td>340</td>
<td>128</td>
<td>Bad</td>
<td>38</td>
<td>13</td>
<td>Yes</td>
<td>No</td>
<td>0.0</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-f704deb5-8fce-4eb2-ac63-f3b450b26d49')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-f704deb5-8fce-4eb2-ac63-f3b450b26d49 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-f704deb5-8fce-4eb2-ac63-f3b450b26d49');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1"></a>predictors <span class="op">=</span> Carseats.drop([<span class="st">"Sales"</span>,<span class="st">"High"</span>], axis<span class="op">=</span><span class="dv">1</span>).columns</span>
<span id="cb11-2"><a href="#cb11-2"></a>X <span class="op">=</span> pd.get_dummies(Carseats[predictors], drop_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb11-3"><a href="#cb11-3"></a>y <span class="op">=</span> Carseats[<span class="st">"High"</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:279,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898504248,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="43773363-9e15-4d60-ac30-8b4296bc98e5">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1"></a>X</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="6">

  <div id="df-9c48b8c2-10cf-46b5-8a1c-4aae2e320235">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">CompPrice</th>
<th data-quarto-table-cell-role="th">Income</th>
<th data-quarto-table-cell-role="th">Advertising</th>
<th data-quarto-table-cell-role="th">Population</th>
<th data-quarto-table-cell-role="th">Price</th>
<th data-quarto-table-cell-role="th">Age</th>
<th data-quarto-table-cell-role="th">Education</th>
<th data-quarto-table-cell-role="th">ShelveLoc_Good</th>
<th data-quarto-table-cell-role="th">ShelveLoc_Medium</th>
<th data-quarto-table-cell-role="th">Urban_Yes</th>
<th data-quarto-table-cell-role="th">US_Yes</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>138</td>
<td>73</td>
<td>11</td>
<td>276</td>
<td>120</td>
<td>42</td>
<td>17</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>111</td>
<td>48</td>
<td>16</td>
<td>260</td>
<td>83</td>
<td>65</td>
<td>10</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>113</td>
<td>35</td>
<td>10</td>
<td>269</td>
<td>80</td>
<td>59</td>
<td>12</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>117</td>
<td>100</td>
<td>4</td>
<td>466</td>
<td>97</td>
<td>55</td>
<td>14</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>141</td>
<td>64</td>
<td>3</td>
<td>340</td>
<td>128</td>
<td>38</td>
<td>13</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
<td>...</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">395</td>
<td>138</td>
<td>108</td>
<td>17</td>
<td>203</td>
<td>128</td>
<td>33</td>
<td>14</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">396</td>
<td>139</td>
<td>23</td>
<td>3</td>
<td>37</td>
<td>120</td>
<td>55</td>
<td>11</td>
<td>0</td>
<td>1</td>
<td>0</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">397</td>
<td>162</td>
<td>26</td>
<td>12</td>
<td>368</td>
<td>159</td>
<td>40</td>
<td>18</td>
<td>0</td>
<td>1</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">398</td>
<td>100</td>
<td>79</td>
<td>7</td>
<td>284</td>
<td>95</td>
<td>50</td>
<td>12</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">399</td>
<td>134</td>
<td>37</td>
<td>0</td>
<td>27</td>
<td>120</td>
<td>49</td>
<td>16</td>
<td>1</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
</tbody>
</table>


<p>400 rows × 11 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-9c48b8c2-10cf-46b5-8a1c-4aae2e320235')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-9c48b8c2-10cf-46b5-8a1c-4aae2e320235 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-9c48b8c2-10cf-46b5-8a1c-4aae2e320235');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>The best found split may vary across different runs, even if <code>max_features=n_features</code>. That is the case, if the improvement of the criterion is identical for several splits and one split has to be selected at random. To obtain a deterministic behaviour during fitting, random_state</p>
<p>https://scikit-learn.org/stable/modules/generated/sklearn.tree.DecisionTreeClassifier.html</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:322,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898510884,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="512620ca-c647-4144-8919-37f48dc62ab1">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1"></a>clf_tree <span class="op">=</span> DecisionTreeClassifier(max_depth<span class="op">=</span><span class="dv">3</span>, min_samples_leaf<span class="op">=</span><span class="dv">5</span>, random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb13-2"><a href="#cb13-2"></a>clf_tree.fit(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="7">
<pre><code>DecisionTreeClassifier(criterion='entropy', max_depth=3, min_samples_leaf=5,
                       random_state=1)</code></pre>
</div>
</div>
<p>One of the most attractive properties of trees is that they can be graphically displayed. We use the <code>plot_tree()</code> function to display the tree structure, and the <code>export_text</code> function to display the node labels. The argument <code>feature_names</code> instructs <code>Python</code> to include the feature names for any predictors, rather than simply displaying a number.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2584,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898516803,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="fd934f97-695b-4d6e-fe90-5bfd3aaf96fd">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb15-1"><a href="#cb15-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">40</span>,<span class="dv">24</span>))</span>
<span id="cb15-2"><a href="#cb15-2"></a>tree.plot_tree(clf_tree, feature_names<span class="op">=</span>X.columns,  </span>
<span id="cb15-3"><a href="#cb15-3"></a>                    class_names<span class="op">=</span>[<span class="st">'No'</span>,<span class="st">'Yes'</span>],</span>
<span id="cb15-4"><a href="#cb15-4"></a>                    filled<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb15-5"><a href="#cb15-5"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-10-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:376,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898524183,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="35861786-8095-4a13-bbd6-46f2ce3bde61">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1"></a>dot_data <span class="op">=</span> tree.export_graphviz(clf_tree, feature_names<span class="op">=</span>X.columns,  </span>
<span id="cb16-2"><a href="#cb16-2"></a>                    class_names<span class="op">=</span>[<span class="st">'No'</span>,<span class="st">'Yes'</span>],</span>
<span id="cb16-3"><a href="#cb16-3"></a>                    filled<span class="op">=</span><span class="va">True</span>, out_file<span class="op">=</span><span class="va">None</span>) </span>
<span id="cb16-4"><a href="#cb16-4"></a>graph <span class="op">=</span> graphviz.Source(dot_data) </span>
<span id="cb16-5"><a href="#cb16-5"></a>graph.render(<span class="st">"tree1"</span>)</span>
<span id="cb16-6"><a href="#cb16-6"></a>graph </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="9">
<p><img src="Chapter_8_Lab_files/figure-html/cell-11-output-1.svg" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:284,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898527336,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="22923aae-0cca-4ba7-c289-0ddaf86cc3ca">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1"></a>r <span class="op">=</span> tree.export_text(clf_tree, feature_names<span class="op">=</span><span class="bu">list</span>(X.columns))</span>
<span id="cb17-2"><a href="#cb17-2"></a><span class="bu">print</span>(r)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>|--- ShelveLoc_Good &lt;= 0.50
|   |--- Price &lt;= 92.50
|   |   |--- Income &lt;= 57.00
|   |   |   |--- class: 0.0
|   |   |--- Income &gt;  57.00
|   |   |   |--- class: 1.0
|   |--- Price &gt;  92.50
|   |   |--- Advertising &lt;= 13.50
|   |   |   |--- class: 0.0
|   |   |--- Advertising &gt;  13.50
|   |   |   |--- class: 1.0
|--- ShelveLoc_Good &gt;  0.50
|   |--- Price &lt;= 135.00
|   |   |--- US_Yes &lt;= 0.50
|   |   |   |--- class: 1.0
|   |   |--- US_Yes &gt;  0.50
|   |   |   |--- class: 1.0
|   |--- Price &gt;  135.00
|   |   |--- Income &lt;= 46.00
|   |   |   |--- class: 0.0
|   |   |--- Income &gt;  46.00
|   |   |   |--- class: 1.0
</code></pre>
</div>
</div>
<p>The most important indicator of <code>Sales</code> appears to be shelving location, since the first branch differentiates <code>Good</code> locations from <code>Bad</code> and <code>Medium</code> locations.</p>
<p>For more information about understanding the structure and decision path <a href="https://scikit-learn.org/stable/auto_examples/tree/plot_unveil_tree_structure.html#sphx-glr-auto-examples-tree-plot-unveil-tree-structure-py">https://scikit-learn.org/stable/auto_examples/tree/plot_unveil_tree_structure.html#sphx-glr-auto-examples-tree-plot-unveil-tree-structure-py</a>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:283,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898538077,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5c2872a3-1827-40a2-c39d-a67924669816">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1"></a><span class="co">#clf_tree = DecisionTreeClassifier(max_depth=8, min_samples_leaf=5, random_state=1, criterion='entropy')</span></span>
<span id="cb19-2"><a href="#cb19-2"></a>clf_tree <span class="op">=</span> DecisionTreeClassifier(max_leaf_nodes<span class="op">=</span><span class="dv">30</span>, random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb19-3"><a href="#cb19-3"></a>clf_tree.fit(X, y)</span>
<span id="cb19-4"><a href="#cb19-4"></a>clf_tree.score(X, y)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="11">
<pre><code>0.9375</code></pre>
</div>
</div>
<p>We see that the training error rate is <span class="math inline">\(6.25\%\)</span> when we set the <code>max_leaf_nodes</code> to 30. In order to properly evaluate the performance of a classification tree on these data, we must estimate the test error rather than simply computing the training error. We split the observations into a training set and a test set, build the tree using the training set, and evaluate its performance on the test data. The <code>predict()</code> function can be used for this purpose. This approach leads to correct predictions for around <span class="math inline">\(73\,\%\)</span> of the locations in the test data set.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:502,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898550166,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="59b771b0-705f-4209-b3e6-fa1109fc001e">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, train_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb21-2"><a href="#cb21-2"></a>clf_tree <span class="op">=</span> DecisionTreeClassifier(max_leaf_nodes<span class="op">=</span><span class="dv">30</span>, random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb21-3"><a href="#cb21-3"></a>clf_tree.fit(X_train, y_train)</span>
<span id="cb21-4"><a href="#cb21-4"></a></span>
<span id="cb21-5"><a href="#cb21-5"></a>y_pred <span class="op">=</span> clf_tree.predict(X_test)</span>
<span id="cb21-6"><a href="#cb21-6"></a>y_pred_prob <span class="op">=</span> clf_tree.predict_proba(X_test)</span>
<span id="cb21-7"><a href="#cb21-7"></a></span>
<span id="cb21-8"><a href="#cb21-8"></a>conf_mat <span class="op">=</span> confusion_matrix(y_test, y_pred)     </span>
<span id="cb21-9"><a href="#cb21-9"></a><span class="bu">print</span>(conf_mat)</span>
<span id="cb21-10"><a href="#cb21-10"></a>TP <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb21-11"><a href="#cb21-11"></a>TN <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb21-12"><a href="#cb21-12"></a>FP <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb21-13"><a href="#cb21-13"></a>FN <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb21-14"><a href="#cb21-14"></a></span>
<span id="cb21-15"><a href="#cb21-15"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, (TP<span class="op">+</span>TN) <span class="op">/</span> (TP<span class="op">+</span>TN<span class="op">+</span>FP<span class="op">+</span>FN) )</span>
<span id="cb21-16"><a href="#cb21-16"></a><span class="bu">print</span>(<span class="st">"Sensitivity: "</span>,  TP <span class="op">/</span> (FN <span class="op">+</span> TP) )</span>
<span id="cb21-17"><a href="#cb21-17"></a><span class="bu">print</span>(<span class="st">"Precision: "</span>,  TP <span class="op">/</span> (FP <span class="op">+</span> TP) )</span>
<span id="cb21-18"><a href="#cb21-18"></a><span class="bu">print</span>(<span class="st">"False Positive Rate: "</span>,  FP <span class="op">/</span> (FP <span class="op">+</span> TN) )</span>
<span id="cb21-19"><a href="#cb21-19"></a><span class="bu">print</span>(<span class="st">"AUC Score: "</span>, roc_auc_score(y_test, y_pred_prob[:,<span class="dv">1</span>]) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[100  19]
 [ 35  46]]
Accuracy:  0.73
Sensitivity:  0.5679012345679012
Precision:  0.7076923076923077
False Positive Rate:  0.15966386554621848
AUC Score:  0.7327523602033406</code></pre>
</div>
</div>
<p>Again, If you re-run the <code>fit()</code> function then you might get slightly different results, due to “ties”: for instance, this can happen when the training observations corresponding to a terminal node are evenly split between <code>Yes</code> and <code>No</code> response values. So remember to set the <code>random_state</code></p>
<p>Next, we consider whether pruning the tree might lead to improved results. We use cross-validation in order to determine the optimal size of tree complexity.</p>
<p>The tree now consider the number of terminal nodes.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4906,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898563350,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="90dc2db2-b63b-48a2-a4e1-90edb30f597d">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1"></a>tree_sizes <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">50</span>)</span>
<span id="cb23-2"><a href="#cb23-2"></a></span>
<span id="cb23-3"><a href="#cb23-3"></a>k <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb23-4"><a href="#cb23-4"></a>kf5 <span class="op">=</span> KFold(n_splits<span class="op">=</span>k, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb23-5"><a href="#cb23-5"></a></span>
<span id="cb23-6"><a href="#cb23-6"></a>ACC_scores <span class="op">=</span> []</span>
<span id="cb23-7"><a href="#cb23-7"></a>AUC_scores <span class="op">=</span> []</span>
<span id="cb23-8"><a href="#cb23-8"></a></span>
<span id="cb23-9"><a href="#cb23-9"></a><span class="co"># 10-Fold CV for each tree size </span></span>
<span id="cb23-10"><a href="#cb23-10"></a><span class="cf">for</span> size <span class="kw">in</span> tree_sizes:</span>
<span id="cb23-11"><a href="#cb23-11"></a>    clf_tree <span class="op">=</span> DecisionTreeClassifier(max_leaf_nodes<span class="op">=</span>size, random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb23-12"><a href="#cb23-12"></a>    ACC_s <span class="op">=</span> cross_val_score(clf_tree, X, y, cv<span class="op">=</span>kf5, scoring<span class="op">=</span><span class="st">'accuracy'</span>)</span>
<span id="cb23-13"><a href="#cb23-13"></a>    AUC_s <span class="op">=</span> cross_val_score(clf_tree, X, y, cv<span class="op">=</span>kf5, scoring<span class="op">=</span><span class="st">'roc_auc'</span>)</span>
<span id="cb23-14"><a href="#cb23-14"></a>    ACC_scores.append(np.mean(ACC_s))</span>
<span id="cb23-15"><a href="#cb23-15"></a>    AUC_scores.append(np.mean(AUC_s))</span>
<span id="cb23-16"><a href="#cb23-16"></a>    </span>
<span id="cb23-17"><a href="#cb23-17"></a><span class="co"># plot CV-Accuracy and AUC socres w.r.t tree sizes </span></span>
<span id="cb23-18"><a href="#cb23-18"></a>fig, (ax1, ax2) <span class="op">=</span> plt.subplots(nrows<span class="op">=</span><span class="dv">1</span>, ncols<span class="op">=</span><span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">5</span>))          </span>
<span id="cb23-19"><a href="#cb23-19"></a>fig.subplots_adjust(wspace<span class="op">=</span><span class="fl">0.5</span>)</span>
<span id="cb23-20"><a href="#cb23-20"></a></span>
<span id="cb23-21"><a href="#cb23-21"></a>ax1.plot(tree_sizes, ACC_scores)</span>
<span id="cb23-22"><a href="#cb23-22"></a>ax1.set_title(<span class="st">'5-CV ACC'</span>)</span>
<span id="cb23-23"><a href="#cb23-23"></a>ax1.set_xlabel(<span class="st">'Tree Size'</span>)</span>
<span id="cb23-24"><a href="#cb23-24"></a>ax1.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb23-25"><a href="#cb23-25"></a>ax1.grid(<span class="va">True</span>)</span>
<span id="cb23-26"><a href="#cb23-26"></a></span>
<span id="cb23-27"><a href="#cb23-27"></a>ax2.plot(tree_sizes, AUC_scores)</span>
<span id="cb23-28"><a href="#cb23-28"></a>ax2.set_title(<span class="st">'5-CV AUC scores'</span>)</span>
<span id="cb23-29"><a href="#cb23-29"></a>ax2.set_xlabel(<span class="st">'Tree Size'</span>)</span>
<span id="cb23-30"><a href="#cb23-30"></a>ax2.set_ylabel(<span class="st">'AUC scores'</span>)</span>
<span id="cb23-31"><a href="#cb23-31"></a>ax2.grid(<span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-15-output-1.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:302,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898565573,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="29800407-04ad-480e-88f2-8a7f3bb64fff">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb24-1"><a href="#cb24-1"></a>np.array(ACC_scores).argmax()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="14">
<pre><code>16</code></pre>
</div>
</div>
<p>How well does this pruned tree perform on the test data set? Once again, we apply the <code>predict()</code> function.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:269,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898569323,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="d0441cc2-835e-462a-f73f-ccfd7c1d6045">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1"></a>clf_tree <span class="op">=</span> DecisionTreeClassifier(max_leaf_nodes<span class="op">=</span><span class="dv">18</span>, random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb26-2"><a href="#cb26-2"></a>clf_tree.fit(X_train, y_train)</span>
<span id="cb26-3"><a href="#cb26-3"></a></span>
<span id="cb26-4"><a href="#cb26-4"></a>y_pred <span class="op">=</span> clf_tree.predict(X_test)</span>
<span id="cb26-5"><a href="#cb26-5"></a>y_pred_prob <span class="op">=</span> clf_tree.predict_proba(X_test)</span>
<span id="cb26-6"><a href="#cb26-6"></a></span>
<span id="cb26-7"><a href="#cb26-7"></a>conf_mat <span class="op">=</span> confusion_matrix(y_test, y_pred)     </span>
<span id="cb26-8"><a href="#cb26-8"></a><span class="bu">print</span>(conf_mat)</span>
<span id="cb26-9"><a href="#cb26-9"></a>TP <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">1</span>]</span>
<span id="cb26-10"><a href="#cb26-10"></a>TN <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">0</span>]</span>
<span id="cb26-11"><a href="#cb26-11"></a>FP <span class="op">=</span> conf_mat[<span class="dv">0</span>,<span class="dv">1</span>]</span>
<span id="cb26-12"><a href="#cb26-12"></a>FN <span class="op">=</span> conf_mat[<span class="dv">1</span>,<span class="dv">0</span>]</span>
<span id="cb26-13"><a href="#cb26-13"></a></span>
<span id="cb26-14"><a href="#cb26-14"></a><span class="bu">print</span>(<span class="st">"Accuracy: "</span>, (TP<span class="op">+</span>TN) <span class="op">/</span> (TP<span class="op">+</span>TN<span class="op">+</span>FP<span class="op">+</span>FN) )</span>
<span id="cb26-15"><a href="#cb26-15"></a><span class="bu">print</span>(<span class="st">"Sensitivity: "</span>,  TP <span class="op">/</span> (FN <span class="op">+</span> TP) )</span>
<span id="cb26-16"><a href="#cb26-16"></a><span class="bu">print</span>(<span class="st">"Precision: "</span>,  TP <span class="op">/</span> (FP <span class="op">+</span> TP) )</span>
<span id="cb26-17"><a href="#cb26-17"></a><span class="bu">print</span>(<span class="st">"False Positive Rate: "</span>,  FP <span class="op">/</span> (FP <span class="op">+</span> TN) )</span>
<span id="cb26-18"><a href="#cb26-18"></a><span class="bu">print</span>(<span class="st">"AUC Score: "</span>, roc_auc_score(y_test, y_pred_prob[:,<span class="dv">1</span>]) )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[[100  19]
 [ 32  49]]
Accuracy:  0.745
Sensitivity:  0.6049382716049383
Precision:  0.7205882352941176
False Positive Rate:  0.15966386554621848
AUC Score:  0.772849880693018</code></pre>
</div>
</div>
<p>Now <span class="math inline">\(74.5\,\%\)</span> of the test observations are correctly classified, so not only has the pruning process produced a more interpretable tree, but it has also slightly improved the classification accuracy.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:833,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898574216,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="ddfbf382-eb11-4387-d760-8aed90de75de">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1"></a><span class="co"># Plot feature by importance in this model</span></span>
<span id="cb28-2"><a href="#cb28-2"></a></span>
<span id="cb28-3"><a href="#cb28-3"></a>plot_df <span class="op">=</span> pd.DataFrame({<span class="st">'feature'</span>: X.columns, <span class="st">'importance'</span>: clf_tree.feature_importances_})</span>
<span id="cb28-4"><a href="#cb28-4"></a></span>
<span id="cb28-5"><a href="#cb28-5"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb28-6"><a href="#cb28-6"></a>sns.barplot(x<span class="op">=</span><span class="st">'importance'</span>, y<span class="op">=</span><span class="st">'feature'</span>, data<span class="op">=</span>plot_df.sort_values(<span class="st">'importance'</span>, ascending<span class="op">=</span><span class="va">False</span>),</span>
<span id="cb28-7"><a href="#cb28-7"></a>            color<span class="op">=</span><span class="st">'b'</span>)</span>
<span id="cb28-8"><a href="#cb28-8"></a>plt.xticks(rotation<span class="op">=</span><span class="dv">90</span>)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-18-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>cost complexity pruning can also be used in order to select a sequence of trees for consideration.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1"></a>clf_tree <span class="op">=</span> DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>)</span>
<span id="cb29-2"><a href="#cb29-2"></a>path <span class="op">=</span> clf_tree.cost_complexity_pruning_path(X_train, y_train)</span>
<span id="cb29-3"><a href="#cb29-3"></a>ccp_alphas, impurities <span class="op">=</span> path.ccp_alphas, path.impurities</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:474,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898582571,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="0b8dee7a-1ab9-4366-f8d9-d389159904f7">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb30-2"><a href="#cb30-2"></a>ax.plot(ccp_alphas[:<span class="op">-</span><span class="dv">1</span>], impurities[:<span class="op">-</span><span class="dv">1</span>], marker<span class="op">=</span><span class="st">"o"</span>, drawstyle<span class="op">=</span><span class="st">"steps-post"</span>)</span>
<span id="cb30-3"><a href="#cb30-3"></a>ax.set_xlabel(<span class="st">"effective alpha"</span>)</span>
<span id="cb30-4"><a href="#cb30-4"></a>ax.set_ylabel(<span class="st">"total impurity of leaves"</span>)</span>
<span id="cb30-5"><a href="#cb30-5"></a>ax.set_title(<span class="st">"Total Impurity vs effective alpha for training set"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="18">
<pre><code>Text(0.5, 1.0, 'Total Impurity vs effective alpha for training set')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-20-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:425,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898584568,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="9f988859-21ee-470e-d4af-fa4ce4e83fab">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1"></a>clfs <span class="op">=</span> []</span>
<span id="cb32-2"><a href="#cb32-2"></a><span class="cf">for</span> ccp_alpha <span class="kw">in</span> ccp_alphas:</span>
<span id="cb32-3"><a href="#cb32-3"></a>    clf <span class="op">=</span> DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>, criterion<span class="op">=</span><span class="st">'entropy'</span>, ccp_alpha<span class="op">=</span>ccp_alpha)</span>
<span id="cb32-4"><a href="#cb32-4"></a>    clf.fit(X_train, y_train)</span>
<span id="cb32-5"><a href="#cb32-5"></a>    clfs.append(clf)</span>
<span id="cb32-6"><a href="#cb32-6"></a><span class="bu">print</span>(</span>
<span id="cb32-7"><a href="#cb32-7"></a>    <span class="st">"Number of nodes in the last tree is: </span><span class="sc">{}</span><span class="st"> with ccp_alpha: </span><span class="sc">{}</span><span class="st">"</span>.<span class="bu">format</span>(</span>
<span id="cb32-8"><a href="#cb32-8"></a>        clfs[<span class="op">-</span><span class="dv">1</span>].tree_.node_count, ccp_alphas[<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb32-9"><a href="#cb32-9"></a>    )</span>
<span id="cb32-10"><a href="#cb32-10"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Number of nodes in the last tree is: 1 with ccp_alpha: 0.0974240009819235</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:782,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898587410,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5707e9ee-cf9e-41f5-f57b-99025a3f59c7">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb34-1"><a href="#cb34-1"></a>clfs <span class="op">=</span> clfs[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb34-2"><a href="#cb34-2"></a>ccp_alphas <span class="op">=</span> ccp_alphas[:<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb34-3"><a href="#cb34-3"></a></span>
<span id="cb34-4"><a href="#cb34-4"></a>node_counts <span class="op">=</span> [clf.tree_.node_count <span class="cf">for</span> clf <span class="kw">in</span> clfs]</span>
<span id="cb34-5"><a href="#cb34-5"></a>depth <span class="op">=</span> [clf.tree_.max_depth <span class="cf">for</span> clf <span class="kw">in</span> clfs]</span>
<span id="cb34-6"><a href="#cb34-6"></a>fig, ax <span class="op">=</span> plt.subplots(<span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb34-7"><a href="#cb34-7"></a>ax[<span class="dv">0</span>].plot(ccp_alphas, node_counts, marker<span class="op">=</span><span class="st">"o"</span>, drawstyle<span class="op">=</span><span class="st">"steps-post"</span>)</span>
<span id="cb34-8"><a href="#cb34-8"></a>ax[<span class="dv">0</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb34-9"><a href="#cb34-9"></a>ax[<span class="dv">0</span>].set_ylabel(<span class="st">"number of nodes"</span>)</span>
<span id="cb34-10"><a href="#cb34-10"></a>ax[<span class="dv">0</span>].set_title(<span class="st">"Number of nodes vs alpha"</span>)</span>
<span id="cb34-11"><a href="#cb34-11"></a>ax[<span class="dv">1</span>].plot(ccp_alphas, depth, marker<span class="op">=</span><span class="st">"o"</span>, drawstyle<span class="op">=</span><span class="st">"steps-post"</span>)</span>
<span id="cb34-12"><a href="#cb34-12"></a>ax[<span class="dv">1</span>].set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb34-13"><a href="#cb34-13"></a>ax[<span class="dv">1</span>].set_ylabel(<span class="st">"depth of tree"</span>)</span>
<span id="cb34-14"><a href="#cb34-14"></a>ax[<span class="dv">1</span>].set_title(<span class="st">"Depth vs alpha"</span>)</span>
<span id="cb34-15"><a href="#cb34-15"></a>fig.tight_layout()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-22-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Check <a href="https://scikit-learn.org/stable/auto_examples/tree/plot_cost_complexity_pruning.html">https://scikit-learn.org/stable/auto_examples/tree/plot_cost_complexity_pruning.html</a> and <a href="https://scikit-learn.org/stable/modules/tree.html">https://scikit-learn.org/stable/modules/tree.html</a> for more details</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:957,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898591746,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="4eba7abc-b617-4e3a-ada8-80a985330604">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1"></a>train_scores <span class="op">=</span> [clf.score(X_train, y_train) <span class="cf">for</span> clf <span class="kw">in</span> clfs]</span>
<span id="cb35-2"><a href="#cb35-2"></a>test_scores <span class="op">=</span> [clf.score(X_test, y_test) <span class="cf">for</span> clf <span class="kw">in</span> clfs]</span>
<span id="cb35-3"><a href="#cb35-3"></a></span>
<span id="cb35-4"><a href="#cb35-4"></a>fig, ax <span class="op">=</span> plt.subplots()</span>
<span id="cb35-5"><a href="#cb35-5"></a>ax.set_xlabel(<span class="st">"alpha"</span>)</span>
<span id="cb35-6"><a href="#cb35-6"></a>ax.set_ylabel(<span class="st">"accuracy"</span>)</span>
<span id="cb35-7"><a href="#cb35-7"></a>ax.set_title(<span class="st">"Accuracy vs alpha for training and testing sets"</span>)</span>
<span id="cb35-8"><a href="#cb35-8"></a>ax.plot(ccp_alphas, train_scores, marker<span class="op">=</span><span class="st">"o"</span>, label<span class="op">=</span><span class="st">"train"</span>, drawstyle<span class="op">=</span><span class="st">"steps-post"</span>)</span>
<span id="cb35-9"><a href="#cb35-9"></a>ax.plot(ccp_alphas, test_scores, marker<span class="op">=</span><span class="st">"o"</span>, label<span class="op">=</span><span class="st">"test"</span>, drawstyle<span class="op">=</span><span class="st">"steps-post"</span>)</span>
<span id="cb35-10"><a href="#cb35-10"></a>ax.legend()</span>
<span id="cb35-11"><a href="#cb35-11"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-23-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>Other metrics <code>min_samples_leaf</code> and <code>max_depth</code> can also be used to prevent a tree from overfiting</p>
</section>
<section id="fitting-regression-trees" class="level2" data-number="8.3">
<h2 data-number="8.3" class="anchored" data-anchor-id="fitting-regression-trees"><span class="header-section-number">8.3</span> Fitting Regression Trees</h2>
<p>Here we fit a regression tree to the <code>Boston</code> data set. First, we create a training set, and fit the tree to the training data.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:414,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900370158,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="e4d9f326-f7f4-432c-a810-cfdb81a5e987" data-execution_count="121">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb36-1"><a href="#cb36-1"></a><span class="co"># Load 'Boston' data</span></span>
<span id="cb36-2"><a href="#cb36-2"></a>Boston <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Boston.csv'</span>)</span>
<span id="cb36-3"><a href="#cb36-3"></a>Boston <span class="op">=</span> Boston.drop(<span class="st">'Unnamed: 0'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb36-4"><a href="#cb36-4"></a>Boston.info()    <span class="co"># all numeric.  no Null,  Nice </span></span>
<span id="cb36-5"><a href="#cb36-5"></a>Boston.head()   </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>&lt;class 'pandas.core.frame.DataFrame'&gt;
RangeIndex: 506 entries, 0 to 505
Data columns (total 13 columns):
 #   Column   Non-Null Count  Dtype  
---  ------   --------------  -----  
 0   crim     506 non-null    float64
 1   zn       506 non-null    float64
 2   indus    506 non-null    float64
 3   chas     506 non-null    int64  
 4   nox      506 non-null    float64
 5   rm       506 non-null    float64
 6   age      506 non-null    float64
 7   dis      506 non-null    float64
 8   rad      506 non-null    int64  
 9   tax      506 non-null    int64  
 10  ptratio  506 non-null    float64
 11  lstat    506 non-null    float64
 12  medv     506 non-null    float64
dtypes: float64(10), int64(3)
memory usage: 51.5 KB</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="121">

  <div id="df-34f5128c-d5a7-4189-bce9-937cdf33063b">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">crim</th>
<th data-quarto-table-cell-role="th">zn</th>
<th data-quarto-table-cell-role="th">indus</th>
<th data-quarto-table-cell-role="th">chas</th>
<th data-quarto-table-cell-role="th">nox</th>
<th data-quarto-table-cell-role="th">rm</th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">dis</th>
<th data-quarto-table-cell-role="th">rad</th>
<th data-quarto-table-cell-role="th">tax</th>
<th data-quarto-table-cell-role="th">ptratio</th>
<th data-quarto-table-cell-role="th">lstat</th>
<th data-quarto-table-cell-role="th">medv</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>0.00632</td>
<td>18.0</td>
<td>2.31</td>
<td>0</td>
<td>0.538</td>
<td>6.575</td>
<td>65.2</td>
<td>4.0900</td>
<td>1</td>
<td>296</td>
<td>15.3</td>
<td>4.98</td>
<td>24.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>0.02731</td>
<td>0.0</td>
<td>7.07</td>
<td>0</td>
<td>0.469</td>
<td>6.421</td>
<td>78.9</td>
<td>4.9671</td>
<td>2</td>
<td>242</td>
<td>17.8</td>
<td>9.14</td>
<td>21.6</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>0.02729</td>
<td>0.0</td>
<td>7.07</td>
<td>0</td>
<td>0.469</td>
<td>7.185</td>
<td>61.1</td>
<td>4.9671</td>
<td>2</td>
<td>242</td>
<td>17.8</td>
<td>4.03</td>
<td>34.7</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>0.03237</td>
<td>0.0</td>
<td>2.18</td>
<td>0</td>
<td>0.458</td>
<td>6.998</td>
<td>45.8</td>
<td>6.0622</td>
<td>3</td>
<td>222</td>
<td>18.7</td>
<td>2.94</td>
<td>33.4</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>0.06905</td>
<td>0.0</td>
<td>2.18</td>
<td>0</td>
<td>0.458</td>
<td>7.147</td>
<td>54.2</td>
<td>6.0622</td>
<td>3</td>
<td>222</td>
<td>18.7</td>
<td>5.33</td>
<td>36.2</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-34f5128c-d5a7-4189-bce9-937cdf33063b')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-34f5128c-d5a7-4189-bce9-937cdf33063b button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-34f5128c-d5a7-4189-bce9-937cdf33063b');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900370676,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="122">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1"></a>X <span class="op">=</span> Boston.drop(<span class="st">'medv'</span>, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb38-2"><a href="#cb38-2"></a>y <span class="op">=</span> Boston.medv</span>
<span id="cb38-3"><a href="#cb38-3"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, train_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900371698,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="b1dd9a51-245f-4753-981e-522f88e9a61c" data-execution_count="123">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1"></a>reg_tree <span class="op">=</span> DecisionTreeRegressor(max_depth<span class="op">=</span><span class="dv">3</span>, min_samples_leaf<span class="op">=</span><span class="dv">5</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb39-2"><a href="#cb39-2"></a>reg_tree.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="123">
<pre><code>DecisionTreeRegressor(max_depth=3, min_samples_leaf=5, random_state=1)</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1921,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900374723,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="47eb3edc-ce16-4a78-d73e-7db78e6de0b9" data-execution_count="124">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">40</span>,<span class="dv">24</span>))</span>
<span id="cb41-2"><a href="#cb41-2"></a>tree.plot_tree(reg_tree, feature_names<span class="op">=</span>X.columns,  </span>
<span id="cb41-3"><a href="#cb41-3"></a>                    class_names<span class="op">=</span>[<span class="st">'No'</span>,<span class="st">'Yes'</span>],</span>
<span id="cb41-4"><a href="#cb41-4"></a>                    filled<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb41-5"><a href="#cb41-5"></a>plt.show()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-27-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The variable <code>lstat</code> measures the percentage of individuals with {lower socioeconomic status}, while the variable <code>rm</code> corresponds to the average number of rooms. The tree indicates that larger values of <code>rm</code>, or lower values of <code>lstat</code>, correspond to more expensive houses.</p>
<p>Now we use the cross validation to see whether pruning the tree will improve performance.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1885,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900378720,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="4afd77e3-1347-4676-cc76-3bcfe62a7a8f" data-execution_count="125">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb42-1"><a href="#cb42-1"></a>tree_sizes <span class="op">=</span> <span class="bu">range</span>(<span class="dv">2</span>, <span class="dv">50</span>)</span>
<span id="cb42-2"><a href="#cb42-2"></a></span>
<span id="cb42-3"><a href="#cb42-3"></a>k <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb42-4"><a href="#cb42-4"></a>kf5 <span class="op">=</span> KFold(n_splits<span class="op">=</span>k, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-5"><a href="#cb42-5"></a></span>
<span id="cb42-6"><a href="#cb42-6"></a>MSE_scores <span class="op">=</span> []</span>
<span id="cb42-7"><a href="#cb42-7"></a></span>
<span id="cb42-8"><a href="#cb42-8"></a><span class="co"># 7-Fold CV for each tree size </span></span>
<span id="cb42-9"><a href="#cb42-9"></a><span class="cf">for</span> size <span class="kw">in</span> tree_sizes:</span>
<span id="cb42-10"><a href="#cb42-10"></a>    reg_tree <span class="op">=</span> DecisionTreeRegressor(max_leaf_nodes<span class="op">=</span>size, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb42-11"><a href="#cb42-11"></a>    MSE_s <span class="op">=</span> <span class="op">-</span>cross_val_score(reg_tree, X, y, cv<span class="op">=</span>kf5, scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>)</span>
<span id="cb42-12"><a href="#cb42-12"></a>    MSE_scores.append(np.mean(MSE_s))</span>
<span id="cb42-13"><a href="#cb42-13"></a>    </span>
<span id="cb42-14"><a href="#cb42-14"></a><span class="co"># plot CV-MSE as tree size gets bigger </span></span>
<span id="cb42-15"><a href="#cb42-15"></a>plt.plot(tree_sizes, MSE_scores)</span>
<span id="cb42-16"><a href="#cb42-16"></a>plt.title(<span class="st">'5-CV MSE'</span>)</span>
<span id="cb42-17"><a href="#cb42-17"></a>plt.xlabel(<span class="st">'Tree Size'</span>)</span>
<span id="cb42-18"><a href="#cb42-18"></a>plt.ylabel(<span class="st">'MSE'</span>)</span>
<span id="cb42-19"><a href="#cb42-19"></a>plt.grid(<span class="va">True</span>)</span>
<span id="cb42-20"><a href="#cb42-20"></a></span>
<span id="cb42-21"><a href="#cb42-21"></a><span class="bu">print</span>(<span class="st">"best tree size = "</span>, tree_sizes[np.argmin(MSE_scores)]) <span class="co">#np.argmin(MSE_scores)=5</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>best tree size =  7</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-28-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:6,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900378720,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="fccd4d27-9038-4717-bc3b-770a4a25df59" data-execution_count="126">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1"></a>reg_tree <span class="op">=</span> DecisionTreeRegressor(max_leaf_nodes<span class="op">=</span><span class="dv">7</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb44-2"><a href="#cb44-2"></a>reg_tree.fit(X_train, y_train)</span>
<span id="cb44-3"><a href="#cb44-3"></a>pred <span class="op">=</span> reg_tree.predict(X_test)</span>
<span id="cb44-4"><a href="#cb44-4"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb44-5"><a href="#cb44-5"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb44-6"><a href="#cb44-6"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>17.924645209941158 4.2337507260042075</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:531,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900379247,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="40a3cd72-7555-4b03-fbc3-5c12cd8a05be" data-execution_count="127">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1"></a>plt.scatter(pred, y_test, label<span class="op">=</span><span class="st">'medv'</span>)</span>
<span id="cb46-2"><a href="#cb46-2"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'--k'</span>, transform<span class="op">=</span>plt.gca().transAxes)</span>
<span id="cb46-3"><a href="#cb46-3"></a>plt.xlabel(<span class="st">'pred'</span>)</span>
<span id="cb46-4"><a href="#cb46-4"></a>plt.ylabel(<span class="st">'y_test'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="127">
<pre><code>Text(0, 0.5, 'y_test')</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-30-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>In other words, the test set MSE associated with the regression tree is <span class="math inline">\(17.92\)</span>. The square root of the MSE is therefore around <span class="math inline">\(4.234\)</span>, indicating that this model leads to test predictions that are (on average) within approximately <span class="math inline">\(4,234\)</span> of the true median home value for the census tract.</p>
</section>
<section id="bagging-and-random-forests" class="level2" data-number="8.4">
<h2 data-number="8.4" class="anchored" data-anchor-id="bagging-and-random-forests"><span class="header-section-number">8.4</span> Bagging and Random Forests</h2>
<p>Here we apply bagging and random forests to the <code>Boston</code> data. Recall that <strong>bagging</strong> is simply a special case of a <strong>random forest</strong> with <span class="math inline">\(m = p\)</span>. Therefore, the <code>RandomForestRegressor()</code> function can be used to perform both random forests and bagging. Let’s start with bagging:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900379247,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="373af5cd-f9ea-42c6-c256-c23cbdf77779" data-execution_count="128">
<div class="sourceCode cell-code" id="cb48"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb48-1"><a href="#cb48-1"></a><span class="co"># Bagging: using all features</span></span>
<span id="cb48-2"><a href="#cb48-2"></a>max_features <span class="op">=</span> X.shape[<span class="dv">1</span>]</span>
<span id="cb48-3"><a href="#cb48-3"></a>tree_count   <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb48-4"><a href="#cb48-4"></a>regr1 <span class="op">=</span> RandomForestRegressor(max_features<span class="op">=</span>max_features, random_state<span class="op">=</span><span class="dv">2</span>, n_estimators<span class="op">=</span>tree_count)</span>
<span id="cb48-5"><a href="#cb48-5"></a>regr1.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="128">
<pre><code>RandomForestRegressor(max_features=12, random_state=2)</code></pre>
</div>
</div>
<p>The argument <code>max_features=12</code> indicates that all 12 predictors should be considered for each split of the tree – in other words, that bagging should be done. How well does this bagged model perform on the test set?</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:697,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900379941,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="cf570bb9-6ebd-493c-a316-8b1cd61934b7" data-execution_count="129">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1"></a>pred <span class="op">=</span> regr1.predict(X_test)</span>
<span id="cb50-2"><a href="#cb50-2"></a>plt.scatter(pred, y_test, label<span class="op">=</span><span class="st">'medv'</span>)</span>
<span id="cb50-3"><a href="#cb50-3"></a>plt.plot([<span class="dv">0</span>, <span class="dv">1</span>], [<span class="dv">0</span>, <span class="dv">1</span>], <span class="st">'--k'</span>, transform<span class="op">=</span>plt.gca().transAxes)</span>
<span id="cb50-4"><a href="#cb50-4"></a>plt.xlabel(<span class="st">'pred'</span>)</span>
<span id="cb50-5"><a href="#cb50-5"></a>plt.ylabel(<span class="st">'y_test'</span>)</span>
<span id="cb50-6"><a href="#cb50-6"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb50-7"><a href="#cb50-7"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb50-8"><a href="#cb50-8"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>11.56611499209486 3.4008991446520227</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-32-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We can grow a random forest in exactly the same way, except that we’ll use a smaller value of the <code>max_features</code> argument. Here we’ll use <code>max_features = 6</code>:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900379941,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="45c72ef4-b48b-45fb-fe0e-7abaf9d37c2a" data-execution_count="130">
<div class="sourceCode cell-code" id="cb52"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb52-1"><a href="#cb52-1"></a><span class="co"># Random forests: using 6 features</span></span>
<span id="cb52-2"><a href="#cb52-2"></a>tree_count   <span class="op">=</span> <span class="dv">100</span></span>
<span id="cb52-3"><a href="#cb52-3"></a>regr2 <span class="op">=</span> RandomForestRegressor(max_features<span class="op">=</span><span class="dv">6</span>, random_state<span class="op">=</span><span class="dv">2</span>, n_estimators<span class="op">=</span>tree_count)</span>
<span id="cb52-4"><a href="#cb52-4"></a>regr2.fit(X_train, y_train)</span>
<span id="cb52-5"><a href="#cb52-5"></a></span>
<span id="cb52-6"><a href="#cb52-6"></a>pred <span class="op">=</span> regr2.predict(X_test)</span>
<span id="cb52-7"><a href="#cb52-7"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb52-8"><a href="#cb52-8"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb52-9"><a href="#cb52-9"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>11.210173703557313 3.3481597488108767</code></pre>
</div>
</div>
<p>The test set MSE is even lower; this indicates that random forests yielded an improvement over bagging in this case.</p>
<p>Using the <code>feature_importances</code> attribute of the <code>RandomForestRegressor</code>, we can view the importance of each variable:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900379941,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="37ac9118-8404-46bc-9510-602b663f93f4" data-execution_count="131">
<div class="sourceCode cell-code" id="cb54"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb54-1"><a href="#cb54-1"></a>Importance <span class="op">=</span> pd.DataFrame({<span class="st">'Importance'</span>:regr2.feature_importances_}, index<span class="op">=</span>X.columns)</span>
<span id="cb54-2"><a href="#cb54-2"></a>Importance.sort_values(by<span class="op">=</span><span class="st">'Importance'</span>, axis<span class="op">=</span><span class="dv">0</span>, ascending<span class="op">=</span><span class="va">True</span>).plot(kind<span class="op">=</span><span class="st">'barh'</span>, color<span class="op">=</span><span class="st">'r'</span>, )</span>
<span id="cb54-3"><a href="#cb54-3"></a>plt.xlabel(<span class="st">'Variable Importance'</span>)</span>
<span id="cb54-4"><a href="#cb54-4"></a>plt.gca().legend_ <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-34-output-1.png" class="img-fluid"></p>
</div>
</div>
<p>The results indicate that across all of the trees considered in the random forest, the wealth of the community (<code>lstat</code>) and the house size (<code>rm</code>) are by far the two most important variables.</p>
</section>
<section id="boosting" class="level2" data-number="8.5">
<h2 data-number="8.5" class="anchored" data-anchor-id="boosting"><span class="header-section-number">8.5</span> Boosting</h2>
<p>Here we use the <code>GradientBoostingRegressor()</code> function, to fit boosted regression trees to the <code>Boston</code> data set.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:376,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900380685,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="bac47703-f606-4676-8de4-633427993c44" data-execution_count="132">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1"></a><span class="co"># Gradient boosting</span></span>
<span id="cb55-2"><a href="#cb55-2"></a></span>
<span id="cb55-3"><a href="#cb55-3"></a>params <span class="op">=</span> {<span class="st">'n_estimators'</span>: <span class="dv">500</span>, <span class="st">'max_depth'</span>: <span class="dv">4</span>, <span class="st">'min_samples_split'</span>: <span class="dv">2</span>, <span class="st">'max_features'</span>: <span class="st">'sqrt'</span>, <span class="st">'subsample'</span> : <span class="fl">0.9</span>,</span>
<span id="cb55-4"><a href="#cb55-4"></a>          <span class="st">'learning_rate'</span>: <span class="fl">0.01</span>, <span class="st">'loss'</span>: <span class="st">'squared_error'</span>, <span class="st">'random_state'</span>: <span class="dv">1</span>}</span>
<span id="cb55-5"><a href="#cb55-5"></a></span>
<span id="cb55-6"><a href="#cb55-6"></a>regr3   <span class="op">=</span> GradientBoostingRegressor(<span class="op">**</span>params)</span>
<span id="cb55-7"><a href="#cb55-7"></a>regr3.fit(X_train, y_train)</span>
<span id="cb55-8"><a href="#cb55-8"></a></span>
<span id="cb55-9"><a href="#cb55-9"></a>pred <span class="op">=</span> regr3.predict(X_test)</span>
<span id="cb55-10"><a href="#cb55-10"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb55-11"><a href="#cb55-11"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb55-12"><a href="#cb55-12"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10.585712502747185 3.2535691943997724</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900380685,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="d8f7621d-0ca8-4938-c7c7-5dffa51a5b0f" data-execution_count="133">
<div class="sourceCode cell-code" id="cb57"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb57-1"><a href="#cb57-1"></a><span class="co"># Gradient boosting</span></span>
<span id="cb57-2"><a href="#cb57-2"></a></span>
<span id="cb57-3"><a href="#cb57-3"></a>params <span class="op">=</span> {<span class="st">'n_estimators'</span>: <span class="dv">100</span>, <span class="st">'max_features'</span>: <span class="st">'sqrt'</span>, </span>
<span id="cb57-4"><a href="#cb57-4"></a>          <span class="st">'learning_rate'</span>: <span class="fl">0.1</span>, <span class="st">'random_state'</span>: <span class="dv">10</span>}</span>
<span id="cb57-5"><a href="#cb57-5"></a></span>
<span id="cb57-6"><a href="#cb57-6"></a>regr3   <span class="op">=</span> GradientBoostingRegressor(<span class="op">**</span>params)</span>
<span id="cb57-7"><a href="#cb57-7"></a>regr3.fit(X_train, y_train)</span>
<span id="cb57-8"><a href="#cb57-8"></a></span>
<span id="cb57-9"><a href="#cb57-9"></a>pred <span class="op">=</span> regr3.predict(X_test)</span>
<span id="cb57-10"><a href="#cb57-10"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb57-11"><a href="#cb57-11"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb57-12"><a href="#cb57-12"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>10.377996557875113 3.2214898040929936</code></pre>
</div>
</div>
<p>The test MSE obtained is <span class="math inline">\(10.38\)</span>: this is superior to the test MSE of random forests and bagging.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:585,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900381268,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="d978def5-eb4b-4c9f-dc74-163f2656105f" data-execution_count="134">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1"></a>test_score <span class="op">=</span> np.zeros((params[<span class="st">'n_estimators'</span>],), dtype<span class="op">=</span>np.float64)</span>
<span id="cb59-2"><a href="#cb59-2"></a></span>
<span id="cb59-3"><a href="#cb59-3"></a><span class="co"># compute test set deviance</span></span>
<span id="cb59-4"><a href="#cb59-4"></a><span class="cf">for</span> i, y_pred <span class="kw">in</span> <span class="bu">enumerate</span>(regr3.staged_predict(X_test)):   </span>
<span id="cb59-5"><a href="#cb59-5"></a>    test_score[i] <span class="op">=</span> regr3.loss_(y_test, y_pred)             </span>
<span id="cb59-6"><a href="#cb59-6"></a></span>
<span id="cb59-7"><a href="#cb59-7"></a>plt.figure(figsize<span class="op">=</span>(<span class="dv">12</span>, <span class="dv">6</span>))</span>
<span id="cb59-8"><a href="#cb59-8"></a>plt.subplot(<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">1</span>)</span>
<span id="cb59-9"><a href="#cb59-9"></a>plt.title(<span class="st">'Deviance (MSE) w.r.t. no. of estimators'</span>)</span>
<span id="cb59-10"><a href="#cb59-10"></a>plt.plot(np.arange(params[<span class="st">'n_estimators'</span>]) <span class="op">+</span> <span class="dv">1</span>, regr3.train_score_, <span class="st">'b-'</span>,</span>
<span id="cb59-11"><a href="#cb59-11"></a>         label<span class="op">=</span><span class="st">'Training Set Deviance'</span>)</span>
<span id="cb59-12"><a href="#cb59-12"></a>plt.plot(np.arange(params[<span class="st">'n_estimators'</span>]) <span class="op">+</span> <span class="dv">1</span>, test_score, <span class="st">'r-'</span>,</span>
<span id="cb59-13"><a href="#cb59-13"></a>         label<span class="op">=</span><span class="st">'Test Set Deviance'</span>)</span>
<span id="cb59-14"><a href="#cb59-14"></a>plt.legend(loc<span class="op">=</span><span class="st">'upper right'</span>)</span>
<span id="cb59-15"><a href="#cb59-15"></a>plt.xlabel(<span class="st">'Boosting Iterations'</span>)</span>
<span id="cb59-16"><a href="#cb59-16"></a>plt.ylabel(<span class="st">'Deviance (MSE)'</span>)</span>
<span id="cb59-17"><a href="#cb59-17"></a><span class="bu">print</span>(<span class="st">"Train/Test Split GBR with 500 estimators: </span><span class="sc">%.4f</span><span class="st">"</span> <span class="op">%</span> test_score[<span class="op">-</span><span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Train/Test Split GBR with 500 estimators: 10.3780</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-37-output-2.png" class="img-fluid"></p>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:509,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900381775,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="e41528e3-0604-4f50-bf47-2320afa157c6" data-execution_count="135">
<div class="sourceCode cell-code" id="cb61"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb61-1"><a href="#cb61-1"></a>feature_importance <span class="op">=</span> regr3.feature_importances_</span>
<span id="cb61-2"><a href="#cb61-2"></a>rel_imp <span class="op">=</span> pd.Series(feature_importance, index<span class="op">=</span>X.columns).sort_values(inplace<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb61-3"><a href="#cb61-3"></a><span class="bu">print</span>(rel_imp)</span>
<span id="cb61-4"><a href="#cb61-4"></a>rel_imp.T.plot(kind<span class="op">=</span><span class="st">'barh'</span>, color<span class="op">=</span><span class="st">'r'</span>, )</span>
<span id="cb61-5"><a href="#cb61-5"></a>plt.xlabel(<span class="st">'Variable Importance'</span>)</span>
<span id="cb61-6"><a href="#cb61-6"></a>plt.gca().legend_ <span class="op">=</span> <span class="va">None</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>chas       0.001323
rad        0.002557
zn         0.020765
age        0.023923
tax        0.051350
crim       0.061762
ptratio    0.075320
dis        0.096075
indus      0.098711
nox        0.105943
lstat      0.219331
rm         0.242939
dtype: float64</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-38-output-2.png" class="img-fluid"></p>
</div>
</div>
<p>We see that <code>lstat</code> and <code>rm</code> are by far the most important variables. We can also produce <em>partial dependence plots</em> for these two variables. These plots illustrate the marginal effect of the selected variables on the response after <em>integrating</em> out the other variables. In this case, as we might expect, median house prices are increasing with <code>rm</code> and decreasing with <code>lstat</code>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900382451,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="d4f3ff97-0f48-47f1-9297-26f9d221b693" data-execution_count="136">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1"></a><span class="co"># Partial Dependence Plots</span></span>
<span id="cb63-2"><a href="#cb63-2"></a>disp1 <span class="op">=</span> plot_partial_dependence(regr3,  X_train, [<span class="dv">5</span>, <span class="dv">11</span>], feature_names<span class="op">=</span>X.columns)  </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/sklearn/utils/deprecation.py:87: FutureWarning: Function plot_partial_dependence is deprecated; Function `plot_partial_dependence` is deprecated in 1.0 and will be removed in 1.2. Use PartialDependenceDisplay.from_estimator instead
  warnings.warn(msg, category=FutureWarning)</code></pre>
</div>
<div class="cell-output cell-output-display">
<p><img src="Chapter_8_Lab_files/figure-html/cell-39-output-2.png" class="img-fluid"></p>
</div>
</div>
<section id="adaboost" class="level3" data-number="8.5.1">
<h3 data-number="8.5.1" class="anchored" data-anchor-id="adaboost"><span class="header-section-number">8.5.1</span> AdaBoost</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900382767,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="27fcf54d-bd00-4c1b-9a86-da73cf9e3a3c" data-execution_count="137">
<div class="sourceCode cell-code" id="cb65"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb65-1"><a href="#cb65-1"></a>ada_regr <span class="op">=</span> AdaBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb65-2"><a href="#cb65-2"></a></span>
<span id="cb65-3"><a href="#cb65-3"></a>ada_regr.fit(X_train, y_train)</span>
<span id="cb65-4"><a href="#cb65-4"></a></span>
<span id="cb65-5"><a href="#cb65-5"></a>pred <span class="op">=</span> ada_regr.predict(X_test)</span>
<span id="cb65-6"><a href="#cb65-6"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb65-7"><a href="#cb65-7"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb65-8"><a href="#cb65-8"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>15.134274042481255 3.8902794298714913</code></pre>
</div>
</div>
<p>Check https://scikit-learn.org/stable/modules/ensemble.html#adaboost for more detail</p>
</section>
</section>
<section id="bayesian-additive-regression-trees" class="level2" data-number="8.6">
<h2 data-number="8.6" class="anchored" data-anchor-id="bayesian-additive-regression-trees"><span class="header-section-number">8.6</span> Bayesian Additive Regression Trees</h2>
<p>In this section we use the <code>bartpy</code> package, and within it the <code>SklearnModel()</code> function, to fit a Bayesian additive regression tree model to the <code>Boston</code> housing data set. <strong>On colab the following code may takes 5~10 minutes to run with default value</strong>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:386911,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667900773387,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="487dc865-2990-4c9a-f01a-7c5c691f66c7" data-execution_count="138">
<div class="sourceCode cell-code" id="cb67"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb67-1"><a href="#cb67-1"></a>model <span class="op">=</span> SklearnModel() <span class="co"># Use default parameters</span></span>
<span id="cb67-2"><a href="#cb67-2"></a>model.fit(X_train, y_train) <span class="co"># Fit the model</span></span>
<span id="cb67-3"><a href="#cb67-3"></a></span>
<span id="cb67-4"><a href="#cb67-4"></a>pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb67-5"><a href="#cb67-5"></a>mse <span class="op">=</span> mean_squared_error(y_test, pred)</span>
<span id="cb67-6"><a href="#cb67-6"></a>rmse <span class="op">=</span> np.sqrt(mse)</span>
<span id="cb67-7"><a href="#cb67-7"></a><span class="bu">print</span>(mse, rmse)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>13.771499662519378 3.710997125102548</code></pre>
</div>
</div>
<p>Chcek <a href="https://jakecoltman.github.io/bartpy/">https://jakecoltman.github.io/bartpy/</a> for more details</p>
</section>
<section id="xgboost" class="level2" data-number="8.7">
<h2 data-number="8.7" class="anchored" data-anchor-id="xgboost"><span class="header-section-number">8.7</span> XGBoost</h2>
<section id="classification-task" class="level3" data-number="8.7.1">
<h3 data-number="8.7.1" class="anchored" data-anchor-id="classification-task"><span class="header-section-number">8.7.1</span> Classification task</h3>
<p>Here are the essential steps to build an XGBoost classification model in scikit-learn using cross-validation.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:413,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898821529,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="678b5f83-ea27-489a-8d84-a0d7bb8ac31a">
<div class="sourceCode cell-code" id="cb69"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb69-1"><a href="#cb69-1"></a>iris <span class="op">=</span> datasets.load_iris()</span>
<span id="cb69-2"><a href="#cb69-2"></a>df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span> np.c_[iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>]],columns<span class="op">=</span> iris[<span class="st">'feature_names'</span>] <span class="op">+</span> [<span class="st">'target'</span>])</span>
<span id="cb69-3"><a href="#cb69-3"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">

  <div id="df-8d2806b2-53c5-4ace-8ba1-a5b7751d20f1">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">sepal length (cm)</th>
<th data-quarto-table-cell-role="th">sepal width (cm)</th>
<th data-quarto-table-cell-role="th">petal length (cm)</th>
<th data-quarto-table-cell-role="th">petal width (cm)</th>
<th data-quarto-table-cell-role="th">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>5.1</td>
<td>3.5</td>
<td>1.4</td>
<td>0.2</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>4.9</td>
<td>3.0</td>
<td>1.4</td>
<td>0.2</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>4.7</td>
<td>3.2</td>
<td>1.3</td>
<td>0.2</td>
<td>0.0</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>4.6</td>
<td>3.1</td>
<td>1.5</td>
<td>0.2</td>
<td>0.0</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>5.0</td>
<td>3.6</td>
<td>1.4</td>
<td>0.2</td>
<td>0.0</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-8d2806b2-53c5-4ace-8ba1-a5b7751d20f1')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-8d2806b2-53c5-4ace-8ba1-a5b7751d20f1 button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-8d2806b2-53c5-4ace-8ba1-a5b7751d20f1');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The following template is for building an XGBoost classifier</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1"></a>xgb <span class="op">=</span> XGBClassifier(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'multi:softprob'</span>, </span>
<span id="cb71-2"><a href="#cb71-2"></a>                    learning_rate<span class="op">=</span><span class="fl">0.1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<ol type="1">
<li><p><code>booster='gbtree'</code>: The booster is the base learner. It’s the machine learning model that is constructed during every round of boosting. You may have guessed that ‘gbtree’ stands for gradient boosted tree, the XGBoost default base learner. It’s uncommon but possible to work with other base learners,</p></li>
<li><p><code>objective='multi:softprob'</code>: Standard options for the objective can be viewed in the XGBoost official documentation, <a href="https://xgboost.readthedocs.io/en/latest/parameter.html">https://xgboost.readthedocs.io/en/latest/parameter.html</a>, under Learning Task Parameters. The multi:softprob objective is a standard alternative to binary:logistic when the dataset includes multiple classes. It computes the probabilities of classification and chooses the highest one. If not explicitly stated, XGBoost will often find the right objective for you.</p></li>
<li><p><code>max_depth=6</code>: The max_depth of a tree determines the number of branches each tree has. It’s one of the most important hyperparameters in making balanced predictions. XGBoost uses a default of 6, unlike random forests, which don’t provide a value unless explicitly programmed.</p></li>
<li><p><code>learning_rate=0.1</code>: Within XGBoost, this hyperparameter is often referred to as eta. This hyperparameter limits the variance by reducing the weight of each tree to the given percentage.</p></li>
<li><p><code>n_estimators=100</code>: Popular among ensemble methods, <code>n_estimators</code> is the number of boosted trees in the model. Increasing this number while decreasing <code>learning_rate</code> can lead to more robust results.</p></li>
</ol>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1072,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898853184,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="15d64aad-2a0f-4e83-9138-59e2b840beea">
<div class="sourceCode cell-code" id="cb72"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb72-1"><a href="#cb72-1"></a>xgb.fit(X_train, y_train)</span>
<span id="cb72-2"><a href="#cb72-2"></a>y_pred <span class="op">=</span> xgb.predict(X_test)</span>
<span id="cb72-3"><a href="#cb72-3"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb72-4"><a href="#cb72-4"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 1.0</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:274,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898856589,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="c9fa71b3-7d28-4dbc-f676-63872067cb49">
<div class="sourceCode cell-code" id="cb74"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb74-1"><a href="#cb74-1"></a>xgb.get_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="46">
<pre><code>{'objective': 'multi:softprob',
 'use_label_encoder': False,
 'base_score': 0.5,
 'booster': 'gbtree',
 'callbacks': None,
 'colsample_bylevel': 1,
 'colsample_bynode': 1,
 'colsample_bytree': 1,
 'early_stopping_rounds': None,
 'enable_categorical': False,
 'eval_metric': None,
 'gamma': 0,
 'gpu_id': -1,
 'grow_policy': 'depthwise',
 'importance_type': None,
 'interaction_constraints': '',
 'learning_rate': 0.1,
 'max_bin': 256,
 'max_cat_to_onehot': 4,
 'max_delta_step': 0,
 'max_depth': 6,
 'max_leaves': 0,
 'min_child_weight': 1,
 'missing': nan,
 'monotone_constraints': '()',
 'n_estimators': 100,
 'n_jobs': -1,
 'num_parallel_tree': 1,
 'predictor': 'auto',
 'random_state': 42,
 'reg_alpha': 0,
 'reg_lambda': 1,
 'sampling_method': 'uniform',
 'scale_pos_weight': None,
 'subsample': 1,
 'tree_method': 'exact',
 'validate_parameters': 1,
 'verbosity': None}</code></pre>
</div>
</div>
</section>
<section id="regression-task" class="level3" data-number="8.7.2">
<h3 data-number="8.7.2" class="anchored" data-anchor-id="regression-task"><span class="header-section-number">8.7.2</span> Regression task</h3>
<p>Here are the essential steps to build an XGBoost regression model in scikit-learn using cross-validation.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5345,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898871555,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="a65f2343-0c3f-42ca-da61-b3d776e8f0cf">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1"></a>X,y <span class="op">=</span> datasets.load_diabetes(return_X_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb76-2"><a href="#cb76-2"></a></span>
<span id="cb76-3"><a href="#cb76-3"></a>xgb <span class="op">=</span> XGBRegressor(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'reg:squarederror'</span>, </span>
<span id="cb76-4"><a href="#cb76-4"></a>                    learning_rate<span class="op">=</span><span class="fl">0.1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb76-5"><a href="#cb76-5"></a></span>
<span id="cb76-6"><a href="#cb76-6"></a>scores <span class="op">=</span> cross_val_score(xgb, X, y, scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>, cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb76-7"><a href="#cb76-7"></a></span>
<span id="cb76-8"><a href="#cb76-8"></a><span class="co"># Take square root of the scores</span></span>
<span id="cb76-9"><a href="#cb76-9"></a>rmse <span class="op">=</span> np.sqrt(<span class="op">-</span>scores)</span>
<span id="cb76-10"><a href="#cb76-10"></a></span>
<span id="cb76-11"><a href="#cb76-11"></a><span class="co"># Display accuracy</span></span>
<span id="cb76-12"><a href="#cb76-12"></a><span class="bu">print</span>(<span class="st">'RMSE:'</span>, np.<span class="bu">round</span>(rmse, <span class="dv">3</span>))</span>
<span id="cb76-13"><a href="#cb76-13"></a></span>
<span id="cb76-14"><a href="#cb76-14"></a><span class="co"># Display mean score</span></span>
<span id="cb76-15"><a href="#cb76-15"></a><span class="bu">print</span>(<span class="st">'RMSE mean: </span><span class="sc">%0.3f</span><span class="st">'</span> <span class="op">%</span> (rmse.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: [63.033 59.689 64.538 63.699 64.661]
RMSE mean: 63.124</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1799,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898876560,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="591110d0-1335-457a-eeef-4f87e45b6478">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1"></a>xgb.fit(X,y)</span>
<span id="cb78-2"><a href="#cb78-2"></a>xgb.get_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="48">
<pre><code>{'objective': 'reg:squarederror',
 'base_score': 0.5,
 'booster': 'gbtree',
 'callbacks': None,
 'colsample_bylevel': 1,
 'colsample_bynode': 1,
 'colsample_bytree': 1,
 'early_stopping_rounds': None,
 'enable_categorical': False,
 'eval_metric': None,
 'gamma': 0,
 'gpu_id': -1,
 'grow_policy': 'depthwise',
 'importance_type': None,
 'interaction_constraints': '',
 'learning_rate': 0.1,
 'max_bin': 256,
 'max_cat_to_onehot': 4,
 'max_delta_step': 0,
 'max_depth': 6,
 'max_leaves': 0,
 'min_child_weight': 1,
 'missing': nan,
 'monotone_constraints': '()',
 'n_estimators': 100,
 'n_jobs': -1,
 'num_parallel_tree': 1,
 'predictor': 'auto',
 'random_state': 42,
 'reg_alpha': 0,
 'reg_lambda': 1,
 'sampling_method': 'uniform',
 'scale_pos_weight': 1,
 'subsample': 1,
 'tree_method': 'exact',
 'validate_parameters': 1,
 'verbosity': None}</code></pre>
</div>
</div>
<p>Without a baseline of comparison, we have no idea what that score means. Converting the target column, <code>y</code>, into a pandas DataFrame with the <code>.describe()</code> method will give the quartiles and the general statistics of the predictor column, as follows:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:332,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898879093,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="c4abc6e4-d9ac-462d-ebb8-81800862b5c5">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1"></a>pd.DataFrame(y).describe()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="49">

  <div id="df-1b10b7da-0fe7-4c41-b383-f3fdc6ed582d">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">0</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">count</td>
<td>442.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">mean</td>
<td>152.133484</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">std</td>
<td>77.093005</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">min</td>
<td>25.000000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">25%</td>
<td>87.000000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">50%</td>
<td>140.500000</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">75%</td>
<td>211.500000</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">max</td>
<td>346.000000</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-1b10b7da-0fe7-4c41-b383-f3fdc6ed582d')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-1b10b7da-0fe7-4c41-b383-f3fdc6ed582d button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-1b10b7da-0fe7-4c41-b383-f3fdc6ed582d');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<p>A score of 63.124 is less than 1 standard deviation, a respectable result.</p>
</section>
<section id="speed-comparsion" class="level3" data-number="8.7.3">
<h3 data-number="8.7.3" class="anchored" data-anchor-id="speed-comparsion"><span class="header-section-number">8.7.3</span> Speed comparsion</h3>
<p>Let’s now compare <code>GradientBoostingClassifier</code> and <code>XGBoostClassifier</code> with the <a href="https://www.kaggle.com/datasets/keplersmachines/kepler-labelled-time-series-data">exoplanet dataset</a> for its speed</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7145,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898901068,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="af8df6c1-5024-4bfd-ed11-7daa0e7cfb80">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1"></a><span class="op">!</span>wget https:<span class="op">//</span>github.com<span class="op">/</span>PacktPublishing<span class="op">/</span>Hands<span class="op">-</span>On<span class="op">-</span>Gradient<span class="op">-</span>Boosting<span class="op">-</span><span class="cf">with</span><span class="op">-</span>XGBoost<span class="op">-</span><span class="kw">and</span><span class="op">-</span>Scikit<span class="op">-</span>learn<span class="op">/</span>raw<span class="op">/</span>master<span class="op">/</span>Chapter04<span class="op">/</span>exoplanets.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--2022-11-08 09:14:53--  https://github.com/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/raw/master/Chapter04/exoplanets.csv
Resolving github.com (github.com)... 140.82.112.3
Connecting to github.com (github.com)|140.82.112.3|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://media.githubusercontent.com/media/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/master/Chapter04/exoplanets.csv [following]
--2022-11-08 09:14:53--  https://media.githubusercontent.com/media/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/master/Chapter04/exoplanets.csv
Resolving media.githubusercontent.com (media.githubusercontent.com)... 185.199.110.133, 185.199.111.133, 185.199.109.133, ...
Connecting to media.githubusercontent.com (media.githubusercontent.com)|185.199.110.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 262223348 (250M) [text/plain]
Saving to: ‘exoplanets.csv’

exoplanets.csv      100%[===================&gt;] 250.08M   170MB/s    in 1.5s    

2022-11-08 09:14:59 (170 MB/s) - ‘exoplanets.csv’ saved [262223348/262223348]
</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5313,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667898908101,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="42d9e68b-aa2f-4970-8149-a058f889ad86">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'exoplanets.csv'</span>)</span>
<span id="cb83-2"><a href="#cb83-2"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="51">

  <div id="df-f73ec274-6933-459b-a18c-0892c88597ba">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">LABEL</th>
<th data-quarto-table-cell-role="th">FLUX.1</th>
<th data-quarto-table-cell-role="th">FLUX.2</th>
<th data-quarto-table-cell-role="th">FLUX.3</th>
<th data-quarto-table-cell-role="th">FLUX.4</th>
<th data-quarto-table-cell-role="th">FLUX.5</th>
<th data-quarto-table-cell-role="th">FLUX.6</th>
<th data-quarto-table-cell-role="th">FLUX.7</th>
<th data-quarto-table-cell-role="th">FLUX.8</th>
<th data-quarto-table-cell-role="th">FLUX.9</th>
<th data-quarto-table-cell-role="th">...</th>
<th data-quarto-table-cell-role="th">FLUX.3188</th>
<th data-quarto-table-cell-role="th">FLUX.3189</th>
<th data-quarto-table-cell-role="th">FLUX.3190</th>
<th data-quarto-table-cell-role="th">FLUX.3191</th>
<th data-quarto-table-cell-role="th">FLUX.3192</th>
<th data-quarto-table-cell-role="th">FLUX.3193</th>
<th data-quarto-table-cell-role="th">FLUX.3194</th>
<th data-quarto-table-cell-role="th">FLUX.3195</th>
<th data-quarto-table-cell-role="th">FLUX.3196</th>
<th data-quarto-table-cell-role="th">FLUX.3197</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>2</td>
<td>93.85</td>
<td>83.81</td>
<td>20.10</td>
<td>-26.98</td>
<td>-39.56</td>
<td>-124.71</td>
<td>-135.18</td>
<td>-96.27</td>
<td>-79.89</td>
<td>...</td>
<td>-78.07</td>
<td>-102.15</td>
<td>-102.15</td>
<td>25.13</td>
<td>48.57</td>
<td>92.54</td>
<td>39.32</td>
<td>61.42</td>
<td>5.08</td>
<td>-39.54</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>2</td>
<td>-38.88</td>
<td>-33.83</td>
<td>-58.54</td>
<td>-40.09</td>
<td>-79.31</td>
<td>-72.81</td>
<td>-86.55</td>
<td>-85.33</td>
<td>-83.97</td>
<td>...</td>
<td>-3.28</td>
<td>-32.21</td>
<td>-32.21</td>
<td>-24.89</td>
<td>-4.86</td>
<td>0.76</td>
<td>-11.70</td>
<td>6.46</td>
<td>16.00</td>
<td>19.93</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>2</td>
<td>532.64</td>
<td>535.92</td>
<td>513.73</td>
<td>496.92</td>
<td>456.45</td>
<td>466.00</td>
<td>464.50</td>
<td>486.39</td>
<td>436.56</td>
<td>...</td>
<td>-71.69</td>
<td>13.31</td>
<td>13.31</td>
<td>-29.89</td>
<td>-20.88</td>
<td>5.06</td>
<td>-11.80</td>
<td>-28.91</td>
<td>-70.02</td>
<td>-96.67</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>2</td>
<td>326.52</td>
<td>347.39</td>
<td>302.35</td>
<td>298.13</td>
<td>317.74</td>
<td>312.70</td>
<td>322.33</td>
<td>311.31</td>
<td>312.42</td>
<td>...</td>
<td>5.71</td>
<td>-3.73</td>
<td>-3.73</td>
<td>30.05</td>
<td>20.03</td>
<td>-12.67</td>
<td>-8.77</td>
<td>-17.31</td>
<td>-17.35</td>
<td>13.98</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>2</td>
<td>-1107.21</td>
<td>-1112.59</td>
<td>-1118.95</td>
<td>-1095.10</td>
<td>-1057.55</td>
<td>-1034.48</td>
<td>-998.34</td>
<td>-1022.71</td>
<td>-989.57</td>
<td>...</td>
<td>-594.37</td>
<td>-401.66</td>
<td>-401.66</td>
<td>-357.24</td>
<td>-443.76</td>
<td>-438.54</td>
<td>-399.71</td>
<td>-384.65</td>
<td>-411.79</td>
<td>-510.54</td>
</tr>
</tbody>
</table>


<p>5 rows × 3198 columns</p>
</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-f73ec274-6933-459b-a18c-0892c88597ba')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-f73ec274-6933-459b-a18c-0892c88597ba button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-f73ec274-6933-459b-a18c-0892c88597ba');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1"></a><span class="co"># Split data into X and y</span></span>
<span id="cb84-2"><a href="#cb84-2"></a>X <span class="op">=</span> df.iloc[:,<span class="dv">1</span>:]</span>
<span id="cb84-3"><a href="#cb84-3"></a>y <span class="op">=</span> df.iloc[:,<span class="dv">0</span>]</span>
<span id="cb84-4"><a href="#cb84-4"></a></span>
<span id="cb84-5"><a href="#cb84-5"></a><span class="co"># Split data into train and test sets</span></span>
<span id="cb84-6"><a href="#cb84-6"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, random_state<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:318364,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899246647,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="cb82ba5b-3566-429f-fb79-51aaefc46bfa">
<div class="sourceCode cell-code" id="cb85"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb85-1"><a href="#cb85-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb85-2"><a href="#cb85-2"></a></span>
<span id="cb85-3"><a href="#cb85-3"></a>gbr <span class="op">=</span> GradientBoostingClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, max_depth<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb85-4"><a href="#cb85-4"></a>gbr.fit(X_train, y_train)</span>
<span id="cb85-5"><a href="#cb85-5"></a>y_pred <span class="op">=</span> gbr.predict(X_test)</span>
<span id="cb85-6"><a href="#cb85-6"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb85-7"><a href="#cb85-7"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span>
<span id="cb85-8"><a href="#cb85-8"></a></span>
<span id="cb85-9"><a href="#cb85-9"></a>end <span class="op">=</span> time.time()</span>
<span id="cb85-10"><a href="#cb85-10"></a>elapsed <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb85-11"><a href="#cb85-11"></a></span>
<span id="cb85-12"><a href="#cb85-12"></a><span class="bu">print</span>(<span class="st">'Run Time: '</span> <span class="op">+</span> <span class="bu">str</span>(elapsed) <span class="op">+</span> <span class="st">' seconds'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 0.9874213836477987
Run Time: 318.0388216972351 seconds</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:72231,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899334461,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5b124484-97fc-4554-ec46-0aec45b07e56">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb87-2"><a href="#cb87-2"></a></span>
<span id="cb87-3"><a href="#cb87-3"></a><span class="co"># Instantiate the XGBRegressor, xg_reg</span></span>
<span id="cb87-4"><a href="#cb87-4"></a>xg_reg <span class="op">=</span> XGBClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, max_depth<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb87-5"><a href="#cb87-5"></a></span>
<span id="cb87-6"><a href="#cb87-6"></a><span class="co"># class column has to start from 0 (as required since version 1.3.2).</span></span>
<span id="cb87-7"><a href="#cb87-7"></a>le <span class="op">=</span> LabelEncoder() <span class="co"># https://scikit-learn.org/stable/modules/generated/sklearn.preprocessing.LabelEncoder.html</span></span>
<span id="cb87-8"><a href="#cb87-8"></a>y_train <span class="op">=</span> le.fit_transform(y_train)</span>
<span id="cb87-9"><a href="#cb87-9"></a>y_test <span class="op">=</span> le.fit_transform(y_test)</span>
<span id="cb87-10"><a href="#cb87-10"></a><span class="co"># Fit xg_reg to training set</span></span>
<span id="cb87-11"><a href="#cb87-11"></a>xg_reg.fit(X_train, y_train)</span>
<span id="cb87-12"><a href="#cb87-12"></a></span>
<span id="cb87-13"><a href="#cb87-13"></a><span class="co"># Predict labels of test set, y_pred</span></span>
<span id="cb87-14"><a href="#cb87-14"></a>y_pred <span class="op">=</span> xg_reg.predict(X_test)</span>
<span id="cb87-15"><a href="#cb87-15"></a></span>
<span id="cb87-16"><a href="#cb87-16"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb87-17"><a href="#cb87-17"></a></span>
<span id="cb87-18"><a href="#cb87-18"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span>
<span id="cb87-19"><a href="#cb87-19"></a></span>
<span id="cb87-20"><a href="#cb87-20"></a>end <span class="op">=</span> time.time()</span>
<span id="cb87-21"><a href="#cb87-21"></a>elapsed <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb87-22"><a href="#cb87-22"></a></span>
<span id="cb87-23"><a href="#cb87-23"></a><span class="bu">print</span>(<span class="st">'Run Time: '</span> <span class="op">+</span> <span class="bu">str</span>(elapsed) <span class="op">+</span> <span class="st">' seconds'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 0.9913522012578616
Run Time: 71.92710447311401 seconds</code></pre>
</div>
</div>
<p>When it comes to big data, an algorithm five as fast can save weeks or months of computational time and resources! This advantage is huge in the world of big data. In the world of boosting, XGBoost is the model of choice due to its unparalleled speed and impressive accuracy.</p>
</section>
<section id="hyperparameter" class="level3" data-number="8.7.4">
<h3 data-number="8.7.4" class="anchored" data-anchor-id="hyperparameter"><span class="header-section-number">8.7.4</span> Hyperparameter</h3>
<p>XGBoost has many hyperparameters. XGBoost base learner hyperparameters incorporate all decision tree hyperparameters as a starting point. There are gradient boosting hyperparameters, since XGBoost is an enhanced version of gradient boosting.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:776,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899360877,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="e8f478c1-1bf0-4c00-f923-52e3f26b7b6d">
<div class="sourceCode cell-code" id="cb89"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb89-1"><a href="#cb89-1"></a><span class="op">!</span>wget https:<span class="op">//</span>github.com<span class="op">/</span>PacktPublishing<span class="op">/</span>Hands<span class="op">-</span>On<span class="op">-</span>Gradient<span class="op">-</span>Boosting<span class="op">-</span><span class="cf">with</span><span class="op">-</span>XGBoost<span class="op">-</span><span class="kw">and</span><span class="op">-</span>Scikit<span class="op">-</span>learn<span class="op">/</span>raw<span class="op">/</span>master<span class="op">/</span>Chapter06<span class="op">/</span>heart_disease.csv</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>--2022-11-08 09:22:39--  https://github.com/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/raw/master/Chapter06/heart_disease.csv
Resolving github.com (github.com)... 140.82.114.4
Connecting to github.com (github.com)|140.82.114.4|:443... connected.
HTTP request sent, awaiting response... 302 Found
Location: https://media.githubusercontent.com/media/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/master/Chapter06/heart_disease.csv [following]
--2022-11-08 09:22:39--  https://media.githubusercontent.com/media/PacktPublishing/Hands-On-Gradient-Boosting-with-XGBoost-and-Scikit-learn/master/Chapter06/heart_disease.csv
Resolving media.githubusercontent.com (media.githubusercontent.com)... 185.199.108.133, 185.199.109.133, 185.199.110.133, ...
Connecting to media.githubusercontent.com (media.githubusercontent.com)|185.199.108.133|:443... connected.
HTTP request sent, awaiting response... 200 OK
Length: 11328 (11K) [text/plain]
Saving to: ‘heart_disease.csv’

heart_disease.csv   100%[===================&gt;]  11.06K  --.-KB/s    in 0s      

2022-11-08 09:22:39 (67.5 MB/s) - ‘heart_disease.csv’ saved [11328/11328]
</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899362569,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="2fed6f94-212b-44b2-e923-a26e8027b4f8">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'heart_disease.csv'</span>)</span>
<span id="cb91-2"><a href="#cb91-2"></a>df.head()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="59">

  <div id="df-84831230-2342-415b-8a55-41e7c8996fdf">
    <div class="colab-df-container">
      <div>


<table class="dataframe table table-sm table-striped small" data-quarto-postprocess="true" data-border="1">
<thead>
<tr class="header">
<th data-quarto-table-cell-role="th"></th>
<th data-quarto-table-cell-role="th">age</th>
<th data-quarto-table-cell-role="th">sex</th>
<th data-quarto-table-cell-role="th">cp</th>
<th data-quarto-table-cell-role="th">trestbps</th>
<th data-quarto-table-cell-role="th">chol</th>
<th data-quarto-table-cell-role="th">fbs</th>
<th data-quarto-table-cell-role="th">restecg</th>
<th data-quarto-table-cell-role="th">thalach</th>
<th data-quarto-table-cell-role="th">exang</th>
<th data-quarto-table-cell-role="th">oldpeak</th>
<th data-quarto-table-cell-role="th">slope</th>
<th data-quarto-table-cell-role="th">ca</th>
<th data-quarto-table-cell-role="th">thal</th>
<th data-quarto-table-cell-role="th">target</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td data-quarto-table-cell-role="th">0</td>
<td>63</td>
<td>1</td>
<td>3</td>
<td>145</td>
<td>233</td>
<td>1</td>
<td>0</td>
<td>150</td>
<td>0</td>
<td>2.3</td>
<td>0</td>
<td>0</td>
<td>1</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">1</td>
<td>37</td>
<td>1</td>
<td>2</td>
<td>130</td>
<td>250</td>
<td>0</td>
<td>1</td>
<td>187</td>
<td>0</td>
<td>3.5</td>
<td>0</td>
<td>0</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">2</td>
<td>41</td>
<td>0</td>
<td>1</td>
<td>130</td>
<td>204</td>
<td>0</td>
<td>0</td>
<td>172</td>
<td>0</td>
<td>1.4</td>
<td>2</td>
<td>0</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="even">
<td data-quarto-table-cell-role="th">3</td>
<td>56</td>
<td>1</td>
<td>1</td>
<td>120</td>
<td>236</td>
<td>0</td>
<td>1</td>
<td>178</td>
<td>0</td>
<td>0.8</td>
<td>2</td>
<td>0</td>
<td>2</td>
<td>1</td>
</tr>
<tr class="odd">
<td data-quarto-table-cell-role="th">4</td>
<td>57</td>
<td>0</td>
<td>0</td>
<td>120</td>
<td>354</td>
<td>0</td>
<td>1</td>
<td>163</td>
<td>1</td>
<td>0.6</td>
<td>2</td>
<td>0</td>
<td>2</td>
<td>1</td>
</tr>
</tbody>
</table>


</div>
      <button class="colab-df-convert" onclick="convertToInteractive('df-84831230-2342-415b-8a55-41e7c8996fdf')" title="Convert this dataframe to an interactive table." style="display:none;">
        
  <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewbox="0 0 24 24" width="24px">
    <path d="M0 0h24v24H0V0z" fill="none"></path>
    <path d="M18.56 5.44l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94zm-11 1L8.5 8.5l.94-2.06 2.06-.94-2.06-.94L8.5 2.5l-.94 2.06-2.06.94zm10 10l.94 2.06.94-2.06 2.06-.94-2.06-.94-.94-2.06-.94 2.06-2.06.94z"></path><path d="M17.41 7.96l-1.37-1.37c-.4-.4-.92-.59-1.43-.59-.52 0-1.04.2-1.43.59L10.3 9.45l-7.72 7.72c-.78.78-.78 2.05 0 2.83L4 21.41c.39.39.9.59 1.41.59.51 0 1.02-.2 1.41-.59l7.78-7.78 2.81-2.81c.8-.78.8-2.07 0-2.86zM5.41 20L4 18.59l7.72-7.72 1.47 1.35L5.41 20z"></path>
  </svg>
      </button>
      
  <style>
    .colab-df-container {
      display:flex;
      flex-wrap:wrap;
      gap: 12px;
    }

    .colab-df-convert {
      background-color: #E8F0FE;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: none;
      fill: #1967D2;
      height: 32px;
      padding: 0 0 0 0;
      width: 32px;
    }

    .colab-df-convert:hover {
      background-color: #E2EBFA;
      box-shadow: 0px 1px 2px rgba(60, 64, 67, 0.3), 0px 1px 3px 1px rgba(60, 64, 67, 0.15);
      fill: #174EA6;
    }

    [theme=dark] .colab-df-convert {
      background-color: #3B4455;
      fill: #D2E3FC;
    }

    [theme=dark] .colab-df-convert:hover {
      background-color: #434B5C;
      box-shadow: 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
      filter: drop-shadow(0px 1px 2px rgba(0, 0, 0, 0.3));
      fill: #FFFFFF;
    }
  </style>

      <script>
        const buttonEl =
          document.querySelector('#df-84831230-2342-415b-8a55-41e7c8996fdf button.colab-df-convert');
        buttonEl.style.display =
          google.colab.kernel.accessAllowed ? 'block' : 'none';

        async function convertToInteractive(key) {
          const element = document.querySelector('#df-84831230-2342-415b-8a55-41e7c8996fdf');
          const dataTable =
            await google.colab.kernel.invokeFunction('convertToInteractive',
                                                     [key], {});
          if (!dataTable) return;

          const docLinkHtml = 'Like what you see? Visit the ' +
            '<a target="_blank" href=https://colab.research.google.com/notebooks/data_table.ipynb>data table notebook</a>'
            + ' to learn more about interactive tables.';
          element.innerHTML = '';
          dataTable['output_type'] = 'display_data';
          await google.colab.output.renderOutput(dataTable, element);
          const docLink = document.createElement('div');
          docLink.innerHTML = docLinkHtml;
          element.appendChild(docLink);
        }
      </script>
    </div>
  </div>
  
</div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1"></a><span class="co"># Split data into X and y</span></span>
<span id="cb92-2"><a href="#cb92-2"></a>X <span class="op">=</span> df.iloc[:, :<span class="op">-</span><span class="dv">1</span>]</span>
<span id="cb92-3"><a href="#cb92-3"></a>y <span class="op">=</span> df.iloc[:, <span class="op">-</span><span class="dv">1</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Before tuning hyperparameters, let’s build a classifier so that we can obtain a baseline score as a starting point.</p>
<p>When fine-tuning hyperparameters, GridSearchCV and RandomizedSearchCV are the standard options. However, <code>cross_val_score</code> and <code>GridSearchCV/RandomizedSearchCV</code> do not split data the same way. One solution is to use <code>StratifiedKFold</code> whenever cross-validation is used.</p>
<p>A stratified fold includes the same percentage of target values in each fold. If a dataset contains 60% 1s and 40% 0s in the target column, each stratified test set contains 60% 1s and 40% 0s. When folds are random, it’s possible that one test set contains a 70-30 split while another contains a 50-50 split of target values.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1"></a>kfold <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span><span class="dv">5</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2379,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899377116,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="2a3cfa42-9623-4745-e959-3275c44e1f27">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1"></a><span class="co"># The 'binary:logistic' objective is standard for binary classification in determining the loss function</span></span>
<span id="cb94-2"><a href="#cb94-2"></a>model <span class="op">=</span> XGBClassifier(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'binary:logistic'</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb94-3"><a href="#cb94-3"></a><span class="co"># Obtain scores of cross-validation</span></span>
<span id="cb94-4"><a href="#cb94-4"></a>scores <span class="op">=</span> cross_val_score(model, X, y, cv<span class="op">=</span>kfold)</span>
<span id="cb94-5"><a href="#cb94-5"></a></span>
<span id="cb94-6"><a href="#cb94-6"></a><span class="co"># Display accuracy</span></span>
<span id="cb94-7"><a href="#cb94-7"></a><span class="bu">print</span>(<span class="st">'Accuracy:'</span>, np.<span class="bu">round</span>(scores, <span class="dv">2</span>))</span>
<span id="cb94-8"><a href="#cb94-8"></a></span>
<span id="cb94-9"><a href="#cb94-9"></a><span class="co"># Display mean accuracy</span></span>
<span id="cb94-10"><a href="#cb94-10"></a><span class="bu">print</span>(<span class="st">'Accuracy mean: </span><span class="sc">%0.2f</span><span class="st">'</span> <span class="op">%</span> (scores.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Accuracy: [0.85 0.72 0.74 0.82 0.78]
Accuracy mean: 0.78</code></pre>
</div>
</div>
<p>The point here is to use the same folds to obtain new scores when fine-tuning hyperparameters with GridSearchCV and RandomizedSearchCV so that the comparison of scores is fair.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1"></a><span class="kw">def</span> grid_search(params, random<span class="op">=</span><span class="va">False</span>): </span>
<span id="cb96-2"><a href="#cb96-2"></a>    </span>
<span id="cb96-3"><a href="#cb96-3"></a>    xgb <span class="op">=</span> XGBClassifier(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'binary:logistic'</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb96-4"><a href="#cb96-4"></a>    </span>
<span id="cb96-5"><a href="#cb96-5"></a>    kfold <span class="op">=</span> StratifiedKFold(n_splits<span class="op">=</span><span class="dv">5</span>, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb96-6"><a href="#cb96-6"></a>    </span>
<span id="cb96-7"><a href="#cb96-7"></a>    <span class="cf">if</span> random:</span>
<span id="cb96-8"><a href="#cb96-8"></a>        grid <span class="op">=</span> RandomizedSearchCV(xgb, params, cv<span class="op">=</span>kfold, n_iter<span class="op">=</span><span class="dv">20</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb96-9"><a href="#cb96-9"></a>    <span class="cf">else</span>:</span>
<span id="cb96-10"><a href="#cb96-10"></a>        <span class="co"># Instantiate GridSearchCV as grid_reg</span></span>
<span id="cb96-11"><a href="#cb96-11"></a>        grid <span class="op">=</span> GridSearchCV(xgb, params, cv<span class="op">=</span>kfold, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb96-12"><a href="#cb96-12"></a>    </span>
<span id="cb96-13"><a href="#cb96-13"></a>    <span class="co"># Fit grid_reg on X_train and y_train</span></span>
<span id="cb96-14"><a href="#cb96-14"></a>    grid.fit(X, y)</span>
<span id="cb96-15"><a href="#cb96-15"></a></span>
<span id="cb96-16"><a href="#cb96-16"></a>    <span class="co"># Extract best params</span></span>
<span id="cb96-17"><a href="#cb96-17"></a>    best_params <span class="op">=</span> grid.best_params_</span>
<span id="cb96-18"><a href="#cb96-18"></a></span>
<span id="cb96-19"><a href="#cb96-19"></a>    <span class="co"># Print best params</span></span>
<span id="cb96-20"><a href="#cb96-20"></a>    <span class="bu">print</span>(<span class="st">"Best params:"</span>, best_params)</span>
<span id="cb96-21"><a href="#cb96-21"></a>    </span>
<span id="cb96-22"><a href="#cb96-22"></a>    <span class="co"># Compute best score</span></span>
<span id="cb96-23"><a href="#cb96-23"></a>    best_score <span class="op">=</span> grid.best_score_</span>
<span id="cb96-24"><a href="#cb96-24"></a></span>
<span id="cb96-25"><a href="#cb96-25"></a>    <span class="co"># Print best score</span></span>
<span id="cb96-26"><a href="#cb96-26"></a>    <span class="bu">print</span>(<span class="st">"Best score: </span><span class="sc">{:.5f}</span><span class="st">"</span>.<span class="bu">format</span>(best_score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The XGBoost hyperparameters presented here are not meant to be exhaustive, but they are meant to be comprehensive. For a complete list of hyperparameters, read the official documentation, XGBoost Parameters, at <a href="https://xgboost.readthedocs.io/en/latest/parameter.html">https://xgboost.readthedocs.io/en/latest/parameter.html</a>.</p>
<section id="learning_rate" class="level4" data-number="8.7.4.1">
<h4 data-number="8.7.4.1" class="anchored" data-anchor-id="learning_rate"><span class="header-section-number">8.7.4.1</span> learning_rate</h4>
<p><code>learning_rate</code> shrinks the weights of trees for each round of boosting. By lowering <code>learning_rate</code>, more trees are required to produce better scores. Lowering <code>learning_rate</code> prevents overfitting because the size of the weights carried forward is smaller.</p>
<p>A default value of 0.3 is used. Here is a starting range for <code>learning_rate</code> as placed inside our grid_search function:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:13703,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899398344,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="ac02266e-aa91-4b54-bfd5-d035d2f96cd2">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'learning_rate'</span>:[<span class="fl">0.01</span>, <span class="fl">0.05</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.4</span>, <span class="fl">0.5</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'learning_rate': 0.5}
Best score: 0.80525</code></pre>
</div>
</div>
<p>lowering <code>learning_rate</code> may be advantageous when <code>n_estimators</code> goes up.</p>
</section>
<section id="max_depth" class="level4" data-number="8.7.4.2">
<h4 data-number="8.7.4.2" class="anchored" data-anchor-id="max_depth"><span class="header-section-number">8.7.4.2</span> max_depth</h4>
<p><code>max_depth</code> determines the length of the tree, equivalent to the number of rounds of splitting. Limiting <code>max_depth</code> prevents overfitting because the individual trees can only grow as far as <code>max_depth</code> allows. XGBoost provides a default <code>max_depth</code> value of six:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7808,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899406151,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="0164396c-367c-4cd6-bca2-8a6d887a0e78">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'max_depth'</span>:[<span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">5</span>, <span class="dv">6</span>, <span class="dv">8</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'max_depth': 2}
Best score: 0.79552</code></pre>
</div>
</div>
<p>Changing <code>max_depth</code> from 6 to 2 gave a better score. The lower value for <code>max_depth</code> means variance has been reduced.</p>
</section>
<section id="gamma" class="level4" data-number="8.7.4.3">
<h4 data-number="8.7.4.3" class="anchored" data-anchor-id="gamma"><span class="header-section-number">8.7.4.3</span> gamma</h4>
<p>Known as a Lagrange multiplier, <code>gamma</code> provides a threshold that nodes must surpass before making further splits according to the loss function. There is no upper limit to the value of <code>gamma</code>. The default is 0, and anything over 10 is considered very high. Increasing <code>gamma</code> results in a more conservative model:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:9638,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899415788,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="e3b0ca9f-ad20-4c4e-d3f3-3812e26d369c">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'gamma'</span>:[<span class="dv">0</span>, <span class="fl">0.01</span>, <span class="fl">0.1</span>, <span class="fl">0.5</span>, <span class="dv">1</span>, <span class="dv">2</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'gamma': 1}
Best score: 0.79880</code></pre>
</div>
</div>
<p>Changing gamma from 0 to 1 has resulted in a slight improvement.</p>
</section>
<section id="min_child_weight" class="level4" data-number="8.7.4.4">
<h4 data-number="8.7.4.4" class="anchored" data-anchor-id="min_child_weight"><span class="header-section-number">8.7.4.4</span> min_child_weight</h4>
<p><code>min_child_weight</code> refers to the minimum sum of weights required for a node to split into a child. If the sum of the weights is less than the value of <code>min_child_weight</code>, no further splits are made. <code>min_child_weight</code> reduces overfitting by increasing its value:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7216,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899423001,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="50358c93-b357-4550-a0a1-1dd91e646aa8">
<div class="sourceCode cell-code" id="cb103"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb103-1"><a href="#cb103-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'min_child_weight'</span>:[<span class="dv">1</span>, <span class="dv">2</span>, <span class="dv">3</span>, <span class="dv">4</span>, <span class="dv">5</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'min_child_weight': 5}
Best score: 0.81202</code></pre>
</div>
</div>
<p>A slight adjustment to <code>min_child_weight</code> form 1 to 5 gives the best results yet.</p>
</section>
<section id="subsample" class="level4" data-number="8.7.4.5">
<h4 data-number="8.7.4.5" class="anchored" data-anchor-id="subsample"><span class="header-section-number">8.7.4.5</span> subsample</h4>
<p>The <code>subsample</code> hyperparameter limits the percentage of training instances (rows) for each boosting round. Decreasing <code>subsample</code> from 100% reduces overfitting:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:8137,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899431131,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="449ede14-013d-4ade-aa21-b0d93f4be8eb">
<div class="sourceCode cell-code" id="cb105"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb105-1"><a href="#cb105-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'subsample'</span>:[<span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="dv">1</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'subsample': 0.5}
Best score: 0.82525</code></pre>
</div>
</div>
<p>The score has improved by a slight amount once again, indicating a small presence of overfitting.</p>
</section>
<section id="colsample_bytree" class="level4" data-number="8.7.4.6">
<h4 data-number="8.7.4.6" class="anchored" data-anchor-id="colsample_bytree"><span class="header-section-number">8.7.4.6</span> colsample_bytree</h4>
<p>Similar to <code>subsample</code>, <code>colsample_bytree</code> randomly selects particular columns according to the given percentage. <code>colsample_bytree</code> is useful for limiting the influence of columns and reducing variance. Note that <code>colsample_bytree</code> takes a percentage as input, not the number of columns:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:7689,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899438811,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="aa73f782-9d90-4dc1-a5e3-1dc68250effa">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'colsample_bytree'</span>:[<span class="fl">0.5</span>, <span class="fl">0.7</span>, <span class="fl">0.8</span>, <span class="fl">0.9</span>, <span class="dv">1</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'colsample_bytree': 0.5}
Best score: 0.79874</code></pre>
</div>
</div>
<p>You are encouraged to try <code>colsample_bylevel</code> and <code>colsample_bynode</code> on your own. <code>colsample_bylevel</code> randomly selects columns for each tree depth, and <code>colsample_bynode</code> randomly selects columns when evaluating each tree split.</p>
</section>
<section id="n_estimators" class="level4" data-number="8.7.4.7">
<h4 data-number="8.7.4.7" class="anchored" data-anchor-id="n_estimators"><span class="header-section-number">8.7.4.7</span> n_estimators</h4>
<p>Recall that <code>n_estimators</code> provides the number of trees in the ensemble. In the case of XGBoost, <code>n_estimators</code> is the number of trees trained on the residuals. Initialize a grid search of <code>n_estimators</code> with the default of 100, then double the number of trees through 800 as follows:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:25800,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899464602,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="be25aa41-f922-449f-ad90-966c00dc85ea">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1"></a>grid_search(params<span class="op">=</span>{<span class="st">'n_estimators'</span>:[<span class="dv">100</span>, <span class="dv">200</span>, <span class="dv">400</span>, <span class="dv">800</span>]})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Best params: {'n_estimators': 200}
Best score: 0.79219</code></pre>
</div>
</div>
<p>Since our dataset is small, increasing <code>n_estimators</code> did not produce better results.</p>
</section>
<section id="applying-early-stopping" class="level4" data-number="8.7.4.8">
<h4 data-number="8.7.4.8" class="anchored" data-anchor-id="applying-early-stopping"><span class="header-section-number">8.7.4.8</span> Applying early stopping</h4>
<p><code>early_stopping_rounds</code> is not a hyperparameter, but a strategy for optimizing the <code>n_estimators</code> hyperparameter.</p>
<p>Normally when choosing hyperparameters, a test score is given after all boosting rounds are complete. To use early stopping, we need a test score after each round. <code>eval_metric</code> and <code>eval_set</code> may be used as parameters for <code>.fit</code> to generate test scores for each training round. <code>eval_metric</code> provides the scoring method, commonly ‘error’ for classification, and ‘rmse’ for regression. <code>eval_set</code> provides the test to be evaluated, commonly X_test and y_test.</p>
<p>The following steps display an evaluation metric for each round of training with the default <code>n_estimators=100:</code></p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1651,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899466248,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="7c4e824c-fc0f-497a-f176-d0e27f974aba">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb111-2"><a href="#cb111-2"></a>model <span class="op">=</span> XGBClassifier(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'binary:logistic'</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb111-3"><a href="#cb111-3"></a>eval_set <span class="op">=</span> [(X_test, y_test)]</span>
<span id="cb111-4"><a href="#cb111-4"></a>eval_metric<span class="op">=</span><span class="st">'error'</span></span>
<span id="cb111-5"><a href="#cb111-5"></a>model.fit(X_train, y_train, eval_metric<span class="op">=</span>eval_metric, eval_set<span class="op">=</span>eval_set)</span>
<span id="cb111-6"><a href="#cb111-6"></a><span class="co"># make predictions for test data</span></span>
<span id="cb111-7"><a href="#cb111-7"></a>y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb111-8"><a href="#cb111-8"></a><span class="co"># evaluate predictions</span></span>
<span id="cb111-9"><a href="#cb111-9"></a>accuracy <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb111-10"><a href="#cb111-10"></a><span class="bu">print</span>(<span class="st">"Accuracy: </span><span class="sc">%.2f%%</span><span class="st">"</span> <span class="op">%</span> (accuracy <span class="op">*</span> <span class="fl">100.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0] validation_0-error:0.23684
[1] validation_0-error:0.22368
[2] validation_0-error:0.22368
[3] validation_0-error:0.21053
[4] validation_0-error:0.22368
[5] validation_0-error:0.18421
[6] validation_0-error:0.21053
[7] validation_0-error:0.22368
[8] validation_0-error:0.19737
[9] validation_0-error:0.19737
[10]    validation_0-error:0.18421
[11]    validation_0-error:0.18421
[12]    validation_0-error:0.19737</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/xgboost/sklearn.py:797: UserWarning: `eval_metric` in `fit` method is deprecated for better compatibility with scikit-learn, use `eval_metric` in constructor or`set_params` instead.
  UserWarning,</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[13]    validation_0-error:0.17105
[14]    validation_0-error:0.18421
[15]    validation_0-error:0.18421
[16]    validation_0-error:0.18421
[17]    validation_0-error:0.18421
[18]    validation_0-error:0.18421
[19]    validation_0-error:0.19737
[20]    validation_0-error:0.18421
[21]    validation_0-error:0.18421
[22]    validation_0-error:0.18421
[23]    validation_0-error:0.18421
[24]    validation_0-error:0.18421
[25]    validation_0-error:0.18421
[26]    validation_0-error:0.18421
[27]    validation_0-error:0.18421
[28]    validation_0-error:0.18421
[29]    validation_0-error:0.18421
[30]    validation_0-error:0.18421
[31]    validation_0-error:0.17105
[32]    validation_0-error:0.18421
[33]    validation_0-error:0.18421
[34]    validation_0-error:0.18421
[35]    validation_0-error:0.17105
[36]    validation_0-error:0.17105
[37]    validation_0-error:0.17105
[38]    validation_0-error:0.18421
[39]    validation_0-error:0.17105
[40]    validation_0-error:0.18421
[41]    validation_0-error:0.18421
[42]    validation_0-error:0.18421
[43]    validation_0-error:0.18421
[44]    validation_0-error:0.18421
[45]    validation_0-error:0.18421
[46]    validation_0-error:0.18421
[47]    validation_0-error:0.18421
[48]    validation_0-error:0.18421
[49]    validation_0-error:0.18421
[50]    validation_0-error:0.18421
[51]    validation_0-error:0.18421
[52]    validation_0-error:0.18421
[53]    validation_0-error:0.18421
[54]    validation_0-error:0.18421
[55]    validation_0-error:0.18421
[56]    validation_0-error:0.18421
[57]    validation_0-error:0.18421
[58]    validation_0-error:0.18421
[59]    validation_0-error:0.18421
[60]    validation_0-error:0.18421
[61]    validation_0-error:0.18421
[62]    validation_0-error:0.18421
[63]    validation_0-error:0.18421
[64]    validation_0-error:0.18421
[65]    validation_0-error:0.18421
[66]    validation_0-error:0.18421
[67]    validation_0-error:0.18421
[68]    validation_0-error:0.18421
[69]    validation_0-error:0.18421
[70]    validation_0-error:0.18421
[71]    validation_0-error:0.18421
[72]    validation_0-error:0.18421
[73]    validation_0-error:0.18421
[74]    validation_0-error:0.18421
[75]    validation_0-error:0.18421
[76]    validation_0-error:0.18421
[77]    validation_0-error:0.18421
[78]    validation_0-error:0.18421
[79]    validation_0-error:0.18421
[80]    validation_0-error:0.18421
[81]    validation_0-error:0.18421
[82]    validation_0-error:0.18421
[83]    validation_0-error:0.18421
[84]    validation_0-error:0.18421
[85]    validation_0-error:0.18421
[86]    validation_0-error:0.18421
[87]    validation_0-error:0.18421
[88]    validation_0-error:0.18421
[89]    validation_0-error:0.18421
[90]    validation_0-error:0.18421
[91]    validation_0-error:0.18421
[92]    validation_0-error:0.18421
[93]    validation_0-error:0.18421
[94]    validation_0-error:0.18421
[95]    validation_0-error:0.18421
[96]    validation_0-error:0.18421
[97]    validation_0-error:0.18421
[98]    validation_0-error:0.18421
[99]    validation_0-error:0.18421
Accuracy: 81.58%</code></pre>
</div>
</div>
<p>We know that <code>StratifiedKFold</code> cross-validation gives a mean accuracy of 78% when n_estimators=100. The disparity in scores comes from the difference in test sets.</p>
</section>
<section id="early_stopping_rounds" class="level4" data-number="8.7.4.9">
<h4 data-number="8.7.4.9" class="anchored" data-anchor-id="early_stopping_rounds"><span class="header-section-number">8.7.4.9</span> early_stopping_rounds</h4>
<p><code>early_stopping_rounds</code> is an optional parameter to include with <code>eval_metric</code> and <code>eval_set</code> when fitting a model. Let’s try <code>early_stopping_rounds=10</code>. The previous code is repeated with <code>early_stopping_rounds=10</code> added in:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:477,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899466716,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="a241b253-cc3b-44aa-c422-dc62f85b71de">
<div class="sourceCode cell-code" id="cb115"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb115-1"><a href="#cb115-1"></a>model <span class="op">=</span> XGBClassifier(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'binary:logistic'</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb115-2"><a href="#cb115-2"></a>eval_set <span class="op">=</span> [(X_test, y_test)]</span>
<span id="cb115-3"><a href="#cb115-3"></a>eval_metric<span class="op">=</span><span class="st">"error"</span></span>
<span id="cb115-4"><a href="#cb115-4"></a>model.fit(X_train, y_train, eval_metric<span class="op">=</span>eval_metric, eval_set<span class="op">=</span>eval_set, early_stopping_rounds<span class="op">=</span><span class="dv">10</span>, verbose<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb115-5"><a href="#cb115-5"></a>y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb115-6"><a href="#cb115-6"></a>accuracy <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb115-7"><a href="#cb115-7"></a><span class="bu">print</span>(<span class="st">"Accuracy: </span><span class="sc">%.2f%%</span><span class="st">"</span> <span class="op">%</span> (accuracy <span class="op">*</span> <span class="fl">100.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0] validation_0-error:0.23684
[1] validation_0-error:0.22368
[2] validation_0-error:0.22368
[3] validation_0-error:0.21053
[4] validation_0-error:0.22368
[5] validation_0-error:0.18421
[6] validation_0-error:0.21053
[7] validation_0-error:0.22368
[8] validation_0-error:0.19737</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/xgboost/sklearn.py:797: UserWarning: `eval_metric` in `fit` method is deprecated for better compatibility with scikit-learn, use `eval_metric` in constructor or`set_params` instead.
  UserWarning,
/usr/local/lib/python3.7/dist-packages/xgboost/sklearn.py:797: UserWarning: `early_stopping_rounds` in `fit` method is deprecated for better compatibility with scikit-learn, use `early_stopping_rounds` in constructor or`set_params` instead.
  UserWarning,</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[9] validation_0-error:0.19737
[10]    validation_0-error:0.18421
[11]    validation_0-error:0.18421
[12]    validation_0-error:0.19737
[13]    validation_0-error:0.17105
[14]    validation_0-error:0.18421
[15]    validation_0-error:0.18421
[16]    validation_0-error:0.18421
[17]    validation_0-error:0.18421
[18]    validation_0-error:0.18421
[19]    validation_0-error:0.19737
[20]    validation_0-error:0.18421
[21]    validation_0-error:0.18421
[22]    validation_0-error:0.18421
[23]    validation_0-error:0.18421
Accuracy: 82.89%</code></pre>
</div>
</div>
<p>A more thorough approach is to use larger values, say, <code>n_estimators = 5000</code> and <code>early_stopping_rounds=100</code>. By setting <code>early_stopping_rounds=100</code>, you are guaranteed to reach the default of 100 boosted trees presented by XGBoost. Here is the code that gives a maximum of 5,000 trees and that will stop after 100 consecutive rounds fail to find any improvement:</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1988,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899468698,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="ba0c07a9-38a4-4416-9d2a-c6e1a423ca8a">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1"></a>model <span class="op">=</span> XGBClassifier(random_state<span class="op">=</span><span class="dv">42</span>, n_estimators<span class="op">=</span><span class="dv">5000</span>)</span>
<span id="cb119-2"><a href="#cb119-2"></a>eval_set <span class="op">=</span> [(X_test, y_test)]</span>
<span id="cb119-3"><a href="#cb119-3"></a>eval_metric<span class="op">=</span><span class="st">"error"</span></span>
<span id="cb119-4"><a href="#cb119-4"></a>model.fit(X_train, y_train, eval_metric<span class="op">=</span>eval_metric, eval_set<span class="op">=</span>eval_set, early_stopping_rounds<span class="op">=</span><span class="dv">100</span>)</span>
<span id="cb119-5"><a href="#cb119-5"></a>y_pred <span class="op">=</span> model.predict(X_test)</span>
<span id="cb119-6"><a href="#cb119-6"></a>accuracy <span class="op">=</span> accuracy_score(y_test, y_pred)</span>
<span id="cb119-7"><a href="#cb119-7"></a><span class="bu">print</span>(<span class="st">"Accuracy: </span><span class="sc">%.2f%%</span><span class="st">"</span> <span class="op">%</span> (accuracy <span class="op">*</span> <span class="fl">100.0</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[0] validation_0-error:0.23684
[1] validation_0-error:0.22368
[2] validation_0-error:0.22368
[3] validation_0-error:0.21053
[4] validation_0-error:0.22368
[5] validation_0-error:0.18421
[6] validation_0-error:0.21053
[7] validation_0-error:0.22368
[8] validation_0-error:0.19737
[9] validation_0-error:0.19737
[10]    validation_0-error:0.18421
[11]    validation_0-error:0.18421</code></pre>
</div>
<div class="cell-output cell-output-stderr">
<pre><code>/usr/local/lib/python3.7/dist-packages/xgboost/sklearn.py:797: UserWarning: `eval_metric` in `fit` method is deprecated for better compatibility with scikit-learn, use `eval_metric` in constructor or`set_params` instead.
  UserWarning,
/usr/local/lib/python3.7/dist-packages/xgboost/sklearn.py:797: UserWarning: `early_stopping_rounds` in `fit` method is deprecated for better compatibility with scikit-learn, use `early_stopping_rounds` in constructor or`set_params` instead.
  UserWarning,</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>[12]    validation_0-error:0.19737
[13]    validation_0-error:0.17105
[14]    validation_0-error:0.18421
[15]    validation_0-error:0.18421
[16]    validation_0-error:0.18421
[17]    validation_0-error:0.18421
[18]    validation_0-error:0.18421
[19]    validation_0-error:0.19737
[20]    validation_0-error:0.18421
[21]    validation_0-error:0.18421
[22]    validation_0-error:0.18421
[23]    validation_0-error:0.18421
[24]    validation_0-error:0.18421
[25]    validation_0-error:0.18421
[26]    validation_0-error:0.18421
[27]    validation_0-error:0.18421
[28]    validation_0-error:0.18421
[29]    validation_0-error:0.18421
[30]    validation_0-error:0.18421
[31]    validation_0-error:0.17105
[32]    validation_0-error:0.18421
[33]    validation_0-error:0.18421
[34]    validation_0-error:0.18421
[35]    validation_0-error:0.17105
[36]    validation_0-error:0.17105
[37]    validation_0-error:0.17105
[38]    validation_0-error:0.18421
[39]    validation_0-error:0.17105
[40]    validation_0-error:0.18421
[41]    validation_0-error:0.18421
[42]    validation_0-error:0.18421
[43]    validation_0-error:0.18421
[44]    validation_0-error:0.18421
[45]    validation_0-error:0.18421
[46]    validation_0-error:0.18421
[47]    validation_0-error:0.18421
[48]    validation_0-error:0.18421
[49]    validation_0-error:0.18421
[50]    validation_0-error:0.18421
[51]    validation_0-error:0.18421
[52]    validation_0-error:0.18421
[53]    validation_0-error:0.18421
[54]    validation_0-error:0.18421
[55]    validation_0-error:0.18421
[56]    validation_0-error:0.18421
[57]    validation_0-error:0.18421
[58]    validation_0-error:0.18421
[59]    validation_0-error:0.18421
[60]    validation_0-error:0.18421
[61]    validation_0-error:0.18421
[62]    validation_0-error:0.18421
[63]    validation_0-error:0.18421
[64]    validation_0-error:0.18421
[65]    validation_0-error:0.18421
[66]    validation_0-error:0.18421
[67]    validation_0-error:0.18421
[68]    validation_0-error:0.18421
[69]    validation_0-error:0.18421
[70]    validation_0-error:0.18421
[71]    validation_0-error:0.18421
[72]    validation_0-error:0.18421
[73]    validation_0-error:0.18421
[74]    validation_0-error:0.18421
[75]    validation_0-error:0.18421
[76]    validation_0-error:0.18421
[77]    validation_0-error:0.18421
[78]    validation_0-error:0.18421
[79]    validation_0-error:0.18421
[80]    validation_0-error:0.18421
[81]    validation_0-error:0.18421
[82]    validation_0-error:0.18421
[83]    validation_0-error:0.18421
[84]    validation_0-error:0.18421
[85]    validation_0-error:0.18421
[86]    validation_0-error:0.18421
[87]    validation_0-error:0.18421
[88]    validation_0-error:0.18421
[89]    validation_0-error:0.18421
[90]    validation_0-error:0.18421
[91]    validation_0-error:0.18421
[92]    validation_0-error:0.18421
[93]    validation_0-error:0.18421
[94]    validation_0-error:0.18421
[95]    validation_0-error:0.18421
[96]    validation_0-error:0.18421
[97]    validation_0-error:0.18421
[98]    validation_0-error:0.18421
[99]    validation_0-error:0.18421
[100]   validation_0-error:0.18421
[101]   validation_0-error:0.18421
[102]   validation_0-error:0.18421
[103]   validation_0-error:0.18421
[104]   validation_0-error:0.18421
[105]   validation_0-error:0.18421
[106]   validation_0-error:0.18421
[107]   validation_0-error:0.18421
[108]   validation_0-error:0.18421
[109]   validation_0-error:0.18421
[110]   validation_0-error:0.18421
[111]   validation_0-error:0.18421
[112]   validation_0-error:0.18421
[113]   validation_0-error:0.18421
Accuracy: 82.89%</code></pre>
</div>
</div>
<p>After 100 rounds of boosting, the score provided by 13 trees is the best.</p>
</section>
<section id="automatically-hyperparamter-tuning" class="level4" data-number="8.7.4.10">
<h4 data-number="8.7.4.10" class="anchored" data-anchor-id="automatically-hyperparamter-tuning"><span class="header-section-number">8.7.4.10</span> Automatically hyperparamter tuning</h4>
<p>You are encourage to try <a href="https://github.com/optuna/optuna-examples/blob/main/xgboost/xgboost_simple.py">https://github.com/optuna/optuna-examples/blob/main/xgboost/xgboost_simple.py</a> for hyperparameter tuning.</p>
</section>
</section>
<section id="for-categorical-variable-and-missing-value" class="level3" data-number="8.7.5">
<h3 data-number="8.7.5" class="anchored" data-anchor-id="for-categorical-variable-and-missing-value"><span class="header-section-number">8.7.5</span> For categorical variable and missing value</h3>
<p>XGBoost has experiment support for categorical variable, you can check out here: <a href="https://xgboost.readthedocs.io/en/latest/tutorials/categorical.html">https://xgboost.readthedocs.io/en/latest/tutorials/categorical.html</a>. But it only works for a few tree methods, it is still recommend to encode your data <a href="https://www.kaggle.com/code/shahules/an-overview-of-encoding-techniques/notebook">https://www.kaggle.com/code/shahules/an-overview-of-encoding-techniques/notebook</a>. Missing value, on the other hand can be handled by XGBoost as described at <a href="https://xgboost.readthedocs.io/en/stable/faq.html#how-to-deal-with-missing-values">https://xgboost.readthedocs.io/en/stable/faq.html#how-to-deal-with-missing-values</a>.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2405,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899729834,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="1d1d6805-0c7f-4bfd-cee7-202f4f470c15" data-execution_count="75">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1"></a><span class="op">!</span>gdown <span class="dv">1</span><span class="er">WkuxuToarMFAHYIQ85SW20YSXrfJsMEH</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Downloading...
From: https://drive.google.com/uc?id=1WkuxuToarMFAHYIQ85SW20YSXrfJsMEH
To: /content/melb_data.csv
  0% 0.00/2.09M [00:00&lt;?, ?B/s]100% 2.09M/2.09M [00:00&lt;00:00, 36.3MB/s]</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:739,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899734108,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="76">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1"></a><span class="co"># Select target</span></span>
<span id="cb125-2"><a href="#cb125-2"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'melb_data.csv'</span>)</span>
<span id="cb125-3"><a href="#cb125-3"></a>y <span class="op">=</span> data.Price</span>
<span id="cb125-4"><a href="#cb125-4"></a></span>
<span id="cb125-5"><a href="#cb125-5"></a><span class="co"># To keep things simple, we'll split the columns into numerical can categorical features</span></span>
<span id="cb125-6"><a href="#cb125-6"></a>melb_predictors <span class="op">=</span> data.drop([<span class="st">'Price'</span>, <span class="st">'Date'</span>, <span class="st">'Address'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb125-7"><a href="#cb125-7"></a>cat_col <span class="op">=</span> melb_predictors.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb125-8"><a href="#cb125-8"></a></span>
<span id="cb125-9"><a href="#cb125-9"></a><span class="co"># Divide data into training and validation subsets</span></span>
<span id="cb125-10"><a href="#cb125-10"></a>X, X_v, y_train, y_valid <span class="op">=</span> train_test_split(melb_predictors, y, train_size<span class="op">=</span><span class="fl">0.8</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb125-11"><a href="#cb125-11"></a>X_train <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb125-12"><a href="#cb125-12"></a>X_valid <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb125-13"><a href="#cb125-13"></a>X_train_cat <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb125-14"><a href="#cb125-14"></a>X_valid_cat <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:435,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899738367,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="77">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1"></a><span class="cf">for</span> col <span class="kw">in</span> X_train_cat.columns:</span>
<span id="cb126-2"><a href="#cb126-2"></a>  X[col] <span class="op">=</span> X[col].astype(<span class="st">'category'</span>)</span>
<span id="cb126-3"><a href="#cb126-3"></a>  X_v[col] <span class="op">=</span> X_v[col].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1972,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899740337,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="62f4caac-75c0-41c4-eff0-031f261b24d7" data-execution_count="78">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1"></a>xgb <span class="op">=</span> XGBRegressor(booster<span class="op">=</span><span class="st">'gbtree'</span>, objective<span class="op">=</span><span class="st">'reg:squarederror'</span>, </span>
<span id="cb127-2"><a href="#cb127-2"></a>                    random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>) <span class="co"># You can either specify missing=-9999 or leave it as it is</span></span>
<span id="cb127-3"><a href="#cb127-3"></a>xgb.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="78">
<pre><code>XGBRegressor(base_score=0.5, booster='gbtree', callbacks=None,
             colsample_bylevel=1, colsample_bynode=1, colsample_bytree=1,
             early_stopping_rounds=None, enable_categorical=False,
             eval_metric=None, gamma=0, gpu_id=-1, grow_policy='depthwise',
             importance_type=None, interaction_constraints='',
             learning_rate=0.300000012, max_bin=256, max_cat_to_onehot=4,
             max_delta_step=0, max_depth=6, max_leaves=0, min_child_weight=1,
             missing=nan, monotone_constraints='()', n_estimators=100,
             n_jobs=-1, num_parallel_tree=1, predictor='auto', random_state=42,
             reg_alpha=0, reg_lambda=1, ...)</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899740338,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="79">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1"></a>preds <span class="op">=</span> xgb.predict(X_valid)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899740338,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="48620a39-6ff3-4a17-e4fe-3ef17d001b32" data-execution_count="80">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="80">
<pre><code>173639.76325478646</code></pre>
</div>
</div>
</section>
</section>
<section id="lightgbm" class="level2" data-number="8.8">
<h2 data-number="8.8" class="anchored" data-anchor-id="lightgbm"><span class="header-section-number">8.8</span> Lightgbm</h2>
<section id="classification-task-1" class="level3" data-number="8.8.1">
<h3 data-number="8.8.1" class="anchored" data-anchor-id="classification-task-1"><span class="header-section-number">8.8.1</span> Classification task</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899744390,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="81">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1"></a>iris <span class="op">=</span> datasets.load_iris()</span>
<span id="cb132-2"><a href="#cb132-2"></a>df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span> np.c_[iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>]],columns<span class="op">=</span> iris[<span class="st">'feature_names'</span>] <span class="op">+</span> [<span class="st">'target'</span>])</span>
<span id="cb132-3"><a href="#cb132-3"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899745726,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5299a64b-6f57-4c3e-e20b-b9f096359f0b" data-execution_count="82">
<div class="sourceCode cell-code" id="cb133"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb133-1"><a href="#cb133-1"></a>clf <span class="op">=</span> lgb.LGBMClassifier(boosting_type<span class="op">=</span><span class="st">'gbdt'</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb133-2"><a href="#cb133-2"></a>clf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="82">
<pre><code>LGBMClassifier(random_state=42)</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899746568,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="84e6f238-1d96-4399-d269-86fecfb073fb" data-execution_count="83">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1"></a>clf.fit(X_train, y_train)</span>
<span id="cb135-2"><a href="#cb135-2"></a>y_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb135-3"><a href="#cb135-3"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb135-4"><a href="#cb135-4"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 1.0</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899748714,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="e6add457-e0ed-4d0b-ce24-50bea8c74b55" data-execution_count="84">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1"></a>clf.get_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="84">
<pre><code>{'boosting_type': 'gbdt',
 'class_weight': None,
 'colsample_bytree': 1.0,
 'importance_type': 'split',
 'learning_rate': 0.1,
 'max_depth': -1,
 'min_child_samples': 20,
 'min_child_weight': 0.001,
 'min_split_gain': 0.0,
 'n_estimators': 100,
 'n_jobs': -1,
 'num_leaves': 31,
 'objective': None,
 'random_state': 42,
 'reg_alpha': 0.0,
 'reg_lambda': 0.0,
 'silent': 'warn',
 'subsample': 1.0,
 'subsample_for_bin': 200000,
 'subsample_freq': 0}</code></pre>
</div>
</div>
</section>
<section id="regression-task-1" class="level3" data-number="8.8.2">
<h3 data-number="8.8.2" class="anchored" data-anchor-id="regression-task-1"><span class="header-section-number">8.8.2</span> Regression task</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:441,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899751023,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="f28b6f3d-f16e-4f81-df57-8bcb10a474d1" data-execution_count="85">
<div class="sourceCode cell-code" id="cb139"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb139-1"><a href="#cb139-1"></a>X,y <span class="op">=</span> datasets.load_diabetes(return_X_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb139-2"><a href="#cb139-2"></a></span>
<span id="cb139-3"><a href="#cb139-3"></a>lgbr <span class="op">=</span> lgb.LGBMRegressor(boosting_type<span class="op">=</span><span class="st">'gbdt'</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb139-4"><a href="#cb139-4"></a></span>
<span id="cb139-5"><a href="#cb139-5"></a>scores <span class="op">=</span> cross_val_score(lgbr, X, y, scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>, cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb139-6"><a href="#cb139-6"></a></span>
<span id="cb139-7"><a href="#cb139-7"></a><span class="co"># Take square root of the scores</span></span>
<span id="cb139-8"><a href="#cb139-8"></a>rmse <span class="op">=</span> np.sqrt(<span class="op">-</span>scores)</span>
<span id="cb139-9"><a href="#cb139-9"></a></span>
<span id="cb139-10"><a href="#cb139-10"></a><span class="co"># Display accuracy</span></span>
<span id="cb139-11"><a href="#cb139-11"></a><span class="bu">print</span>(<span class="st">'RMSE:'</span>, np.<span class="bu">round</span>(rmse, <span class="dv">3</span>))</span>
<span id="cb139-12"><a href="#cb139-12"></a></span>
<span id="cb139-13"><a href="#cb139-13"></a><span class="co"># Display mean score</span></span>
<span id="cb139-14"><a href="#cb139-14"></a><span class="bu">print</span>(<span class="st">'RMSE mean: </span><span class="sc">%0.3f</span><span class="st">'</span> <span class="op">%</span> (rmse.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: [56.081 59.172 63.191 61.833 60.542]
RMSE mean: 60.164</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:306,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899753095,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="0b3cb7ff-dae5-4b95-adbd-d58fba6329b4" data-execution_count="86">
<div class="sourceCode cell-code" id="cb141"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb141-1"><a href="#cb141-1"></a>lgbr.fit(X,y)</span>
<span id="cb141-2"><a href="#cb141-2"></a>lgbr.get_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="86">
<pre><code>{'boosting_type': 'gbdt',
 'class_weight': None,
 'colsample_bytree': 1.0,
 'importance_type': 'split',
 'learning_rate': 0.1,
 'max_depth': -1,
 'min_child_samples': 20,
 'min_child_weight': 0.001,
 'min_split_gain': 0.0,
 'n_estimators': 100,
 'n_jobs': -1,
 'num_leaves': 31,
 'objective': None,
 'random_state': 42,
 'reg_alpha': 0.0,
 'reg_lambda': 0.0,
 'silent': 'warn',
 'subsample': 1.0,
 'subsample_for_bin': 200000,
 'subsample_freq': 0}</code></pre>
</div>
</div>
</section>
<section id="speed" class="level3" data-number="8.8.3">
<h3 data-number="8.8.3" class="anchored" data-anchor-id="speed"><span class="header-section-number">8.8.3</span> Speed</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5308,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899761498,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="87">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'exoplanets.csv'</span>)</span>
<span id="cb143-2"><a href="#cb143-2"></a><span class="co"># Split data into X and y</span></span>
<span id="cb143-3"><a href="#cb143-3"></a>X <span class="op">=</span> df.iloc[:,<span class="dv">1</span>:]</span>
<span id="cb143-4"><a href="#cb143-4"></a>y <span class="op">=</span> df.iloc[:,<span class="dv">0</span>]</span>
<span id="cb143-5"><a href="#cb143-5"></a></span>
<span id="cb143-6"><a href="#cb143-6"></a><span class="co"># Split data into train and test sets</span></span>
<span id="cb143-7"><a href="#cb143-7"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, random_state<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:10442,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899771939,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="b3bce67f-b3ea-497d-9702-a03450b94464" data-execution_count="88">
<div class="sourceCode cell-code" id="cb144"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb144-1"><a href="#cb144-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb144-2"><a href="#cb144-2"></a></span>
<span id="cb144-3"><a href="#cb144-3"></a><span class="co"># Instantiate the XGBRegressor, xg_reg</span></span>
<span id="cb144-4"><a href="#cb144-4"></a>lg_reg <span class="op">=</span> lgb.LGBMClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, max_depth<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>)</span>
<span id="cb144-5"><a href="#cb144-5"></a></span>
<span id="cb144-6"><a href="#cb144-6"></a><span class="co"># Fit xg_reg to training set</span></span>
<span id="cb144-7"><a href="#cb144-7"></a>lg_reg.fit(X_train, y_train)</span>
<span id="cb144-8"><a href="#cb144-8"></a></span>
<span id="cb144-9"><a href="#cb144-9"></a><span class="co"># Predict labels of test set, y_pred</span></span>
<span id="cb144-10"><a href="#cb144-10"></a>y_pred <span class="op">=</span> lg_reg.predict(X_test)</span>
<span id="cb144-11"><a href="#cb144-11"></a></span>
<span id="cb144-12"><a href="#cb144-12"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb144-13"><a href="#cb144-13"></a></span>
<span id="cb144-14"><a href="#cb144-14"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span>
<span id="cb144-15"><a href="#cb144-15"></a></span>
<span id="cb144-16"><a href="#cb144-16"></a>end <span class="op">=</span> time.time()</span>
<span id="cb144-17"><a href="#cb144-17"></a>elapsed <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb144-18"><a href="#cb144-18"></a></span>
<span id="cb144-19"><a href="#cb144-19"></a><span class="bu">print</span>(<span class="st">'Run Time: '</span> <span class="op">+</span> <span class="bu">str</span>(elapsed) <span class="op">+</span> <span class="st">' seconds'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 0.9913522012578616
Run Time: 10.266663074493408 seconds</code></pre>
</div>
</div>
</section>
<section id="hyperparameter-1" class="level3" data-number="8.8.4">
<h3 data-number="8.8.4" class="anchored" data-anchor-id="hyperparameter-1"><span class="header-section-number">8.8.4</span> Hyperparameter</h3>
<p>Following set of practices can be used to improve your model efficiency.</p>
<ul>
<li><p><strong>num_leaves</strong> : This is the main parameter to control the complexity of the tree model. Ideally, the value of <code>num_leaves</code> should be less than or equal to 2^(max_depth). Value more than this will result in overfitting.</p></li>
<li><p><strong>min_data_in_leaf</strong> : Setting it to a large value can avoid growing too deep a tree, but may cause under-fitting. In practice, setting it to hundreds or thousands is enough for a large dataset.</p></li>
<li><p><strong>max_depth</strong> : We also can use <code>max_depth</code> to limit the tree depth explicitly.</p></li>
</ul>
<ol type="1">
<li><strong>For Faster Speed</strong></li>
</ol>
<ul>
<li>Use bagging by setting <code>bagging_fraction</code> and <code>bagging_freq</code>.</li>
<li>Use feature sub-sampling by setting <code>feature_fraction</code>.</li>
<li>Use small <code>max_bin</code>.</li>
<li>Use <code>save_binary</code> to speed up data loading in future learning.</li>
</ul>
<ol start="2" type="1">
<li><strong>For better accuracy</strong></li>
</ol>
<ul>
<li>Use large <code>max_bin</code> (may be slower).</li>
<li>Use small <code>learning_rate</code> with <code>large num_iterations</code></li>
<li>Use large <code>num_leaves</code>(may cause over-fitting)</li>
<li>Try to use categorical feature directly.</li>
</ul>
<ol start="3" type="1">
<li><strong>To deal with over-fitting</strong></li>
</ol>
<ul>
<li>Use <code>min_data_in_leaf</code> and <code>min_sum_hessian_in_leaf</code></li>
<li>Try <code>lambda_l1</code>, <code>lambda_l2</code> and <code>min_gain_to_split</code> to regularization</li>
<li>Try <code>max_depth</code> to avoid growing deep tree</li>
<li>Try <code>dart</code></li>
</ul>
<p>Check <a href="https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html">https://lightgbm.readthedocs.io/en/latest/Parameters-Tuning.html</a> for hyperparamter tuning.</p>
</section>
<section id="for-categorical-variable-and-missing-value-1" class="level3" data-number="8.8.5">
<h3 data-number="8.8.5" class="anchored" data-anchor-id="for-categorical-variable-and-missing-value-1"><span class="header-section-number">8.8.5</span> For categorical variable and missing value</h3>
<p>LightGBM enables the missing value handle by default. See <a href="https://lightgbm.readthedocs.io/en/latest/Advanced-Topics.html#missing-value-handle">https://lightgbm.readthedocs.io/en/latest/Advanced-Topics.html#missing-value-handle</a>. It also deal with categorical variables as described here <a href="https://lightgbm.readthedocs.io/en/latest/Advanced-Topics.html#categorical-feature-support">https://lightgbm.readthedocs.io/en/latest/Advanced-Topics.html#categorical-feature-support</a></p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:303,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899777656,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="89">
<div class="sourceCode cell-code" id="cb146"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb146-1"><a href="#cb146-1"></a><span class="co"># Select target</span></span>
<span id="cb146-2"><a href="#cb146-2"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'melb_data.csv'</span>)</span>
<span id="cb146-3"><a href="#cb146-3"></a>y <span class="op">=</span> data.Price</span>
<span id="cb146-4"><a href="#cb146-4"></a></span>
<span id="cb146-5"><a href="#cb146-5"></a><span class="co"># To keep things simple, we'll split the columns into numerical can categorical features</span></span>
<span id="cb146-6"><a href="#cb146-6"></a>melb_predictors <span class="op">=</span> data.drop([<span class="st">'Price'</span>, <span class="st">'Date'</span>, <span class="st">'Address'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb146-7"><a href="#cb146-7"></a>cat_col <span class="op">=</span> melb_predictors.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb146-8"><a href="#cb146-8"></a></span>
<span id="cb146-9"><a href="#cb146-9"></a><span class="co"># Divide data into training and validation subsets</span></span>
<span id="cb146-10"><a href="#cb146-10"></a>X, X_v, y_train, y_valid <span class="op">=</span> train_test_split(melb_predictors, y, train_size<span class="op">=</span><span class="fl">0.8</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb146-11"><a href="#cb146-11"></a>X_train <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb146-12"><a href="#cb146-12"></a>X_valid <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb146-13"><a href="#cb146-13"></a>X_train_cat <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb146-14"><a href="#cb146-14"></a>X_valid_cat <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899780250,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="90">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1"></a><span class="cf">for</span> col <span class="kw">in</span> X_train_cat.columns:</span>
<span id="cb147-2"><a href="#cb147-2"></a>  X[col] <span class="op">=</span> X[col].astype(<span class="st">'category'</span>)</span>
<span id="cb147-3"><a href="#cb147-3"></a>  X_v[col] <span class="op">=</span> X_v[col].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:5,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899782475,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="9a4b27e4-93b1-4404-e0ea-d2e49639e0ef" data-execution_count="91">
<div class="sourceCode cell-code" id="cb148"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb148-1"><a href="#cb148-1"></a>lgbr <span class="op">=</span> lgb.LGBMRegressor(boosting_type<span class="op">=</span><span class="st">'gbdt'</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_jobs<span class="op">=-</span><span class="dv">1</span>)</span>
<span id="cb148-2"><a href="#cb148-2"></a>lgbr.fit(X, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="91">
<pre><code>LGBMRegressor(random_state=42)</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899782476,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="92">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1"></a>preds <span class="op">=</span> lgbr.predict(X_v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899782476,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="a9e09dfd-83f8-4d1d-a68e-cb8148ad5a54" data-execution_count="93">
<div class="sourceCode cell-code" id="cb151"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb151-1"><a href="#cb151-1"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="93">
<pre><code>160267.37406568974</code></pre>
</div>
</div>
</section>
</section>
<section id="catboost" class="level2" data-number="8.9">
<h2 data-number="8.9" class="anchored" data-anchor-id="catboost"><span class="header-section-number">8.9</span> CatBoost</h2>
<p>In this section, we would explore some base cases of using catboost, such as model training, cross-validation and predicting</p>
<section id="classification-task-2" class="level3" data-number="8.9.1">
<h3 data-number="8.9.1" class="anchored" data-anchor-id="classification-task-2"><span class="header-section-number">8.9.1</span> Classification task</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899786550,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="94">
<div class="sourceCode cell-code" id="cb153"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb153-1"><a href="#cb153-1"></a>iris <span class="op">=</span> datasets.load_iris()</span>
<span id="cb153-2"><a href="#cb153-2"></a>df <span class="op">=</span> pd.DataFrame(data<span class="op">=</span> np.c_[iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>]],columns<span class="op">=</span> iris[<span class="st">'feature_names'</span>] <span class="op">+</span> [<span class="st">'target'</span>])</span>
<span id="cb153-3"><a href="#cb153-3"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(iris[<span class="st">'data'</span>], iris[<span class="st">'target'</span>], random_state<span class="op">=</span><span class="dv">42</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:454,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899787741,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="c6380282-e026-4228-d7a6-71e96f88ff59" data-execution_count="95">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1"></a>clf <span class="op">=</span> CatBoostClassifier(boosting_type<span class="op">=</span><span class="st">'Plain'</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>)</span>
<span id="cb154-2"><a href="#cb154-2"></a>clf.fit(X_train, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="95">
<pre><code>&lt;catboost.core.CatBoostClassifier at 0x7f6006b63e50&gt;</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:720,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899788749,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="7f9c93a7-17e8-4ee4-9a84-43f3efded72d" data-execution_count="96">
<div class="sourceCode cell-code" id="cb156"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb156-1"><a href="#cb156-1"></a>clf.fit(X_train, y_train)</span>
<span id="cb156-2"><a href="#cb156-2"></a>y_pred <span class="op">=</span> clf.predict(X_test)</span>
<span id="cb156-3"><a href="#cb156-3"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb156-4"><a href="#cb156-4"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 1.0</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899789564,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5da034ba-7b40-4427-8fe1-88664c246a42" data-execution_count="97">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1"></a>clf.get_all_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>{'nan_mode': 'Min',
 'eval_metric': 'MultiClass',
 'iterations': 100,
 'sampling_frequency': 'PerTree',
 'leaf_estimation_method': 'Newton',
 'grow_policy': 'SymmetricTree',
 'penalties_coefficient': 1,
 'boosting_type': 'Plain',
 'model_shrink_mode': 'Constant',
 'feature_border_type': 'GreedyLogSum',
 'bayesian_matrix_reg': 0.10000000149011612,
 'eval_fraction': 0,
 'force_unit_auto_pair_weights': False,
 'l2_leaf_reg': 3,
 'random_strength': 1,
 'rsm': 1,
 'boost_from_average': False,
 'model_size_reg': 0.5,
 'pool_metainfo_options': {'tags': {}},
 'use_best_model': False,
 'class_names': [0, 1, 2],
 'random_seed': 42,
 'depth': 6,
 'posterior_sampling': False,
 'border_count': 254,
 'bagging_temperature': 1,
 'classes_count': 0,
 'auto_class_weights': 'None',
 'sparse_features_conflict_fraction': 0,
 'leaf_estimation_backtracking': 'AnyImprovement',
 'best_model_min_trees': 1,
 'model_shrink_rate': 0,
 'min_data_in_leaf': 1,
 'loss_function': 'MultiClass',
 'learning_rate': 0.10000000149011612,
 'score_function': 'Cosine',
 'task_type': 'CPU',
 'leaf_estimation_iterations': 1,
 'bootstrap_type': 'Bayesian',
 'max_leaves': 64}</code></pre>
</div>
</div>
</section>
<section id="regression" class="level3" data-number="8.9.2">
<h3 data-number="8.9.2" class="anchored" data-anchor-id="regression"><span class="header-section-number">8.9.2</span> Regression</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1638,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899792891,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="bc6d973c-c035-456e-ec9c-f8743818d84b" data-execution_count="98">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1"></a>X,y <span class="op">=</span> datasets.load_diabetes(return_X_y<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb160-2"><a href="#cb160-2"></a></span>
<span id="cb160-3"><a href="#cb160-3"></a>catb <span class="op">=</span> CatBoostRegressor(boosting_type<span class="op">=</span><span class="st">'Plain'</span>, learning_rate<span class="op">=</span><span class="fl">0.1</span>, random_state<span class="op">=</span><span class="dv">42</span>, n_estimators<span class="op">=</span><span class="dv">100</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>)</span>
<span id="cb160-4"><a href="#cb160-4"></a></span>
<span id="cb160-5"><a href="#cb160-5"></a>scores <span class="op">=</span> cross_val_score(catb, X, y, scoring<span class="op">=</span><span class="st">'neg_mean_squared_error'</span>, cv<span class="op">=</span><span class="dv">5</span>)</span>
<span id="cb160-6"><a href="#cb160-6"></a></span>
<span id="cb160-7"><a href="#cb160-7"></a><span class="co"># Take square root of the scores</span></span>
<span id="cb160-8"><a href="#cb160-8"></a>rmse <span class="op">=</span> np.sqrt(<span class="op">-</span>scores)</span>
<span id="cb160-9"><a href="#cb160-9"></a></span>
<span id="cb160-10"><a href="#cb160-10"></a><span class="co"># Display accuracy</span></span>
<span id="cb160-11"><a href="#cb160-11"></a><span class="bu">print</span>(<span class="st">'RMSE:'</span>, np.<span class="bu">round</span>(rmse, <span class="dv">3</span>))</span>
<span id="cb160-12"><a href="#cb160-12"></a></span>
<span id="cb160-13"><a href="#cb160-13"></a><span class="co"># Display mean score</span></span>
<span id="cb160-14"><a href="#cb160-14"></a><span class="bu">print</span>(<span class="st">'RMSE mean: </span><span class="sc">%0.3f</span><span class="st">'</span> <span class="op">%</span> (rmse.mean()))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>RMSE: [54.744 56.125 59.595 56.908 56.583]
RMSE mean: 56.791</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899793916,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="08d488c4-0022-48be-ad04-4d88c91a2f32" data-execution_count="99">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1"></a>catb.fit(X,y)</span>
<span id="cb162-2"><a href="#cb162-2"></a>catb.get_all_params()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>{'nan_mode': 'Min',
 'eval_metric': 'RMSE',
 'iterations': 100,
 'sampling_frequency': 'PerTree',
 'leaf_estimation_method': 'Newton',
 'grow_policy': 'SymmetricTree',
 'penalties_coefficient': 1,
 'boosting_type': 'Plain',
 'model_shrink_mode': 'Constant',
 'feature_border_type': 'GreedyLogSum',
 'bayesian_matrix_reg': 0.10000000149011612,
 'eval_fraction': 0,
 'force_unit_auto_pair_weights': False,
 'l2_leaf_reg': 3,
 'random_strength': 1,
 'rsm': 1,
 'boost_from_average': True,
 'model_size_reg': 0.5,
 'pool_metainfo_options': {'tags': {}},
 'subsample': 0.800000011920929,
 'use_best_model': False,
 'random_seed': 42,
 'depth': 6,
 'posterior_sampling': False,
 'border_count': 254,
 'classes_count': 0,
 'auto_class_weights': 'None',
 'sparse_features_conflict_fraction': 0,
 'leaf_estimation_backtracking': 'AnyImprovement',
 'best_model_min_trees': 1,
 'model_shrink_rate': 0,
 'min_data_in_leaf': 1,
 'loss_function': 'RMSE',
 'learning_rate': 0.10000000149011612,
 'score_function': 'Cosine',
 'task_type': 'CPU',
 'leaf_estimation_iterations': 1,
 'bootstrap_type': 'MVS',
 'max_leaves': 64}</code></pre>
</div>
</div>
</section>
<section id="speed-1" class="level3" data-number="8.9.3">
<h3 data-number="8.9.3" class="anchored" data-anchor-id="speed-1"><span class="header-section-number">8.9.3</span> Speed</h3>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:4635,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899800041,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="100">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1"></a>df <span class="op">=</span> pd.read_csv(<span class="st">'exoplanets.csv'</span>)</span>
<span id="cb164-2"><a href="#cb164-2"></a><span class="co"># Split data into X and y</span></span>
<span id="cb164-3"><a href="#cb164-3"></a>X <span class="op">=</span> df.iloc[:,<span class="dv">1</span>:]</span>
<span id="cb164-4"><a href="#cb164-4"></a>y <span class="op">=</span> df.iloc[:,<span class="dv">0</span>]</span>
<span id="cb164-5"><a href="#cb164-5"></a></span>
<span id="cb164-6"><a href="#cb164-6"></a><span class="co"># Split data into train and test sets</span></span>
<span id="cb164-7"><a href="#cb164-7"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, random_state<span class="op">=</span><span class="dv">2</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:16901,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899816940,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="42633981-5519-4c0e-92ba-f856d6fa29d1" data-execution_count="101">
<div class="sourceCode cell-code" id="cb165"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb165-1"><a href="#cb165-1"></a>start <span class="op">=</span> time.time()</span>
<span id="cb165-2"><a href="#cb165-2"></a></span>
<span id="cb165-3"><a href="#cb165-3"></a><span class="co"># Instantiate the XGBRegressor, xg_reg</span></span>
<span id="cb165-4"><a href="#cb165-4"></a>ca_reg <span class="op">=</span> CatBoostClassifier(n_estimators<span class="op">=</span><span class="dv">100</span>, max_depth<span class="op">=</span><span class="dv">2</span>, random_state<span class="op">=</span><span class="dv">42</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>)</span>
<span id="cb165-5"><a href="#cb165-5"></a></span>
<span id="cb165-6"><a href="#cb165-6"></a><span class="co"># Fit xg_reg to training set</span></span>
<span id="cb165-7"><a href="#cb165-7"></a>ca_reg.fit(X_train, y_train)</span>
<span id="cb165-8"><a href="#cb165-8"></a></span>
<span id="cb165-9"><a href="#cb165-9"></a><span class="co"># Predict labels of test set, y_pred</span></span>
<span id="cb165-10"><a href="#cb165-10"></a>y_pred <span class="op">=</span> ca_reg.predict(X_test)</span>
<span id="cb165-11"><a href="#cb165-11"></a></span>
<span id="cb165-12"><a href="#cb165-12"></a>score <span class="op">=</span> accuracy_score(y_pred, y_test)</span>
<span id="cb165-13"><a href="#cb165-13"></a></span>
<span id="cb165-14"><a href="#cb165-14"></a><span class="bu">print</span>(<span class="st">'Score: '</span> <span class="op">+</span> <span class="bu">str</span>(score))</span>
<span id="cb165-15"><a href="#cb165-15"></a></span>
<span id="cb165-16"><a href="#cb165-16"></a>end <span class="op">=</span> time.time()</span>
<span id="cb165-17"><a href="#cb165-17"></a>elapsed <span class="op">=</span> end <span class="op">-</span> start</span>
<span id="cb165-18"><a href="#cb165-18"></a></span>
<span id="cb165-19"><a href="#cb165-19"></a><span class="bu">print</span>(<span class="st">'Run Time: '</span> <span class="op">+</span> <span class="bu">str</span>(elapsed) <span class="op">+</span> <span class="st">' seconds'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Score: 0.9913522012578616
Run Time: 16.69258213043213 seconds</code></pre>
</div>
</div>
</section>
<section id="hyperparameter-2" class="level3" data-number="8.9.4">
<h3 data-number="8.9.4" class="anchored" data-anchor-id="hyperparameter-2"><span class="header-section-number">8.9.4</span> Hyperparameter</h3>
<p>You can check more details at <a href="https://catboost.ai/en/docs/references/training-parameters/">https://catboost.ai/en/docs/references/training-parameters/</a>. There are also tutorials about hyperparameter tuning <a href="https://github.com/catboost/tutorials/blob/master/hyperparameters_tuning/hyperparameters_tuning_using_optuna_and_hyperopt.ipynb">https://github.com/catboost/tutorials/blob/master/hyperparameters_tuning/hyperparameters_tuning_using_optuna_and_hyperopt.ipynb</a></p>
</section>
<section id="for-categorical-variable-and-missing-value-2" class="level3" data-number="8.9.5">
<h3 data-number="8.9.5" class="anchored" data-anchor-id="for-categorical-variable-and-missing-value-2"><span class="header-section-number">8.9.5</span> For categorical variable and missing value</h3>
<p>One of the differences between CatBoost and other gradient boosting libraries is its advanced processing of the categorical features (in fact “Cat” in the package name stands for “CATegorical”).</p>
<p>CatBoost deals with the categorical data quite well out-of-the-box. However, it also has a huge number of training parameters, which provide fine control over the categorical features preprocessing.</p>
<p>The amount of parameters related to categorical features processing in CatBoost is overwhelming. Here is a hopefully the full list:</p>
<ul>
<li><p><code>one_hot_max_size</code> (int) - use one-hot encoding for all categorical features with a number of different values less than or equal to the given parameter value. No complex encoding is performed for such features.</p></li>
<li><p><code>model_size_reg</code> (float from 0 to inf) - The model size regularization coefficient. The larger the value, the smaller the model size. This regularization is needed only for models with categorical features (other models are small). Models with categorical features might weight tens of gigabytes or more if categorical features have a lot of values. If the value of the regularizer differs from zero, then the usage of categorical features or feature combinations with a lot of values has a penalty, so fewer of them are used in the resulting model. Default value is 0.5</p></li>
<li><p><code>max_ctr_complexity</code> - The maximum number of features that can be combined. Each resulting combination consists of one or more categorical features and can optionally contain binary features in the following form: “numeric feature &gt; value”. For regression task on CPU the default value is 4.</p></li>
<li><p><code>has_time (bool)</code> - if true, the 1-st step of categorical features processing, permutation, is not performed. Useful when the objects in your dataset are ordered by time. For our dataset, we don’t need it. Default value is False</p></li>
<li><p><code>simple_ctr</code> - Quantization settings for simple categorical features. combinations_ctr - Quantization settings for combinations of categorical features.</p></li>
<li><p><code>per_feature_ctr</code> - Per-feature quantization settings for categorical features.</p></li>
<li><p><code>counter_calc_method</code> determines whether to use validation dataset (provided through parameter eval_set of fit method) to estimate categories frequencies with Counter. By default, it is Full and the objects from validation dataset are used; Pass SkipTest value to ignore the objects from the validation set ctr_target_border_count - The maximum number of borders to use in target quantization for categorical features that need it. Default for regression task is 1.</p></li>
<li><p><code>ctr_leaf_count_limit</code> - The maximum number of leaves with categorical features. Default value is None i.e.&nbsp;no limit.</p></li>
<li><p><code>store_all_simple_ctr</code>- If the previous parameter ctr_leaf_count_limit at some point gradient boosting tree can no longer make splits by categorical features. With Default value False the limitation applies both to original categorical features and the features, that CatBoost creates by combining different features. If this parameter is set to True only the number of splits made on combination features is limited.</p></li>
</ul>
<p>The three parameters <code>simple_ctr</code>, <code>combinations_ctr</code>, and <code>per_feature_ctr</code> are complex parameters that control the second and the third steps of categorical features processing.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899822587,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="102">
<div class="sourceCode cell-code" id="cb167"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb167-1"><a href="#cb167-1"></a><span class="co"># Select target</span></span>
<span id="cb167-2"><a href="#cb167-2"></a>data <span class="op">=</span> pd.read_csv(<span class="st">'melb_data.csv'</span>)</span>
<span id="cb167-3"><a href="#cb167-3"></a>y <span class="op">=</span> data.Price</span>
<span id="cb167-4"><a href="#cb167-4"></a></span>
<span id="cb167-5"><a href="#cb167-5"></a><span class="co"># To keep things simple, we'll split the columns into numerical can categorical features</span></span>
<span id="cb167-6"><a href="#cb167-6"></a>melb_predictors <span class="op">=</span> data.drop([<span class="st">'Price'</span>, <span class="st">'Date'</span>, <span class="st">'Address'</span>], axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb167-7"><a href="#cb167-7"></a>cat_col <span class="op">=</span> melb_predictors.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb167-8"><a href="#cb167-8"></a></span>
<span id="cb167-9"><a href="#cb167-9"></a><span class="co"># Divide data into training and validation subsets</span></span>
<span id="cb167-10"><a href="#cb167-10"></a>X, X_v, y_train, y_valid <span class="op">=</span> train_test_split(melb_predictors, y, train_size<span class="op">=</span><span class="fl">0.8</span>, test_size<span class="op">=</span><span class="fl">0.2</span>, random_state<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb167-11"><a href="#cb167-11"></a>X_train <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb167-12"><a href="#cb167-12"></a>X_valid <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'object'</span>])</span>
<span id="cb167-13"><a href="#cb167-13"></a>X_train_cat <span class="op">=</span> X.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span>
<span id="cb167-14"><a href="#cb167-14"></a>X_valid_cat <span class="op">=</span> X_v.select_dtypes(exclude<span class="op">=</span>[<span class="st">'int64'</span>,<span class="st">'float64'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899822587,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="103">
<div class="sourceCode cell-code" id="cb168"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb168-1"><a href="#cb168-1"></a>categorical_features_names <span class="op">=</span> <span class="bu">list</span>(X_train_cat.columns)</span>
<span id="cb168-2"><a href="#cb168-2"></a></span>
<span id="cb168-3"><a href="#cb168-3"></a><span class="cf">for</span> col <span class="kw">in</span> categorical_features_names:</span>
<span id="cb168-4"><a href="#cb168-4"></a>  X[col] <span class="op">=</span> X.loc[:,col].fillna(value<span class="op">=</span><span class="st">'nan'</span>)</span>
<span id="cb168-5"><a href="#cb168-5"></a>  X_v[col] <span class="op">=</span> X_v.loc[:,col].fillna(value<span class="op">=</span><span class="st">'nan'</span>)</span>
<span id="cb168-6"><a href="#cb168-6"></a>  X[col] <span class="op">=</span> X[col].astype(<span class="st">'category'</span>)</span>
<span id="cb168-7"><a href="#cb168-7"></a>  X_v[col] <span class="op">=</span> X_v[col].astype(<span class="st">'category'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1085,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899823952,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="146dcf16-60f7-4efc-aa41-5ab7f91287db" data-execution_count="104">
<div class="sourceCode cell-code" id="cb169"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb169-1"><a href="#cb169-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names)</span>
<span id="cb169-2"><a href="#cb169-2"></a>catbr.fit(X, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>&lt;catboost.core.CatBoostRegressor at 0x7f6006532dd0&gt;</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899823952,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-execution_count="105">
<div class="sourceCode cell-code" id="cb171"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb171-1"><a href="#cb171-1"></a>preds <span class="op">=</span> catbr.predict(X_v)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899823953,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="c3243c92-4445-4f93-cced-e75d4adbbff9" data-execution_count="106">
<div class="sourceCode cell-code" id="cb172"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb172-1"><a href="#cb172-1"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="106">
<pre><code>164721.46472522244</code></pre>
</div>
</div>
<p>The first thing we try is to make CatBoost use one-hot encoding for all our categorical features. The documentation says, that for the features for which one-hot encoding is used no other encodings are computed.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1095,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899827597,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="22cb23c4-9fc9-4ef3-b579-fb09d8364f9d" data-execution_count="107">
<div class="sourceCode cell-code" id="cb174"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb174-1"><a href="#cb174-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, one_hot_max_size<span class="op">=</span><span class="dv">500</span>)</span>
<span id="cb174-2"><a href="#cb174-2"></a>catbr.fit(X, y_train)</span>
<span id="cb174-3"><a href="#cb174-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb174-4"><a href="#cb174-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="107">
<pre><code>163165.1377008556</code></pre>
</div>
</div>
<p>Let us try to set model size regularization coefficient to 0 - thus we allow our model to use as many categorical features and its combinations as it wants.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1531,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899832754,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="3a64b88f-49d1-4a06-9ce1-0e465a768bc8" data-execution_count="108">
<div class="sourceCode cell-code" id="cb176"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb176-1"><a href="#cb176-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, model_size_reg<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb176-2"><a href="#cb176-2"></a>catbr.fit(X, y_train)</span>
<span id="cb176-3"><a href="#cb176-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb176-4"><a href="#cb176-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="108">
<pre><code>165007.46639148306</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1472,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899835661,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="6631c43f-835b-4030-f7db-528fe84aa8d6" data-execution_count="109">
<div class="sourceCode cell-code" id="cb178"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb178-1"><a href="#cb178-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, model_size_reg<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb178-2"><a href="#cb178-2"></a>catbr.fit(X, y_train)</span>
<span id="cb178-3"><a href="#cb178-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb178-4"><a href="#cb178-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="109">
<pre><code>160827.54657606702</code></pre>
</div>
</div>
<p>Note that any combination of several categorical features could be considered as a new one. Although it is not mentioned in the documentation, this parameter value has to be smaller than 15.</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:2165,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899841606,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="3bedc6e5-a0cf-4e1f-96ca-41a412a76635" data-execution_count="110">
<div class="sourceCode cell-code" id="cb180"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb180-1"><a href="#cb180-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, max_ctr_complexity<span class="op">=</span><span class="dv">6</span>)</span>
<span id="cb180-2"><a href="#cb180-2"></a>catbr.fit(X, y_train)</span>
<span id="cb180-3"><a href="#cb180-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb180-4"><a href="#cb180-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="110">
<pre><code>163529.3517553931</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1011,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899842615,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="91ab9c1d-5bf3-4348-8da7-ae31ff88cc9c" data-execution_count="111">
<div class="sourceCode cell-code" id="cb182"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb182-1"><a href="#cb182-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, max_ctr_complexity<span class="op">=</span><span class="dv">0</span>)</span>
<span id="cb182-2"><a href="#cb182-2"></a>catbr.fit(X, y_train)</span>
<span id="cb182-3"><a href="#cb182-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb182-4"><a href="#cb182-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="111">
<pre><code>164721.46472522244</code></pre>
</div>
</div>
<p>Counter method is very similar to the traditional Frequency Encoding</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:801,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899845404,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="1933c85c-a021-45ee-cf31-5aa75f4a642a" data-execution_count="112">
<div class="sourceCode cell-code" id="cb184"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb184-1"><a href="#cb184-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, simple_ctr<span class="op">=</span><span class="st">'Counter'</span>, combinations_ctr<span class="op">=</span><span class="st">'Counter'</span>)</span>
<span id="cb184-2"><a href="#cb184-2"></a>catbr.fit(X, y_train)</span>
<span id="cb184-3"><a href="#cb184-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb184-4"><a href="#cb184-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="112">
<pre><code>164993.47954656056</code></pre>
</div>
</div>
<p>Now we proceed to the settings of the encodings methods that require target quantization. The first choice is <code>Borders</code> vs.&nbsp;Buckets</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:746,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899848402,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="4376a97f-4643-40f6-fc4e-4b9e2a063017" data-execution_count="113">
<div class="sourceCode cell-code" id="cb186"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb186-1"><a href="#cb186-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, simple_ctr<span class="op">=</span><span class="st">'Borders'</span>, combinations_ctr<span class="op">=</span><span class="st">'Borders'</span>)</span>
<span id="cb186-2"><a href="#cb186-2"></a>catbr.fit(X, y_train)</span>
<span id="cb186-3"><a href="#cb186-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb186-4"><a href="#cb186-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="113">
<pre><code>166920.94141120723</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1179,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899850066,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="b8c2085a-c1a3-4051-9b55-1e547438cd38" data-execution_count="114">
<div class="sourceCode cell-code" id="cb188"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb188-1"><a href="#cb188-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, simple_ctr<span class="op">=</span><span class="st">'Buckets'</span>, combinations_ctr<span class="op">=</span><span class="st">'Buckets'</span>)</span>
<span id="cb188-2"><a href="#cb188-2"></a>catbr.fit(X, y_train)</span>
<span id="cb188-3"><a href="#cb188-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb188-4"><a href="#cb188-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="114">
<pre><code>168168.9386958123</code></pre>
</div>
</div>
<p>It is quite common to use several encodings for a categorical feature. For instance, CatBoost creates 4 different encodings for each categorical feature by default. By default, CatBoost uses several encoding techniques to encode each categorical feature.</p>
<ul>
<li><p>First it uses <code>Borders</code> method with one target border <code>TargetBorderCount=1</code> (in our example for each categorical feature we just want to see if it makes the car more expensive). The obtained float encodings are further discretized into <code>CtrBorderCount=15</code> different values. Three values of Prior parameter are used to create 3 three different encodings: <code>Prior=0/1:Prior=0.5/1:Prior=1/1</code></p></li>
<li><p>Also for each categorical feature, we create an encoding with Counter method. The number of categorical encoding value borders <code>CtrBorderCount</code> is also equal to 15, and only one value of <code>Prior=0/1</code> is used.</p></li>
</ul>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:3530,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899857158,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="17fba47a-f414-4ead-e9fa-2281f0d1e641" data-execution_count="115">
<div class="sourceCode cell-code" id="cb190"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb190-1"><a href="#cb190-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names, ctr_target_border_count<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb190-2"><a href="#cb190-2"></a>catbr.fit(X, y_train)</span>
<span id="cb190-3"><a href="#cb190-3"></a>preds <span class="op">=</span> catbr.predict(X_v)</span>
<span id="cb190-4"><a href="#cb190-4"></a>mean_absolute_error(y_valid, preds)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="115">
<pre><code>166281.68070428775</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:866,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899858022,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="5393a0cd-ecb1-4597-975d-29dc015e67c9" data-execution_count="116">
<div class="sourceCode cell-code" id="cb192"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb192-1"><a href="#cb192-1"></a>catbr <span class="op">=</span> CatBoostRegressor(n_estimators<span class="op">=</span><span class="dv">100</span>, random_state<span class="op">=</span><span class="dv">42</span>, thread_count<span class="op">=-</span><span class="dv">1</span>, logging_level <span class="op">=</span> <span class="st">'Silent'</span>, cat_features<span class="op">=</span>categorical_features_names)</span>
<span id="cb192-2"><a href="#cb192-2"></a>catbr.fit(X, y_train)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="116">
<pre><code>&lt;catboost.core.CatBoostRegressor at 0x7f6007ab7a10&gt;</code></pre>
</div>
</div>
</section>
</section>
<section id="voting-and-stacking" class="level2" data-number="8.10">
<h2 data-number="8.10" class="anchored" data-anchor-id="voting-and-stacking"><span class="header-section-number">8.10</span> Voting and Stacking</h2>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:517,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899860314,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="3d6155ea-e241-414c-dc1f-29ad93d92c58" data-execution_count="117">
<div class="sourceCode cell-code" id="cb194"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb194-1"><a href="#cb194-1"></a>Carseats <span class="op">=</span> pd.read_csv(<span class="st">'/content/drive/MyDrive/Lab/Data/Carseats.csv'</span>)</span>
<span id="cb194-2"><a href="#cb194-2"></a></span>
<span id="cb194-3"><a href="#cb194-3"></a><span class="bu">print</span>(Carseats.shape)</span>
<span id="cb194-4"><a href="#cb194-4"></a><span class="co"># Check for missing values</span></span>
<span id="cb194-5"><a href="#cb194-5"></a><span class="cf">assert</span> Carseats.isnull().<span class="bu">sum</span>().<span class="bu">sum</span>() <span class="op">==</span> <span class="dv">0</span></span>
<span id="cb194-6"><a href="#cb194-6"></a></span>
<span id="cb194-7"><a href="#cb194-7"></a><span class="co"># Create binary variable High 1 if Sales &gt; 8</span></span>
<span id="cb194-8"><a href="#cb194-8"></a>Carseats[<span class="st">'High'</span>] <span class="op">=</span> (Carseats[<span class="st">'Sales'</span>] <span class="op">&gt;</span> <span class="dv">8</span>).astype(np.float64)</span>
<span id="cb194-9"><a href="#cb194-9"></a></span>
<span id="cb194-10"><a href="#cb194-10"></a>predictors <span class="op">=</span> Carseats.drop([<span class="st">"Sales"</span>,<span class="st">"High"</span>], axis<span class="op">=</span><span class="dv">1</span>).columns</span>
<span id="cb194-11"><a href="#cb194-11"></a>X <span class="op">=</span> pd.get_dummies(Carseats[predictors], drop_first<span class="op">=</span><span class="va">True</span>) <span class="co">#sklearn does not have built-in support for categorical variable </span></span>
<span id="cb194-12"><a href="#cb194-12"></a>y <span class="op">=</span> Carseats[<span class="st">"High"</span>]</span>
<span id="cb194-13"><a href="#cb194-13"></a></span>
<span id="cb194-14"><a href="#cb194-14"></a>X_train, X_test, y_train, y_test <span class="op">=</span> train_test_split(X, y, train_size<span class="op">=</span><span class="fl">0.5</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>(400, 11)</code></pre>
</div>
</div>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:469,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899862289,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="a6c090d8-c482-4fae-b713-194c6c5d48ad" data-execution_count="118">
<div class="sourceCode cell-code" id="cb196"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb196-1"><a href="#cb196-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> LogisticRegression</span>
<span id="cb196-2"><a href="#cb196-2"></a><span class="im">from</span> sklearn.neighbors <span class="im">import</span> KNeighborsClassifier</span>
<span id="cb196-3"><a href="#cb196-3"></a><span class="im">from</span> sklearn.naive_bayes <span class="im">import</span> GaussianNB </span>
<span id="cb196-4"><a href="#cb196-4"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb196-5"><a href="#cb196-5"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> make_pipeline</span>
<span id="cb196-6"><a href="#cb196-6"></a></span>
<span id="cb196-7"><a href="#cb196-7"></a>clf1 <span class="op">=</span> make_pipeline(StandardScaler(),KNeighborsClassifier(n_neighbors<span class="op">=</span><span class="dv">10</span>))</span>
<span id="cb196-8"><a href="#cb196-8"></a>clf2 <span class="op">=</span> DecisionTreeClassifier(random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb196-9"><a href="#cb196-9"></a>clf3 <span class="op">=</span> GaussianNB()</span>
<span id="cb196-10"><a href="#cb196-10"></a></span>
<span id="cb196-11"><a href="#cb196-11"></a>estimators <span class="op">=</span> [</span>
<span id="cb196-12"><a href="#cb196-12"></a>    (<span class="st">"knn"</span>, clf1),   </span>
<span id="cb196-13"><a href="#cb196-13"></a>    (<span class="st">"dc"</span>, clf2),</span>
<span id="cb196-14"><a href="#cb196-14"></a>    (<span class="st">"nb"</span>, clf3)</span>
<span id="cb196-15"><a href="#cb196-15"></a>]</span>
<span id="cb196-16"><a href="#cb196-16"></a></span>
<span id="cb196-17"><a href="#cb196-17"></a>vclf <span class="op">=</span> VotingClassifier(estimators<span class="op">=</span>estimators, voting<span class="op">=</span><span class="st">'hard'</span>)</span>
<span id="cb196-18"><a href="#cb196-18"></a></span>
<span id="cb196-19"><a href="#cb196-19"></a>k <span class="op">=</span> <span class="dv">5</span></span>
<span id="cb196-20"><a href="#cb196-20"></a>kf5 <span class="op">=</span> KFold(n_splits<span class="op">=</span>k, shuffle<span class="op">=</span><span class="va">True</span>, random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb196-21"><a href="#cb196-21"></a></span>
<span id="cb196-22"><a href="#cb196-22"></a><span class="bu">print</span>(<span class="st">'5-fold cross validation:</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb196-23"><a href="#cb196-23"></a></span>
<span id="cb196-24"><a href="#cb196-24"></a></span>
<span id="cb196-25"><a href="#cb196-25"></a><span class="cf">for</span> clf, label <span class="kw">in</span> <span class="bu">zip</span>([clf1, clf2, clf3, vclf], </span>
<span id="cb196-26"><a href="#cb196-26"></a>                      [<span class="st">'KNN'</span>, </span>
<span id="cb196-27"><a href="#cb196-27"></a>                       <span class="st">'DecisionTreeClassifier'</span>, </span>
<span id="cb196-28"><a href="#cb196-28"></a>                       <span class="st">'Naive Bayes'</span>,</span>
<span id="cb196-29"><a href="#cb196-29"></a>                       <span class="st">'StackingClassifier'</span>]):</span>
<span id="cb196-30"><a href="#cb196-30"></a></span>
<span id="cb196-31"><a href="#cb196-31"></a>    scores <span class="op">=</span> cross_val_score(clf, X_train, y_train, cv<span class="op">=</span>kf5, scoring<span class="op">=</span><span class="st">'accuracy'</span>)</span>
<span id="cb196-32"><a href="#cb196-32"></a>    <span class="bu">print</span>(<span class="st">"Accuracy: </span><span class="sc">%0.2f</span><span class="st"> (+/- </span><span class="sc">%0.2f</span><span class="st">) [</span><span class="sc">%s</span><span class="st">]"</span> </span>
<span id="cb196-33"><a href="#cb196-33"></a>          <span class="op">%</span> (scores.mean(), scores.std(), label))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5-fold cross validation:

Accuracy: 0.78 (+/- 0.06) [KNN]
Accuracy: 0.73 (+/- 0.07) [DecisionTreeClassifier]
Accuracy: 0.79 (+/- 0.07) [Naive Bayes]
Accuracy: 0.82 (+/- 0.04) [StackingClassifier]</code></pre>
</div>
</div>
<p>Check <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.VotingClassifier.html">https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.VotingClassifier.html</a> for more details</p>
<div class="cell" data-executioninfo="{&quot;elapsed&quot;:1666,&quot;status&quot;:&quot;ok&quot;,&quot;timestamp&quot;:1667899869138,&quot;user&quot;:{&quot;displayName&quot;:&quot;phonchi chung&quot;,&quot;userId&quot;:&quot;13517391734500420886&quot;},&quot;user_tz&quot;:-480}" data-outputid="c6899a83-eca9-4703-e598-c1e25b40e0a8" data-execution_count="119">
<div class="sourceCode cell-code" id="cb198"><pre class="sourceCode numberSource python number-lines code-with-copy"><code class="sourceCode python"><span id="cb198-1"><a href="#cb198-1"></a>sclf <span class="op">=</span> StackingClassifier(estimators<span class="op">=</span>estimators, final_estimator<span class="op">=</span>LogisticRegression())</span>
<span id="cb198-2"><a href="#cb198-2"></a></span>
<span id="cb198-3"><a href="#cb198-3"></a><span class="bu">print</span>(<span class="st">'5-fold cross validation:</span><span class="ch">\n</span><span class="st">'</span>)</span>
<span id="cb198-4"><a href="#cb198-4"></a></span>
<span id="cb198-5"><a href="#cb198-5"></a><span class="cf">for</span> clf, label <span class="kw">in</span> <span class="bu">zip</span>([clf1, clf2, clf3, sclf], </span>
<span id="cb198-6"><a href="#cb198-6"></a>                      [<span class="st">'KNN'</span>, </span>
<span id="cb198-7"><a href="#cb198-7"></a>                       <span class="st">'DecisionTreeClassifier'</span>, </span>
<span id="cb198-8"><a href="#cb198-8"></a>                       <span class="st">'Naive Bayes'</span>,</span>
<span id="cb198-9"><a href="#cb198-9"></a>                       <span class="st">'StackingClassifier'</span>]):</span>
<span id="cb198-10"><a href="#cb198-10"></a></span>
<span id="cb198-11"><a href="#cb198-11"></a>    scores <span class="op">=</span> cross_val_score(clf, X_train, y_train, cv<span class="op">=</span>kf5, scoring<span class="op">=</span><span class="st">'accuracy'</span>)</span>
<span id="cb198-12"><a href="#cb198-12"></a>    <span class="bu">print</span>(<span class="st">"Accuracy: </span><span class="sc">%0.2f</span><span class="st"> (+/- </span><span class="sc">%0.2f</span><span class="st">) [</span><span class="sc">%s</span><span class="st">]"</span> </span>
<span id="cb198-13"><a href="#cb198-13"></a>          <span class="op">%</span> (scores.mean(), scores.std(), label))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>5-fold cross validation:

Accuracy: 0.78 (+/- 0.06) [KNN]
Accuracy: 0.73 (+/- 0.07) [DecisionTreeClassifier]
Accuracy: 0.79 (+/- 0.07) [Naive Bayes]
Accuracy: 0.81 (+/- 0.05) [StackingClassifier]</code></pre>
</div>
</div>
<p>Check <a href="https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.StackingClassifier.html">https://scikit-learn.org/stable/modules/generated/sklearn.ensemble.StackingClassifier.html</a> or <a href="http://rasbt.github.io/mlxtend/user_guide/classifier/StackingCVClassifier/#stackingcvclassifier">http://rasbt.github.io/mlxtend/user_guide/classifier/StackingCVClassifier/#stackingcvclassifier</a> for more details.</p>


</section>

</main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
  function tippyHover(el, contentFn) {
    const config = {
      allowHTML: true,
      content: contentFn,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start'
    };
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      return note.innerHTML;
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<nav class="page-navigation">
  <div class="nav-page nav-page-previous">
      <a href="./Chapter_7_Lab.html" class="pagination-link">
        <i class="bi bi-arrow-left-short"></i> <span class="nav-page-text"><span class="chapter-number">7</span>&nbsp; <span class="chapter-title">Non-linear Modeling</span></span>
      </a>          
  </div>
  <div class="nav-page nav-page-next">
      <a href="./Chapter_9_Lab.html" class="pagination-link">
        <span class="nav-page-text"><span class="chapter-number">9</span>&nbsp; <span class="chapter-title">Support Vector Machines</span></span> <i class="bi bi-arrow-right-short"></i>
      </a>
  </div>
</nav>
</div> <!-- /content -->



</body></html>